<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>CrewFinder ‚Äî Equipment Marketplace</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif;
    background: #E8E8E8;
    display: flex; justify-content: center; align-items: flex-start;
    min-height: 100vh; padding: 0;
  }
  #app {
    width: 100%; max-width: 430px; min-height: 100vh;
    background: #F7FAF7; position: relative; overflow: hidden;
    display: flex; flex-direction: column;
  }
  @media (min-width: 431px) {
    body { padding: 20px; align-items: center; }
    #app { min-height: 85vh; max-height: 90vh; border-radius: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.15); overflow: hidden; }
  }

  /* Header */
  .header {
    background: #fff; padding: 12px 16px; border-bottom: 1px solid #E8E8E8;
    display: flex; justify-content: space-between; align-items: center;
    position: sticky; top: 0; z-index: 100;
  }
  .header-logo { display: flex; align-items: center; gap: 8px; }
  .header-logo svg { width: 28px; height: 28px; }
  .header-logo span { font-weight: 800; font-size: 18px; color: #1A3C2A; letter-spacing: -0.3px; }
  .header-back { background: none; border: 1px solid #DDD; border-radius: 8px; padding: 5px 12px; font-size: 11px; color: #888; cursor: pointer; font-family: inherit; }

  /* Content */
  .content { flex: 1; overflow-y: auto; padding: 16px; -webkit-overflow-scrolling: touch; }

  /* Filter Bar */
  .filters { display: flex; gap: 6px; overflow-x: auto; padding-bottom: 12px; -webkit-overflow-scrolling: touch; }
  .filters::-webkit-scrollbar { display: none; }
  .filter-pill {
    padding: 7px 14px; border-radius: 20px; border: none;
    background: #E8EDE9; color: #5A6B5E; font-size: 12px; font-weight: 600;
    cursor: pointer; font-family: inherit; white-space: nowrap; transition: all 0.15s;
  }
  .filter-pill.active { background: #2D7A3A; color: #fff; }

  /* Section Header */
  .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
  .section-title { font-size: 16px; font-weight: 700; color: #1A3C2A; }
  .section-count { display: inline-flex; padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; color: #2D7A3A; background: rgba(45,122,58,0.1); }
  .btn-sell { background: #2D7A3A; color: #fff; border: none; border-radius: 8px; padding: 7px 14px; font-size: 12px; font-weight: 600; cursor: pointer; font-family: inherit; }

  /* Listing Card */
  .listing-card {
    background: #fff; border-radius: 14px; border: 1px solid #E2E8E4;
    padding: 14px 16px; margin-bottom: 10px; cursor: pointer;
    transition: all 0.15s; box-shadow: 0 1px 3px rgba(0,0,0,0.04);
  }
  .listing-card:active { transform: scale(0.98); }
  .listing-row { display: flex; gap: 12px; }
  .listing-thumb {
    width: 72px; height: 72px; border-radius: 12px; background: #E8EDE9;
    display: flex; align-items: center; justify-content: center; font-size: 32px; flex-shrink: 0;
  }
  .listing-info { flex: 1; min-width: 0; }
  .listing-badges { display: flex; gap: 6px; margin-bottom: 4px; flex-wrap: wrap; }
  .badge {
    display: inline-flex; padding: 2px 8px; border-radius: 12px;
    font-size: 11px; font-weight: 600; letter-spacing: 0.2px;
  }
  .badge-new { color: #1B5E20; background: #E8F5E9; }
  .badge-like-new { color: #2E7D32; background: #E8F5E9; }
  .badge-good { color: #558B2F; background: #F1F8E9; }
  .badge-fair { color: #F57F17; background: #FFF8E1; }
  .badge-parts { color: #BF360C; background: #FBE9E7; }
  .listing-title { font-weight: 700; font-size: 14px; color: #1A3C2A; margin-bottom: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .listing-price { font-size: 18px; font-weight: 800; color: #2D7A3A; }
  .listing-price .obo { font-size: 11px; font-weight: 500; color: #8A9B8E; }
  .listing-meta { display: flex; gap: 10px; margin-top: 4px; }
  .listing-meta span { display: flex; align-items: center; gap: 3px; font-size: 11px; color: #8A9B8E; }
  .listing-chevron { display: flex; align-items: center; color: #8A9B8E; }

  /* Detail View */
  .detail-back { background: none; border: none; color: #2D7A3A; font-weight: 600; font-size: 14px; cursor: pointer; font-family: inherit; padding: 0; margin-bottom: 12px; }
  .detail-image { background: #E8EDE9; border-radius: 16px; height: 200px; display: flex; align-items: center; justify-content: center; font-size: 64px; margin-bottom: 16px; }
  .detail-title { font-size: 20px; font-weight: 800; color: #1A3C2A; margin: 8px 0 4px; }
  .detail-price { font-size: 24px; font-weight: 800; color: #2D7A3A; margin-bottom: 12px; }
  .detail-price .obo { font-size: 14px; font-weight: 500; color: #8A9B8E; }
  .detail-desc { font-size: 14px; line-height: 1.6; color: #5A6B5E; margin-bottom: 16px; }
  .seller-card {
    background: #fff; border-radius: 14px; border: 1px solid #E2E8E4;
    padding: 14px 16px; margin-bottom: 16px;
  }
  .seller-row { display: flex; align-items: center; gap: 10px; }
  .seller-avatar {
    width: 40px; height: 40px; border-radius: 10px; display: flex;
    align-items: center; justify-content: center; font-size: 18px;
  }
  .seller-name { font-weight: 700; font-size: 14px; color: #1A3C2A; }
  .seller-location { display: flex; align-items: center; gap: 4px; font-size: 12px; color: #8A9B8E; }
  .detail-actions { display: flex; gap: 10px; }
  .btn-primary {
    flex: 1; padding: 14px; border-radius: 12px; background: #2D7A3A; color: #fff;
    border: none; font-weight: 700; font-size: 14px; cursor: pointer; font-family: inherit;
  }
  .btn-secondary {
    flex: 1; padding: 14px; border-radius: 12px; background: #fff; color: #2D7A3A;
    border: 2px solid #2D7A3A; font-weight: 700; font-size: 14px; cursor: pointer; font-family: inherit;
  }

  /* Post Form */
  .form-group { margin-bottom: 14px; }
  .form-label { display: block; font-size: 13px; font-weight: 600; color: #1A3C2A; margin-bottom: 6px; }
  .form-input {
    width: 100%; padding: 12px 14px; border-radius: 10px; border: 1px solid #E2E8E4;
    font-size: 14px; font-family: inherit; background: #fff; color: #1A3C2A;
    outline: none; transition: border 0.15s;
  }
  .form-input:focus { border-color: #2D7A3A; }
  .form-select { width: 100%; padding: 12px 14px; border-radius: 10px; border: 1px solid #E2E8E4; font-size: 14px; font-family: inherit; background: #fff; color: #1A3C2A; }
  .form-textarea { resize: vertical; min-height: 80px; }
  .form-row { display: flex; gap: 10px; }
  .form-row .form-group { flex: 1; }

  /* Empty State */
  .empty { text-align: center; padding: 48px 16px; color: #8A9B8E; }
  .empty-icon { font-size: 48px; margin-bottom: 12px; }
  .empty-title { font-weight: 700; font-size: 16px; color: #5A6B5E; }
  .empty-desc { font-size: 13px; margin-top: 4px; }

  /* Loading */
  .loading { text-align: center; padding: 32px; color: #8A9B8E; }
  .spinner { display: inline-block; width: 24px; height: 24px; border: 3px solid #E2E8E4; border-top-color: #2D7A3A; border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* Bottom Nav */
  .bottom-nav {
    background: #fff; border-top: 1px solid #E8E8E8;
    display: flex; padding: 6px 8px 10px;
  }
  .nav-item {
    flex: 1; display: flex; flex-direction: column; align-items: center; gap: 2px;
    background: none; border: none; cursor: pointer; color: #8A9B8E;
    font-family: inherit; padding: 6px 0; transition: all 0.15s; text-decoration: none;
  }
  .nav-item.active { color: #2D7A3A; }
  .nav-item span { font-size: 10px; font-weight: 500; }
  .nav-item.active span { font-weight: 700; }
  .nav-dot { width: 4px; height: 4px; border-radius: 50%; background: #2D7A3A; }
</style>
</head>
<body>
<div id="app">
  <!-- Header -->
  <div class="header">
    <div class="header-logo">
      <svg viewBox="0 0 100 100" fill="none"><path d="M50 8 L30 40 L38 40 L22 65 L32 65 L18 90 L82 90 L68 65 L78 65 L62 40 L70 40 Z" fill="#2D7A3A" opacity="0.9"/><rect x="44" y="85" width="12" height="15" rx="2" fill="#5D4037"/></svg>
      <span>CrewFinder</span>
    </div>
    <button class="header-back" onclick="window.location.href='app.html'">‚Üê App</button>
  </div>

  <!-- Content -->
  <div class="content" id="content">
    <div class="loading"><div class="spinner"></div><div style="margin-top:8px">Loading equipment...</div></div>
  </div>

  <!-- Bottom Nav -->
  <div class="bottom-nav">
    <a href="app.html" class="nav-item">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>
      <span>Jobs</span>
    </a>
    <a href="calendar.html" class="nav-item">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
      <span>Calendar</span>
    </a>
    <a href="equipment.html" class="nav-item active">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
      <span>Gear</span>
      <div class="nav-dot"></div>
    </a>
    <a href="storm.html" class="nav-item">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 16.9A5 5 0 0 0 18 7h-1.26a8 8 0 1 0-11.62 9"/><polyline points="13 11 9 17 15 17 11 23"/></svg>
      <span>Storm</span>
    </a>
    <a href="news.html" class="nav-item">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2Zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2"/><path d="M18 14h-8"/><path d="M15 18h-5"/><path d="M10 6h8v4h-8V6Z"/></svg>
      <span>News</span>
    </a>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://mhatwlmbwikvrlcgfojt.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1oYXR3bG1id2lrdnJsY2dmb2p0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzgxMDQ4ODYsImV4cCI6MjA1MzY4MDg4Nn0.CHiaEB4vg1qCCpnOb4cOYGP6O_-TE_0Iu21VDnORfCE';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const content = document.getElementById('content');
let currentView = 'list';
let currentCategory = 'all';
let listings = [];

const CATEGORIES = [
  { id: 'all', label: 'All', icon: '' },
  { id: 'chipper', label: 'ü™µ Chippers', icon: 'ü™µ' },
  { id: 'chainsaw', label: 'ü™ö Saws', icon: 'ü™ö' },
  { id: 'bucket_truck', label: 'üöõ Trucks', icon: 'üöõ' },
  { id: 'log_truck', label: 'üöõ Log Trucks', icon: 'üöõ' },
  { id: 'stump_grinder', label: 'ü™® Stump Grinders', icon: 'ü™®' },
  { id: 'crane', label: 'üèóÔ∏è Cranes', icon: 'üèóÔ∏è' },
  { id: 'safety_gear', label: 'üßó Safety', icon: 'üßó' },
  { id: 'rigging', label: '‚õìÔ∏è Rigging', icon: '‚õìÔ∏è' },
  { id: 'trailer', label: 'üöú Trailers', icon: 'üöú' },
  { id: 'skid_steer', label: 'üöú Skid Steers', icon: 'üöú' },
  { id: 'other', label: 'üì¶ Other', icon: 'üì¶' },
];

const COND_CLASSES = { new: 'badge-new', like_new: 'badge-like-new', good: 'badge-good', fair: 'badge-fair', parts_only: 'badge-parts' };
const COND_LABELS = { new: 'New', like_new: 'Like New', good: 'Good', fair: 'Fair', parts_only: 'Parts Only' };

function getCategoryIcon(cat) {
  const c = CATEGORIES.find(x => x.id === cat);
  return c ? c.icon : 'üì¶';
}

function timeAgo(dateStr) {
  const diff = Date.now() - new Date(dateStr).getTime();
  const mins = Math.floor(diff / 60000);
  if (mins < 60) return `${mins}m ago`;
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return `${hrs}h ago`;
  const days = Math.floor(hrs / 24);
  if (days < 7) return `${days}d ago`;
  return `${Math.floor(days / 7)}w ago`;
}

async function loadListings() {
  let query = sb.from('equipment_listings').select('*').eq('is_sold', false).order('created_at', { ascending: false });
  if (currentCategory !== 'all') query = query.eq('category', currentCategory);
  const { data, error } = await query;
  if (error) { console.error(error); listings = []; }
  else listings = data || [];
  renderList();
}

function renderList() {
  const filtered = listings;
  content.innerHTML = `
    <div class="filters">
      ${CATEGORIES.map(c => `<button class="filter-pill ${currentCategory === c.id ? 'active' : ''}" onclick="setCategory('${c.id}')">${c.label}</button>`).join('')}
    </div>
    <div class="section-header">
      <div style="display:flex;align-items:center;gap:8px">
        <span class="section-title">Equipment</span>
        <span class="section-count">${filtered.length}</span>
      </div>
      <button class="btn-sell" onclick="showPostForm()">+ Sell</button>
    </div>
    ${filtered.length === 0 ? `
      <div class="empty">
        <div class="empty-icon">üîß</div>
        <div class="empty-title">No equipment listed yet</div>
        <div class="empty-desc">Be the first to list equipment for sale!</div>
      </div>
    ` : filtered.map(e => `
      <div class="listing-card" onclick="showDetail('${e.id}')">
        <div class="listing-row">
          <div class="listing-thumb">${getCategoryIcon(e.category)}</div>
          <div class="listing-info">
            <div class="listing-badges">
              <span class="badge ${COND_CLASSES[e.condition] || 'badge-good'}">${COND_LABELS[e.condition] || e.condition}</span>
            </div>
            <div class="listing-title">${e.title}</div>
            <div class="listing-price">$${Number(e.price).toLocaleString()} ${e.price_type === 'obo' ? '<span class="obo">OBO</span>' : e.price_type === 'trade' ? '<span class="obo">Trade</span>' : e.price_type === 'free' ? '<span class="obo">FREE</span>' : ''}</div>
            <div class="listing-meta">
              <span><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg> ${e.location || 'N/A'}</span>
              <span>${timeAgo(e.created_at)}</span>
            </div>
          </div>
          <div class="listing-chevron"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="9 18 15 12 9 6"/></svg></div>
        </div>
      </div>
    `).join('')}
  `;
}

function showDetail(id) {
  const e = listings.find(x => x.id === id);
  if (!e) return;
  // Increment view count
  sb.from('equipment_listings').update({ views: (e.views || 0) + 1 }).eq('id', id).then();

  content.innerHTML = `
    <button class="detail-back" onclick="loadListings()">‚Üê Back to listings</button>
    <div class="detail-image">${getCategoryIcon(e.category)}</div>
    <div class="listing-badges" style="margin-bottom:4px">
      <span class="badge ${COND_CLASSES[e.condition] || 'badge-good'}">${COND_LABELS[e.condition] || e.condition}</span>
      <span class="badge" style="color:#5A6B5E;background:#E8EDE9">${e.category.replace(/_/g, ' ')}</span>
    </div>
    <div class="detail-title">${e.title}</div>
    <div class="detail-price">$${Number(e.price).toLocaleString()} ${e.price_type === 'obo' ? '<span class="obo">OBO</span>' : ''}</div>
    <div class="detail-desc">${e.description || 'No description provided.'}</div>
    <div class="seller-card">
      <div class="seller-row">
        <div class="seller-avatar" style="background:${e.seller_type === 'company' ? 'rgba(45,122,58,0.1)' : '#E3F2FD'}">${e.seller_type === 'company' ? 'üè¢' : 'üë∑'}</div>
        <div style="flex:1">
          <div class="seller-name">${e.seller_name}</div>
          <div class="seller-location"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg> ${e.location || 'N/A'}</div>
        </div>
      </div>
    </div>
    <div class="detail-actions">
      ${e.phone ? `<a href="tel:${e.phone}" class="btn-primary" style="text-align:center;text-decoration:none">üìû Call Seller</a>` : ''}
      ${e.email ? `<a href="mailto:${e.email}" class="btn-secondary" style="text-align:center;text-decoration:none">‚úâÔ∏è Email</a>` : '<button class="btn-secondary" onclick="alert(\'Contact info not provided\')">üí¨ Message</button>'}
    </div>
    <div style="text-align:center;margin-top:12px;font-size:11px;color:#8A9B8E">${e.views || 0} views ¬∑ Listed ${timeAgo(e.created_at)}</div>
  `;
  content.scrollTop = 0;
}

function showPostForm() {
  content.innerHTML = `
    <button class="detail-back" onclick="loadListings()">‚Üê Back to listings</button>
    <div style="font-size:20px;font-weight:800;color:#1A3C2A;margin-bottom:16px">List Equipment for Sale</div>
    <form id="postForm" onsubmit="submitListing(event)">
      <div class="form-group">
        <label class="form-label">Title *</label>
        <input class="form-input" name="title" placeholder="e.g. 2019 Vermeer BC1000XL Chipper" required>
      </div>
      <div class="form-group">
        <label class="form-label">Category *</label>
        <select class="form-select" name="category" required>
          ${CATEGORIES.filter(c => c.id !== 'all').map(c => `<option value="${c.id}">${c.icon} ${c.label.replace(/^[^ ]+ /, '')}</option>`).join('')}
        </select>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Condition *</label>
          <select class="form-select" name="condition" required>
            <option value="new">New</option>
            <option value="like_new">Like New</option>
            <option value="good" selected>Good</option>
            <option value="fair">Fair</option>
            <option value="parts_only">Parts Only</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Price *</label>
          <input class="form-input" name="price" type="number" step="0.01" min="0" placeholder="0.00" required>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Price Type</label>
        <select class="form-select" name="price_type">
          <option value="fixed">Fixed Price</option>
          <option value="obo">Or Best Offer</option>
          <option value="trade">Open to Trade</option>
          <option value="free">Free</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Description</label>
        <textarea class="form-input form-textarea" name="description" placeholder="Hours, condition details, what's included..."></textarea>
      </div>
      <div class="form-group">
        <label class="form-label">Your Name *</label>
        <input class="form-input" name="seller_name" placeholder="Name or company name" required>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Phone</label>
          <input class="form-input" name="phone" type="tel" placeholder="(555) 123-4567">
        </div>
        <div class="form-group">
          <label class="form-label">Email</label>
          <input class="form-input" name="email" type="email" placeholder="you@email.com">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Location *</label>
        <input class="form-input" name="location" placeholder="City, State" required>
      </div>
      <button type="submit" class="btn-primary" style="width:100%;margin-top:8px">üìã Post Listing</button>
    </form>
  `;
  content.scrollTop = 0;
}

async function submitListing(e) {
  e.preventDefault();
  const form = document.getElementById('postForm');
  const data = Object.fromEntries(new FormData(form));
  data.price = parseFloat(data.price);
  data.seller_type = 'company'; // default
  data.is_sold = false;
  data.views = 0;

  const btn = form.querySelector('button[type="submit"]');
  btn.disabled = true;
  btn.textContent = 'Posting...';

  const { error } = await sb.from('equipment_listings').insert([data]);
  if (error) {
    alert('Error posting: ' + error.message);
    btn.disabled = false;
    btn.textContent = 'üìã Post Listing';
  } else {
    alert('Equipment listed successfully!');
    currentCategory = 'all';
    await loadListings();
  }
}

function setCategory(cat) {
  currentCategory = cat;
  loadListings();
}

// Init
loadListings();
</script>
</body>
</html>
