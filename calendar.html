<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>CrewFinder ‚Äî Crew Calendar</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Outfit', -apple-system, sans-serif; background: #E8E8E8; display: flex; justify-content: center; min-height: 100vh; }
  #app { width: 100%; max-width: 430px; min-height: 100vh; background: #F7FAF7; display: flex; flex-direction: column; }
  @media (min-width: 431px) { body { padding: 20px; align-items: center; } #app { min-height: 85vh; max-height: 90vh; border-radius: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.15); overflow: hidden; } }
  .header { background: #fff; padding: 12px 16px; border-bottom: 1px solid #E8E8E8; display: flex; justify-content: space-between; align-items: center; }
  .header-logo { display: flex; align-items: center; gap: 8px; }
  .header-logo svg { width: 28px; height: 28px; }
  .header-logo span { font-weight: 800; font-size: 18px; color: #1A3C2A; }
  .header-back { background: none; border: 1px solid #DDD; border-radius: 8px; padding: 5px 12px; font-size: 11px; color: #888; cursor: pointer; font-family: inherit; }
  .content { flex: 1; overflow-y: auto; padding: 16px; }

  /* Week Strip */
  .week-strip { display: flex; gap: 4px; margin-bottom: 16px; padding: 4px; background: #E8EDE9; border-radius: 14px; }
  .day-btn { flex: 1; padding: 8px 2px; border-radius: 10px; border: none; background: transparent; color: #5A6B5E; cursor: pointer; font-family: inherit; transition: all 0.15s; text-align: center; }
  .day-btn.active { background: #2D7A3A; color: #fff; }
  .day-btn .day-label { font-size: 10px; font-weight: 500; opacity: 0.7; }
  .day-btn .day-num { font-size: 16px; font-weight: 700; }
  .day-btn .today-dot { width: 4px; height: 4px; border-radius: 50%; margin: 2px auto 0; }
  .day-btn.active .today-dot { background: #fff; }
  .day-btn .today-dot.show { background: #5CB85C; }

  .filters { display: flex; gap: 6px; margin-bottom: 14px; overflow-x: auto; }
  .filters::-webkit-scrollbar { display: none; }
  .filter-pill { padding: 7px 14px; border-radius: 20px; border: none; background: #E8EDE9; color: #5A6B5E; font-size: 12px; font-weight: 600; cursor: pointer; font-family: inherit; white-space: nowrap; }
  .filter-pill.active { background: #2D7A3A; color: #fff; }

  .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
  .section-title { font-size: 16px; font-weight: 700; color: #1A3C2A; }
  .count-badge { display: inline-flex; padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; color: #2D7A3A; background: rgba(45,122,58,0.1); margin-left: 8px; }

  .card { background: #fff; border-radius: 14px; border: 1px solid #E2E8E4; padding: 14px 16px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
  .card.storm { border-color: rgba(33,150,243,0.3); box-shadow: 0 2px 12px rgba(33,150,243,0.1); }
  .card-top { display: flex; justify-content: space-between; align-items: flex-start; }
  .card-name-row { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
  .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; flex-shrink: 0; }
  .status-dot.available { background: #4CAF50; }
  .status-dot.busy { background: #F44336; }
  .status-dot.booked { background: #FF9800; }
  .status-dot.storm_ready { background: #2196F3; }
  .card-name { font-weight: 700; font-size: 14px; color: #1A3C2A; }
  .badge { display: inline-flex; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; }
  .badge-worker { color: #1565C0; background: #E3F2FD; }
  .badge-company { color: #2D7A3A; background: rgba(45,122,58,0.1); }
  .badge-cert { color: #7B1FA2; background: #F3E5F5; }
  .card-role { font-size: 13px; color: #5A6B5E; margin-bottom: 6px; margin-left: 16px; }
  .card-meta { display: flex; gap: 12px; margin-left: 16px; flex-wrap: wrap; }
  .card-meta span { display: flex; align-items: center; gap: 4px; font-size: 12px; color: #8A9B8E; }
  .card-rate { font-size: 12px; font-weight: 700; color: #2D7A3A; }
  .card-certs { display: flex; gap: 4px; margin-top: 6px; margin-left: 16px; flex-wrap: wrap; }
  .btn-contact { background: #2D7A3A; color: #fff; border: none; border-radius: 8px; padding: 8px 12px; font-size: 12px; font-weight: 600; cursor: pointer; font-family: inherit; white-space: nowrap; }
  .btn-post { width: 100%; padding: 14px; border-radius: 12px; border: 2px dashed rgba(45,122,58,0.3); background: rgba(45,122,58,0.04); color: #2D7A3A; font-size: 14px; font-weight: 700; cursor: pointer; font-family: inherit; margin-top: 8px; }

  .empty { text-align: center; padding: 32px 16px; color: #8A9B8E; }
  .empty-icon { font-size: 32px; margin-bottom: 8px; }

  /* Post Form */
  .form-group { margin-bottom: 14px; }
  .form-label { display: block; font-size: 13px; font-weight: 600; color: #1A3C2A; margin-bottom: 6px; }
  .form-input { width: 100%; padding: 12px 14px; border-radius: 10px; border: 1px solid #E2E8E4; font-size: 14px; font-family: inherit; background: #fff; color: #1A3C2A; outline: none; }
  .form-input:focus { border-color: #2D7A3A; }
  .form-select { width: 100%; padding: 12px 14px; border-radius: 10px; border: 1px solid #E2E8E4; font-size: 14px; font-family: inherit; background: #fff; }
  .form-row { display: flex; gap: 10px; }
  .form-row .form-group { flex: 1; }
  .btn-primary { width: 100%; padding: 14px; border-radius: 12px; background: #2D7A3A; color: #fff; border: none; font-weight: 700; font-size: 14px; cursor: pointer; font-family: inherit; }
  .detail-back { background: none; border: none; color: #2D7A3A; font-weight: 600; font-size: 14px; cursor: pointer; font-family: inherit; padding: 0; margin-bottom: 12px; }

  .bottom-nav { background: #fff; border-top: 1px solid #E8E8E8; display: flex; padding: 6px 8px 10px; }
  .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 2px; background: none; border: none; cursor: pointer; color: #8A9B8E; font-family: inherit; padding: 6px 0; text-decoration: none; }
  .nav-item.active { color: #2D7A3A; }
  .nav-item span { font-size: 10px; font-weight: 500; }
  .nav-item.active span { font-weight: 700; }
  .nav-dot { width: 4px; height: 4px; border-radius: 50%; background: #2D7A3A; }
  .loading { text-align: center; padding: 32px; color: #8A9B8E; }
  .spinner { display: inline-block; width: 24px; height: 24px; border: 3px solid #E2E8E4; border-top-color: #2D7A3A; border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>
<div id="app">
  <div class="header">
    <div class="header-logo">
      <svg viewBox="0 0 100 100" fill="none"><path d="M50 8 L30 40 L38 40 L22 65 L32 65 L18 90 L82 90 L68 65 L78 65 L62 40 L70 40 Z" fill="#2D7A3A" opacity="0.9"/><rect x="44" y="85" width="12" height="15" rx="2" fill="#5D4037"/></svg>
      <span>CrewFinder</span>
    </div>
    <button class="header-back" onclick="window.location.href='app.html'">‚Üê App</button>
  </div>
  <div class="content" id="content"><div class="loading"><div class="spinner"></div><div style="margin-top:8px">Loading calendar...</div></div></div>
  <div class="bottom-nav">
    <a href="app.html" class="nav-item"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg><span>Jobs</span></a>
    <a href="calendar.html" class="nav-item active"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span>Calendar</span><div class="nav-dot"></div></a>
    <a href="equipment.html" class="nav-item"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg><span>Gear</span></a>
    <a href="storm.html" class="nav-item"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 16.9A5 5 0 0 0 18 7h-1.26a8 8 0 1 0-11.62 9"/><polyline points="13 11 9 17 15 17 11 23"/></svg><span>Storm</span></a>
    <a href="news.html" class="nav-item"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2Zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2"/><path d="M18 14h-8"/><path d="M15 18h-5"/><path d="M10 6h8v4h-8V6Z"/></svg><span>News</span></a>
  </div>
</div>
<script>
const SUPABASE_URL = 'https://mhatwlmbwikvrlcgfojt.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1oYXR3bG1id2lrdnJsY2dmb2p0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzgxMDQ4ODYsImV4cCI6MjA1MzY4MDg4Nn0.CHiaEB4vg1qCCpnOb4cOYGP6O_-TE_0Iu21VDnORfCE';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const content = document.getElementById('content');
let selectedDate = new Date().toISOString().split('T')[0];
let viewType = 'all';
let statusFilter = 'all';
let entries = [];

function getWeekDates() {
  const today = new Date();
  const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  return Array.from({length: 7}, (_, i) => {
    const d = new Date(today); d.setDate(today.getDate() + i);
    const iso = d.toISOString().split('T')[0];
    return { day: days[d.getDay()], date: d.getDate(), full: iso, isToday: i === 0 };
  });
}

async function loadEntries() {
  let q = sb.from('crew_availability').select('*').eq('date', selectedDate).order('created_at', { ascending: false });
  if (viewType !== 'all') q = q.eq('user_type', viewType === 'workers' ? 'worker' : 'company');
  if (statusFilter !== 'all') q = q.eq('status', statusFilter);
  const { data, error } = await q;
  entries = data || [];
  renderCalendar();
}

function renderCalendar() {
  const week = getWeekDates();
  const todayStr = new Date().toISOString().split('T')[0];
  const dateLabel = selectedDate === todayStr ? 'Today' : `${new Date(selectedDate + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
  const timeLabels = { morning: 'AM', afternoon: 'PM', full_day: 'Full Day', flexible: 'Flexible' };

  content.innerHTML = `
    <div class="week-strip">
      ${week.map(d => `<button class="day-btn ${selectedDate === d.full ? 'active' : ''}" onclick="selectDate('${d.full}')">
        <div class="day-label">${d.day}</div><div class="day-num">${d.date}</div>
        <div class="today-dot ${d.isToday ? 'show' : ''}"></div>
      </button>`).join('')}
    </div>
    <div class="filters">
      <button class="filter-pill ${viewType === 'all' ? 'active' : ''}" onclick="setView('all')">All</button>
      <button class="filter-pill ${viewType === 'workers' ? 'active' : ''}" onclick="setView('workers')">üë∑ Workers</button>
      <button class="filter-pill ${viewType === 'companies' ? 'active' : ''}" onclick="setView('companies')">üè¢ Companies</button>
      <button class="filter-pill ${statusFilter === 'storm_ready' ? 'active' : ''}" onclick="toggleStorm()">‚õàÔ∏è Storm Ready</button>
    </div>
    <div class="section-header">
      <div><span class="section-title">${dateLabel}</span><span class="count-badge">${entries.length}</span></div>
    </div>
    ${entries.length === 0 ? `<div class="empty"><div class="empty-icon">üìÖ</div><div style="font-weight:600;color:#5A6B5E">No availability posted</div><div style="font-size:13px;margin-top:4px">Post yours or check another date</div></div>` :
    entries.map(a => `
      <div class="card ${a.status === 'storm_ready' ? 'storm' : ''}">
        <div class="card-top">
          <div style="flex:1">
            <div class="card-name-row">
              <span class="status-dot ${a.status}"></span>
              <span class="card-name">${a.display_name}</span>
              <span class="badge ${a.user_type === 'worker' ? 'badge-worker' : 'badge-company'}">${a.user_type === 'worker' ? 'Worker' : 'Company'}</span>
            </div>
            ${a.notes ? `<div class="card-role">${a.notes}</div>` : ''}
            <div class="card-meta">
              ${a.location ? `<span><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>${a.location}</span>` : ''}
              ${a.time_preference ? `<span><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>${timeLabels[a.time_preference] || a.time_preference}</span>` : ''}
              ${a.hourly_rate ? `<span class="card-rate">$${a.hourly_rate}/hr</span>` : ''}
            </div>
          </div>
          <button class="btn-contact" onclick="alert('Contact feature coming soon!')">Contact</button>
        </div>
      </div>
    `).join('')}
    <button class="btn-post" onclick="showPostForm()">+ Post Your Availability</button>
  `;
}

function showPostForm() {
  content.innerHTML = `
    <button class="detail-back" onclick="loadEntries()">‚Üê Back to calendar</button>
    <div style="font-size:20px;font-weight:800;color:#1A3C2A;margin-bottom:16px">Post Availability</div>
    <form id="availForm" onsubmit="submitAvail(event)">
      <div class="form-group"><label class="form-label">Your Name *</label><input class="form-input" name="display_name" required></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">I Am A *</label><select class="form-select" name="user_type"><option value="worker">Worker</option><option value="company">Company</option></select></div>
        <div class="form-group"><label class="form-label">Date *</label><input class="form-input" name="date" type="date" value="${selectedDate}" required></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Status *</label><select class="form-select" name="status"><option value="available">Available</option><option value="storm_ready">Storm Ready</option></select></div>
        <div class="form-group"><label class="form-label">Time</label><select class="form-select" name="time_preference"><option value="full_day">Full Day</option><option value="morning">Morning</option><option value="afternoon">Afternoon</option><option value="flexible">Flexible</option></select></div>
      </div>
      <div class="form-group"><label class="form-label">Location *</label><input class="form-input" name="location" placeholder="City, State" required></div>
      <div class="form-group"><label class="form-label">Hourly Rate ($)</label><input class="form-input" name="hourly_rate" type="number" step="0.01" placeholder="Optional"></div>
      <div class="form-group"><label class="form-label">Notes</label><input class="form-input" name="notes" placeholder="Skills, certs, equipment, what you need..."></div>
      <button type="submit" class="btn-primary" style="margin-top:8px">üìÖ Post Availability</button>
    </form>
  `;
}

async function submitAvail(e) {
  e.preventDefault();
  const data = Object.fromEntries(new FormData(document.getElementById('availForm')));
  if (data.hourly_rate) data.hourly_rate = parseFloat(data.hourly_rate);
  else delete data.hourly_rate;
  const btn = e.target.querySelector('button[type="submit"]');
  btn.disabled = true; btn.textContent = 'Posting...';
  const { error } = await sb.from('crew_availability').insert([data]);
  if (error) { alert('Error: ' + error.message); btn.disabled = false; btn.textContent = 'üìÖ Post Availability'; }
  else { alert('Availability posted!'); selectedDate = data.date; await loadEntries(); }
}

function selectDate(d) { selectedDate = d; loadEntries(); }
function setView(v) { viewType = v; loadEntries(); }
function toggleStorm() { statusFilter = statusFilter === 'storm_ready' ? 'all' : 'storm_ready'; loadEntries(); }

loadEntries();
</script>
</body>
</html>
