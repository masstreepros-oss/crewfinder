<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#1A3C2A">
<title>CrewFinder</title>
<link rel="manifest" href="manifest.json">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
/* ============================================
   CSS RESET & VARIABLES
   ============================================ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --forest: #0B1F14;
  --forest-mid: #1A3C2A;
  --green: #2D7A3A;
  --lime: #5CB85C;
  --light-green: #D4EDDA;
  --pale-green: #F0FAF0;
  --blue: #1565C0;
  --light-blue: #E3F2FD;
  --amber: #D4900E;
  --red: #C62828;
  --light-red: #FFEBEE;
  --orange: #E65100;
  --light-orange: #FFF3E0;
  --purple: #6A1B9A;
  --light-purple: #F3E5F5;
  --white: #FFFFFF;
  --gray-50: #FAFAFA;
  --gray-100: #F5F5F5;
  --gray-200: #E8E8E8;
  --gray-300: #DDD;
  --gray-400: #BBB;
  --gray-500: #888;
  --gray-600: #666;
  --gray-700: #444;
  --gray-800: #333;
  --dark: #1A1A1A;
  --radius: 12px;
  --radius-sm: 8px;
  --radius-lg: 16px;
  --shadow: 0 1px 3px rgba(0,0,0,0.06);
  --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
}

body {
  font-family: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--gray-100);
  color: var(--dark);
  line-height: 1.5;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
}

#app {
  max-width: 430px;
  margin: 0 auto;
  min-height: 100vh;
  min-height: 100dvh;
  background: var(--gray-100);
  position: relative;
  display: flex;
  flex-direction: column;
}

@media (min-width: 431px) {
  body { background: #E0E0E0; display: flex; justify-content: center; padding: 20px 0; }
  #app { border-radius: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.15); overflow: hidden; height: 90vh; }
  #app > * { overflow-y: auto; }
}

/* ============================================
   UTILITY CLASSES
   ============================================ */
.hidden { display: none !important; }

.screen {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

/* ============================================
   SPLASH / WELCOME SCREEN
   ============================================ */
.splash {
  flex: 1;
  background: linear-gradient(170deg, #050D09 0%, var(--forest) 30%, var(--forest-mid) 70%, var(--green) 100%);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 32px 24px;
  position: relative;
  overflow: hidden;
}

.splash::before {
  content: '';
  position: absolute;
  top: -40%; right: -40%;
  width: 80%; height: 120%;
  background: radial-gradient(ellipse, rgba(92,184,92,0.1) 0%, transparent 70%);
}

.splash-logo { display: flex; align-items: center; gap: 10px; position: relative; margin-bottom: 8px; }
.splash-logo span { color: #fff; font-size: 30px; font-weight: 800; letter-spacing: -1px; }
.splash-sub { color: rgba(255,255,255,0.6); font-size: 15px; position: relative; margin-bottom: 48px; }

.splash-btn {
  width: 100%; max-width: 300px;
  padding: 18px 20px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,0.18);
  background: rgba(255,255,255,0.08);
  cursor: pointer;
  text-align: left;
  margin-bottom: 12px;
  transition: all 0.2s;
  position: relative;
  backdrop-filter: blur(8px);
  font-family: inherit;
}

.splash-btn:active { transform: scale(0.98); background: rgba(255,255,255,0.15); }
.splash-btn-title { color: #fff; font-weight: 700; font-size: 16px; }
.splash-btn-desc { color: rgba(255,255,255,0.55); font-size: 13px; margin-top: 3px; }

.splash-link {
  color: rgba(255,255,255,0.5);
  font-size: 13px;
  margin-top: 24px;
  position: relative;
  cursor: pointer;
  background: none;
  border: none;
  font-family: inherit;
  text-decoration: underline;
}

/* ============================================
   AUTH SCREENS (Sign Up / Log In)
   ============================================ */
.auth-screen {
  flex: 1;
  background: var(--white);
  display: flex;
  flex-direction: column;
}

.auth-header {
  background: linear-gradient(135deg, var(--forest), var(--green));
  padding: 20px 20px 28px;
  color: #fff;
}

.auth-back {
  background: rgba(255,255,255,0.15);
  border: none;
  color: #fff;
  padding: 6px 14px;
  border-radius: var(--radius-sm);
  cursor: pointer;
  font-size: 13px;
  font-family: inherit;
  margin-bottom: 16px;
}

.auth-header h1 { font-size: 24px; font-weight: 800; }
.auth-header p { font-size: 14px; opacity: 0.8; margin-top: 4px; }

.auth-form { padding: 24px 20px; flex: 1; }

.form-group { margin-bottom: 16px; }

.form-label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  color: var(--gray-800);
  margin-bottom: 6px;
}

.form-input {
  width: 100%;
  padding: 12px 14px;
  border-radius: var(--radius-sm);
  border: 1.5px solid var(--gray-300);
  font-size: 15px;
  font-family: inherit;
  outline: none;
  transition: border-color 0.2s;
  background: var(--white);
}

.form-input:focus { border-color: var(--green); }

.form-input::placeholder { color: var(--gray-400); }

.form-select {
  width: 100%;
  padding: 12px 14px;
  border-radius: var(--radius-sm);
  border: 1.5px solid var(--gray-300);
  font-size: 15px;
  font-family: inherit;
  outline: none;
  background: var(--white);
  cursor: pointer;
  -webkit-appearance: none;
}

.form-hint { font-size: 12px; color: var(--gray-500); margin-top: 4px; }

.btn {
  width: 100%;
  padding: 14px;
  border-radius: var(--radius);
  font-weight: 700;
  font-size: 15px;
  cursor: pointer;
  font-family: inherit;
  border: none;
  transition: all 0.2s;
}

.btn-primary {
  background: linear-gradient(135deg, var(--forest-mid), var(--green));
  color: var(--white);
}

.btn-primary:active { transform: scale(0.98); }
.btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

.btn-secondary {
  background: var(--white);
  color: var(--green);
  border: 2px solid var(--green);
}

.btn-outline {
  background: transparent;
  color: var(--green);
  border: 1.5px solid var(--gray-300);
}

.auth-footer {
  text-align: center;
  padding: 16px 20px 24px;
  font-size: 14px;
  color: var(--gray-500);
}

.auth-footer a, .auth-footer button {
  color: var(--green);
  font-weight: 600;
  text-decoration: none;
  cursor: pointer;
  background: none;
  border: none;
  font-family: inherit;
  font-size: 14px;
}

.form-error {
  background: var(--light-red);
  color: var(--red);
  padding: 10px 14px;
  border-radius: var(--radius-sm);
  font-size: 13px;
  font-weight: 500;
  margin-bottom: 16px;
  display: none;
}

.form-error.show { display: block; }

.form-success {
  background: var(--light-green);
  color: var(--green);
  padding: 10px 14px;
  border-radius: var(--radius-sm);
  font-size: 13px;
  font-weight: 500;
  margin-bottom: 16px;
  display: none;
}

.form-success.show { display: block; }

/* ============================================
   HEADER
   ============================================ */
.app-header {
  background: var(--white);
  padding: 12px 16px;
  border-bottom: 1px solid var(--gray-200);
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 100;
}

.app-header-logo { display: flex; align-items: center; gap: 8px; }
.app-header-logo span { font-weight: 800; font-size: 18px; color: var(--forest-mid); letter-spacing: -0.3px; }

.header-actions { display: flex; align-items: center; gap: 8px; }

.header-btn {
  background: none;
  border: 1px solid var(--gray-300);
  border-radius: var(--radius-sm);
  padding: 5px 10px;
  font-size: 11px;
  color: var(--gray-500);
  cursor: pointer;
  font-family: inherit;
}

/* ============================================
   BOTTOM NAV
   ============================================ */
.bottom-nav {
  background: var(--white);
  border-top: 1px solid var(--gray-200);
  display: flex;
  justify-content: space-around;
  padding: 6px 0 max(10px, env(safe-area-inset-bottom));
  position: sticky;
  bottom: 0;
  z-index: 100;
}

.nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
  background: none;
  border: none;
  cursor: pointer;
  padding: 4px 10px;
  color: var(--gray-400);
  transition: color 0.2s;
  position: relative;
  font-family: inherit;
}

.nav-item.active { color: var(--green); }
.nav-item svg { width: 22px; height: 22px; }
.nav-item span { font-size: 10px; font-weight: 500; }
.nav-item.active span { font-weight: 700; }

.nav-badge {
  position: absolute;
  top: 0; right: 4px;
  width: 8px; height: 8px;
  background: var(--red);
  border-radius: 50%;
}

/* ============================================
   PROFILE BUILDER
   ============================================ */
.profile-builder {
  flex: 1;
  display: flex;
  flex-direction: column;
  height: 100%;
  overflow: hidden;
}

.profile-builder-header {
  background: linear-gradient(135deg, var(--forest), var(--green));
  padding: 20px 20px 24px;
  color: #fff;
  flex-shrink: 0;
}

.profile-builder-header h1 { font-size: 22px; font-weight: 800; }
.profile-builder-header p { font-size: 14px; opacity: 0.8; margin-top: 4px; }

.profile-steps {
  display: flex;
  gap: 4px;
  margin-top: 16px;
}

.profile-step-dot {
  height: 4px;
  flex: 1;
  border-radius: 2px;
  background: rgba(255,255,255,0.2);
  transition: background 0.3s;
}

.profile-step-dot.active { background: var(--lime); }
.profile-step-dot.done { background: rgba(255,255,255,0.6); }

.profile-builder-body {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

.profile-builder-footer {
  padding: 12px 20px 24px;
  display: flex;
  gap: 10px;
  flex-shrink: 0;
  background: var(--white);
  border-top: 1px solid var(--gray-200);
}

/* ============================================
   SKILL PICKER
   ============================================ */
.skill-section { margin-bottom: 20px; }

.skill-section-title {
  font-size: 14px;
  font-weight: 700;
  color: var(--forest-mid);
  margin-bottom: 10px;
  padding-bottom: 6px;
  border-bottom: 2px solid var(--light-green);
}

.skill-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}

.skill-chip {
  padding: 8px 14px;
  border-radius: 24px;
  font-size: 13px;
  font-weight: 500;
  border: 1.5px solid var(--gray-300);
  background: var(--white);
  color: var(--gray-700);
  cursor: pointer;
  transition: all 0.15s;
  font-family: inherit;
  user-select: none;
  -webkit-user-select: none;
}

.skill-chip:active { transform: scale(0.96); }

.skill-chip.selected {
  border-color: var(--green);
  background: var(--light-green);
  color: var(--green);
  font-weight: 600;
}

.skill-chip.selected::before {
  content: '✓ ';
  font-size: 11px;
}

/* ============================================
   AVAILABILITY PICKER
   ============================================ */
.avail-option {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px 16px;
  border-radius: var(--radius);
  border: 1.5px solid var(--gray-300);
  background: var(--white);
  margin-bottom: 8px;
  cursor: pointer;
  transition: all 0.15s;
  font-family: inherit;
}

.avail-option:active { transform: scale(0.99); }

.avail-option.selected {
  border-color: var(--green);
  background: var(--pale-green);
}

.avail-radio {
  width: 20px; height: 20px;
  border-radius: 50%;
  border: 2px solid var(--gray-400);
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.15s;
}

.avail-option.selected .avail-radio {
  border-color: var(--green);
  background: var(--green);
}

.avail-option.selected .avail-radio::after {
  content: '';
  width: 8px; height: 8px;
  border-radius: 50%;
  background: var(--white);
}

.avail-label { font-weight: 600; font-size: 14px; }
.avail-desc { font-size: 12px; color: var(--gray-500); margin-top: 1px; }

/* ============================================
   PAY RANGE SLIDER
   ============================================ */
.pay-display {
  text-align: center;
  font-size: 28px;
  font-weight: 800;
  color: var(--green);
  margin: 16px 0;
}

.pay-range-row {
  display: flex;
  gap: 12px;
  align-items: center;
}

.pay-range-row input {
  flex: 1;
  padding: 12px 14px;
  border-radius: var(--radius-sm);
  border: 1.5px solid var(--gray-300);
  font-size: 16px;
  font-family: inherit;
  text-align: center;
  outline: none;
  font-weight: 600;
}

.pay-range-row input:focus { border-color: var(--green); }
.pay-range-row span { color: var(--gray-500); font-weight: 600; }

/* ============================================
   CARDS
   ============================================ */
.card {
  background: var(--white);
  border-radius: var(--radius);
  padding: 16px;
  margin-bottom: 10px;
  border: 1px solid var(--gray-200);
  box-shadow: var(--shadow);
}

/* ============================================
   BADGE
   ============================================ */
.badge {
  display: inline-block;
  padding: 3px 10px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 600;
  white-space: nowrap;
}

.badge-skill { background: var(--light-green); color: var(--green); border: 1px solid #C8E6C9; }
.badge-cert { background: var(--light-orange); color: var(--orange); border: 1px solid #FFE0B2; }
.badge-urgent { background: var(--light-red); color: var(--red); border: 1px solid #FFCDD2; }
.badge-storm { background: var(--light-blue); color: var(--blue); border: 1px solid #BBDEFB; }
.badge-trade { background: var(--light-purple); color: var(--purple); border: 1px solid #E1BEE7; }
.badge-avail { background: #E8F5E9; color: #2E7D32; border: 1px solid #C8E6C9; }

/* ============================================
   WORKER CARD (in search results)
   ============================================ */
.worker-card {
  background: var(--white);
  border-radius: var(--radius);
  padding: 14px;
  margin-bottom: 10px;
  border: 1px solid var(--gray-200);
  box-shadow: var(--shadow);
  cursor: pointer;
  transition: all 0.15s;
}

.worker-card:active { transform: scale(0.99); background: var(--gray-50); }

.worker-card-row { display: flex; gap: 12px; align-items: flex-start; }

.avatar {
  width: 46px; height: 46px;
  border-radius: 23px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #fff;
  font-weight: 700;
  font-size: 15px;
  flex-shrink: 0;
  background: linear-gradient(135deg, var(--forest-mid), var(--green));
}

.avatar.blue { background: linear-gradient(135deg, #1565C0, #42A5F5); }

.worker-name { font-weight: 700; font-size: 15px; color: var(--dark); }
.worker-dist { font-size: 12px; color: var(--gray-500); }

.rating-row { display: flex; align-items: center; gap: 3px; margin: 2px 0; }
.star { color: var(--amber); font-size: 13px; }
.rating-num { font-size: 13px; font-weight: 600; color: var(--gray-800); }
.rating-count { font-size: 12px; color: var(--gray-500); }

.worker-pay { font-size: 13px; font-weight: 600; color: var(--green); margin: 2px 0; }

.badge-wrap { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px; }

/* ============================================
   JOB CARD
   ============================================ */
.job-card {
  background: var(--white);
  border-radius: var(--radius);
  padding: 14px;
  margin-bottom: 10px;
  border: 1px solid var(--gray-200);
  box-shadow: var(--shadow);
  cursor: pointer;
  transition: all 0.15s;
}

.job-card.urgent { border-color: #FFCDD2; }
.job-card:active { transform: scale(0.99); }

.job-title { font-weight: 700; font-size: 15px; color: var(--dark); }
.job-meta { font-size: 13px; color: var(--gray-600); margin-top: 2px; }
.job-pay { font-weight: 700; color: var(--green); font-size: 14px; white-space: nowrap; }
.job-posted { font-size: 12px; color: var(--gray-500); margin-top: 8px; }

/* ============================================
   SEARCH / FILTER BAR
   ============================================ */
.search-bar {
  padding: 12px 16px 8px;
  position: relative;
}

.search-bar input {
  width: 100%;
  padding: 10px 12px 10px 38px;
  border-radius: var(--radius);
  border: 1.5px solid var(--gray-300);
  font-size: 14px;
  font-family: inherit;
  outline: none;
  background: var(--white);
}

.search-bar input:focus { border-color: var(--green); }

.search-bar svg {
  position: absolute;
  left: 28px; top: 22px;
  color: var(--gray-400);
}

.filter-row {
  display: flex;
  gap: 8px;
  padding: 4px 16px 8px;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

.filter-row::-webkit-scrollbar { display: none; }

.filter-chip {
  padding: 6px 14px;
  border-radius: 20px;
  border: 1.5px solid var(--gray-300);
  background: var(--white);
  color: var(--gray-600);
  font-weight: 600;
  font-size: 12px;
  cursor: pointer;
  white-space: nowrap;
  font-family: inherit;
  transition: all 0.15s;
}

.filter-chip.active {
  border-color: var(--green);
  background: var(--light-green);
  color: var(--green);
}

/* ============================================
   MESSAGE THREAD
   ============================================ */
.msg-item {
  padding: 14px 16px;
  border-bottom: 1px solid var(--gray-200);
  cursor: pointer;
  transition: background 0.15s;
}

.msg-item:active { background: var(--gray-50); }
.msg-item.unread { background: var(--pale-green); }

.msg-name { font-weight: 700; font-size: 14px; }
.msg-time { font-size: 11px; color: var(--gray-500); }
.msg-preview { font-size: 13px; color: var(--gray-600); margin-top: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

/* ============================================
   CHAT
   ============================================ */
.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.chat-bubble {
  max-width: 80%;
  padding: 10px 14px;
  border-radius: 16px;
  font-size: 14px;
  line-height: 1.4;
}

.chat-bubble.sent {
  background: var(--green);
  color: var(--white);
  align-self: flex-end;
  border-bottom-right-radius: 4px;
}

.chat-bubble.received {
  background: var(--white);
  color: var(--dark);
  align-self: flex-start;
  border-bottom-left-radius: 4px;
  border: 1px solid var(--gray-200);
}

.chat-input-bar {
  display: flex;
  gap: 8px;
  padding: 10px 16px;
  border-top: 1px solid var(--gray-200);
  background: var(--white);
}

.chat-input-bar input {
  flex: 1;
  padding: 10px 14px;
  border-radius: 24px;
  border: 1.5px solid var(--gray-300);
  font-size: 14px;
  font-family: inherit;
  outline: none;
}

.chat-input-bar input:focus { border-color: var(--green); }

.chat-send-btn {
  width: 40px; height: 40px;
  border-radius: 20px;
  background: var(--green);
  border: none;
  color: var(--white);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

/* ============================================
   LOADING / SPINNER
   ============================================ */
.spinner {
  width: 24px; height: 24px;
  border: 3px solid var(--gray-300);
  border-top-color: var(--green);
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
  margin: 0 auto;
}

@keyframes spin { to { transform: rotate(360deg); } }

.loading-screen {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 16px;
  color: var(--gray-500);
  font-size: 14px;
}

/* ============================================
   PROFILE VIEW
   ============================================ */
.profile-view-header {
  background: linear-gradient(135deg, var(--forest), var(--green));
  padding: 16px 16px 24px;
  color: #fff;
}

.profile-section {
  background: var(--white);
  border-radius: var(--radius);
  padding: 16px;
  margin: 0 16px 10px;
  border: 1px solid var(--gray-200);
}

.profile-section-title {
  font-weight: 700;
  color: var(--forest-mid);
  margin-bottom: 8px;
  font-size: 14px;
}

/* ============================================
   STORM BLAST
   ============================================ */
.storm-header {
  background: linear-gradient(135deg, #0D47A1, #1976D2);
  border-radius: var(--radius-lg);
  padding: 20px;
  color: #fff;
  margin: 16px;
}

.storm-title {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 10px;
}

/* ============================================
   PHOTO GRID
   ============================================ */
.photo-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
}

.photo-item {
  aspect-ratio: 1;
  border-radius: 10px;
  overflow: hidden;
  position: relative;
}

.photo-add {
  border: 2px dashed var(--gray-300);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.15s;
  background: var(--white);
}

.photo-add:active { background: var(--gray-100); }

.photo-delete {
  position: absolute;
  top: 4px;
  right: 4px;
  width: 24px;
  height: 24px;
  border-radius: 12px;
  background: rgba(0,0,0,0.6);
  color: #fff;
  border: none;
  font-size: 16px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  line-height: 1;
}

/* ============================================
   TOAST NOTIFICATION
   ============================================ */
.toast {
  position: fixed;
  bottom: 80px;
  left: 50%;
  transform: translateX(-50%) translateY(100px);
  background: var(--dark);
  color: var(--white);
  padding: 12px 24px;
  border-radius: var(--radius);
  font-size: 14px;
  font-weight: 500;
  z-index: 9999;
  transition: transform 0.3s ease;
  max-width: 90%;
  text-align: center;
}

.toast.show { transform: translateX(-50%) translateY(0); }

/* ============================================
   PAGE-LEVEL STYLES
   ============================================ */
.page-padding { padding: 16px; }
.page-title { font-weight: 700; font-size: 17px; color: var(--forest-mid); margin-bottom: 4px; }
.page-sub { font-size: 13px; color: var(--gray-500); margin-bottom: 12px; }
.section-gap { height: 16px; }

.empty-state {
  text-align: center;
  padding: 40px 20px;
  color: var(--gray-500);
}

.empty-state-icon { font-size: 48px; margin-bottom: 12px; }
.empty-state h3 { font-size: 17px; font-weight: 700; color: var(--gray-700); margin-bottom: 6px; }
.empty-state p { font-size: 14px; line-height: 1.5; }
</style>
</head>
<body>

<div id="app">
  <!-- All screens render here via JS -->
  <div class="loading-screen" id="loading-screen">
    <div class="spinner"></div>
    <span>Loading CrewFinder...</span>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ============================================
// SUPABASE INIT
// ============================================
const SUPABASE_URL = 'https://mhatwlmbwikvrlcgfojt.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1oYXR3bG1id2lrdnJsY2dmb2p0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzNDUzMTQsImV4cCI6MjA4NjkyMTMxNH0.8LefO4aYzYGfmsUb4blBEBLjIoF4CtYJ7xfimdc7lBE';
const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ============================================
// APP STATE
// ============================================
let state = {
  user: null,
  profile: null,
  skills: [],
  selectedSkills: new Set(),
  activeTab: 'search',
  currentScreen: 'loading', // loading, splash, signup, login, profile-builder, main
  profileStep: 1,
  signupType: null, // 'worker' or 'business'
  tradeFilter: '',
  workers: [],
  jobs: [],
  conversations: [],
  viewingWorker: null,
  viewingJob: null,
  chattingWith: null,
  chatMessages: [],
  chatSubscription: null,
  workPhotos: [],
};

// ============================================
// UTILITY FUNCTIONS
// ============================================
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => document.querySelectorAll(sel);

let toastTimer = null;
function showToast(msg) {
  const t = document.getElementById('toast');
  if (!t) return;
  if (toastTimer) clearTimeout(toastTimer);
  t.textContent = msg;
  t.classList.add('show');
  toastTimer = setTimeout(() => {
    t.classList.remove('show');
    toastTimer = null;
  }, 2500);
}

function getInitials(name) {
  if (!name) return '??';
  return name.split(' ').map(w => w[0]).join('').toUpperCase().slice(0, 2);
}

function formatPay(min, max) {
  const fmin = min ? '$' + (min / 100) : '';
  const fmax = max ? '$' + (max / 100) : '';
  if (fmin && fmax) return `${fmin}-${fmax}/hr`;
  if (fmin) return `${fmin}+/hr`;
  if (fmax) return `Up to ${fmax}/hr`;
  return 'Negotiable';
}

function timeAgo(date) {
  const seconds = Math.floor((new Date() - new Date(date)) / 1000);
  if (seconds < 60) return 'just now';
  const mins = Math.floor(seconds / 60);
  if (mins < 60) return `${mins}m ago`;
  const hours = Math.floor(mins / 60);
  if (hours < 24) return `${hours}h ago`;
  const days = Math.floor(hours / 24);
  return `${days}d ago`;
}

function availLabel(avail) {
  const map = {
    'available_now': 'Available Now',
    'available_this_week': 'Available This Week',
    'available_next_week': 'Available Next Week',
    'storm_response': 'Storm Response',
    'not_available': 'Not Available',
  };
  return map[avail] || avail || 'Not Set';
}

// ============================================
// SVG ICONS
// ============================================
const icons = {
  search: '<path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>',
  jobs: '<path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>',
  messages: '<path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>',
  storm: '<path d="M13 10V3L4 14h7v7l9-11h-7z"/>',
  profile: '<path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>',
  feed: '<path d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>',
  heart: '<path d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>',
  send: '<path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>',
  logo: '<rect width="40" height="40" rx="10" fill="#1A3C2A"/><path d="M20 8L12 16h5v8h6v-8h5L20 8z" fill="#5CB85C"/><path d="M14 28h12M16 32h8" stroke="#5CB85C" stroke-width="2" stroke-linecap="round"/>',
};

function icon(name, size = 22) {
  return `<svg width="${size}" height="${size}" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">${icons[name]}</svg>`;
}

// ============================================
// RENDER ENGINE
// ============================================
function render() {
  const app = $('#app');
  
  switch (state.currentScreen) {
    case 'loading':
      app.innerHTML = `<div class="loading-screen"><div class="spinner"></div><span>Loading CrewFinder...</span></div>`;
      break;
    case 'splash':
      renderSplash(app);
      break;
    case 'signup':
      renderSignup(app);
      break;
    case 'login':
      renderLogin(app);
      break;
    case 'profile-builder':
      renderProfileBuilder(app);
      break;
    case 'main':
      renderMain(app);
      break;
  }
}

// ============================================
// SPLASH SCREEN
// ============================================
function renderSplash(app) {
  app.innerHTML = `
    <div class="splash">
      <div class="splash-logo">
        <svg width="34" height="34" viewBox="0 0 40 40" fill="none">
          <rect width="40" height="40" rx="10" fill="rgba(255,255,255,0.12)"/>
          <path d="M20 8L12 16h5v8h6v-8h5L20 8z" fill="#5CB85C"/>
          <path d="M14 28h12M16 32h8" stroke="#5CB85C" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <span>CrewFinder</span>
      </div>
      <p class="splash-sub">On-demand skilled labor for outdoor trades</p>
      <button class="splash-btn" onclick="startSignup('business')">
        <div class="splash-btn-title">I Need a Worker</div>
        <div class="splash-btn-desc">Find skilled help for tomorrow's job</div>
      </button>
      <button class="splash-btn" onclick="startSignup('worker')">
        <div class="splash-btn-title">I Need Work</div>
        <div class="splash-btn-desc">Pick up jobs and fill your schedule</div>
      </button>
      <button class="splash-link" onclick="goTo('login')">Already have an account? Log in</button>
    </div>
  `;
}

// ============================================
// SIGN UP
// ============================================
function renderSignup(app) {
  const isWorker = state.signupType === 'worker';
  app.innerHTML = `
    <div class="auth-screen">
      <div class="auth-header">
        <button class="auth-back" onclick="goTo('splash')">&larr; Back</button>
        <h1>${isWorker ? 'Create Your Profile' : 'Set Up Your Business'}</h1>
        <p>${isWorker ? 'Get found by companies that need your skills' : 'Start finding skilled workers today'}</p>
      </div>
      <div class="auth-form">
        <div class="form-error" id="signup-error"></div>
        <div class="form-group">
          <label class="form-label">${isWorker ? 'Your Full Name' : 'Your Name'}</label>
          <input class="form-input" id="signup-name" type="text" placeholder="${isWorker ? 'Marcus Rivera' : 'John Smith'}">
        </div>
        ${!isWorker ? `
        <div class="form-group">
          <label class="form-label">Company Name</label>
          <input class="form-input" id="signup-company" type="text" placeholder="Mass Tree Pros">
        </div>
        ` : ''}
        <div class="form-group">
          <label class="form-label">Email</label>
          <input class="form-input" id="signup-email" type="email" placeholder="you@email.com">
        </div>
        <div class="form-group">
          <label class="form-label">Password</label>
          <input class="form-input" id="signup-password" type="password" placeholder="At least 6 characters">
        </div>
        <div class="form-group">
          <label class="form-label">Location</label>
          <input class="form-input" id="signup-location" type="text" placeholder="Medway, MA">
        </div>
        <button class="btn btn-primary" id="signup-btn" onclick="handleSignup()">
          ${isWorker ? 'Create Account' : 'Create Business Account'}
        </button>
      </div>
      <div class="auth-footer">
        Already have an account? <button onclick="goTo('login')">Log in</button>
      </div>
    </div>
  `;
}

// ============================================
// LOG IN
// ============================================
function renderLogin(app) {
  app.innerHTML = `
    <div class="auth-screen">
      <div class="auth-header">
        <button class="auth-back" onclick="goTo('splash')">&larr; Back</button>
        <h1>Welcome Back</h1>
        <p>Log in to your CrewFinder account</p>
      </div>
      <div class="auth-form">
        <div class="form-error" id="login-error"></div>
        <div class="form-group">
          <label class="form-label">Email</label>
          <input class="form-input" id="login-email" type="email" placeholder="you@email.com">
        </div>
        <div class="form-group">
          <label class="form-label">Password</label>
          <input class="form-input" id="login-password" type="password" placeholder="Your password">
        </div>
        <button class="btn btn-primary" id="login-btn" onclick="handleLogin()">Log In</button>
      </div>
      <div class="auth-footer">
        Don't have an account? <button onclick="goTo('splash')">Sign up</button>
      </div>
    </div>
  `;
}

// ============================================
// PROFILE BUILDER (worker skills / biz details)
// ============================================
function renderProfileBuilder(app) {
  const isWorker = state.profile?.user_type === 'worker';
  const step = state.profileStep;
  const totalSteps = isWorker ? 5 : 1;
  
  let stepContent = '';
  let stepTitle = '';
  let stepDesc = '';
  
  if (isWorker) {
    if (step === 1) {
      stepTitle = 'Basic Info';
      stepDesc = 'Your name, photo, and location';
      const avatarUrl = state.profile.avatar_url;
      stepContent = `
        <div style="display:flex;flex-direction:column;align-items:center;margin-bottom:20px">
          <div id="avatar-preview" style="width:80px;height:80px;border-radius:40px;background:linear-gradient(135deg,var(--forest-mid),var(--green));display:flex;align-items:center;justify-content:center;overflow:hidden;margin-bottom:10px;cursor:pointer" onclick="document.getElementById('avatar-input').click()">
            ${avatarUrl ? `<img src="${avatarUrl}" style="width:100%;height:100%;object-fit:cover">` : `<span style="color:#fff;font-size:28px;font-weight:700">${getInitials(state.profile.name)}</span>`}
          </div>
          <input type="file" id="avatar-input" accept="image/*" style="display:none" onchange="uploadAvatar(this)">
          <button style="background:none;border:none;color:var(--green);font-weight:600;font-size:13px;cursor:pointer;font-family:inherit" onclick="document.getElementById('avatar-input').click()">
            ${avatarUrl ? 'Change Photo' : 'Add Profile Photo'}
          </button>
          <div id="avatar-status" style="font-size:12px;color:var(--gray-500);margin-top:4px"></div>
        </div>
        <div class="form-group">
          <label class="form-label">Your Name</label>
          <input class="form-input" id="edit-name" type="text" value="${state.profile.name || ''}">
        </div>
        <div class="form-group">
          <label class="form-label">Location</label>
          <input class="form-input" id="edit-location" type="text" placeholder="Medway, MA" value="${state.profile.location_text || ''}">
          <div class="form-hint">City and state — this is how companies find workers near them</div>
        </div>
        <div class="form-group">
          <label class="form-label">About Me</label>
          <textarea class="form-input" id="edit-bio" rows="4" placeholder="Tell companies about yourself — your experience, what you're good at, what kind of work you're looking for...">${state.profile.bio || ''}</textarea>
          <div class="form-hint">Keep it real. Companies want to know who they're hiring.</div>
        </div>
      `;
    } else if (step === 2) {
      stepTitle = 'What can you do?';
      stepDesc = 'Tap all the skills that apply — this is how companies find you';
      stepContent = renderSkillPicker();
    } else if (step === 3) {
      stepTitle = 'Set your rate';
      stepDesc = 'What\'s your hourly pay range?';
      stepContent = `
        <div class="pay-display" id="pay-display">$${state.profile.pay_min ? state.profile.pay_min/100 : 20} - $${state.profile.pay_max ? state.profile.pay_max/100 : 35}/hr</div>
        <div class="pay-range-row">
          <input type="number" id="pay-min" placeholder="20" value="${state.profile.pay_min ? state.profile.pay_min/100 : '20'}" oninput="updatePayDisplay()">
          <span>to</span>
          <input type="number" id="pay-max" placeholder="35" value="${state.profile.pay_max ? state.profile.pay_max/100 : '35'}" oninput="updatePayDisplay()">
          <span>/hr</span>
        </div>
      `;
    } else if (step === 4) {
      stepTitle = 'When are you available?';
      stepDesc = 'Let companies know when you can work';
      const avail = state.profile.availability || 'available_now';
      stepContent = `
        <div>
          ${[
            { val: 'available_now', label: 'Available Now', desc: 'I can start today or tomorrow' },
            { val: 'available_this_week', label: 'Available This Week', desc: 'I have open days this week' },
            { val: 'available_next_week', label: 'Available Next Week', desc: 'I can start next week' },
            { val: 'storm_response', label: 'Storm Response Only', desc: 'Call me when a storm hits' },
            { val: 'not_available', label: 'Not Available Right Now', desc: 'Just setting up my profile' },
          ].map(o => `
            <button class="avail-option ${avail === o.val ? 'selected' : ''}" onclick="selectAvailability('${o.val}')">
              <div class="avail-radio"></div>
              <div>
                <div class="avail-label">${o.label}</div>
                <div class="avail-desc">${o.desc}</div>
              </div>
            </button>
          `).join('')}
        </div>
      `;
    } else if (step === 5) {
      stepTitle = 'Show your work';
      stepDesc = 'Upload up to 6 photos of jobs you\'ve done';
      const photos = state.workPhotos || [];
      stepContent = `
        <div class="photo-grid" id="photo-grid">
          ${photos.map(p => `
            <div class="photo-item">
              <img src="${p.photo_url}" style="width:100%;height:100%;object-fit:cover;border-radius:10px">
              <button class="photo-delete" onclick="deleteWorkPhoto(${p.id})">&times;</button>
            </div>
          `).join('')}
          ${photos.length < 6 ? `
            <div class="photo-item photo-add" onclick="document.getElementById('work-photo-input').click()">
              <div style="font-size:32px;color:var(--gray-400)">+</div>
              <div style="font-size:12px;color:var(--gray-500);margin-top:4px">Add Photo</div>
            </div>
          ` : ''}
        </div>
        <input type="file" id="work-photo-input" accept="image/*" style="display:none" onchange="uploadWorkPhoto(this)">
        <div id="photo-status" style="font-size:13px;color:var(--gray-500);text-align:center;margin-top:12px"></div>
        <div class="form-hint" style="text-align:center;margin-top:8px">Show off removals, hardscape jobs, or anything you're proud of. This is optional — you can always add photos later.</div>
      `;
    }
  } else {
    stepTitle = 'Tell workers about your company';
    stepDesc = 'This helps workers know who they\'re working for';
    stepContent = `
      <div class="form-group">
        <label class="form-label">Company Name</label>
        <input class="form-input" id="biz-name" type="text" value="${state.profile.company_name || state.profile.name || ''}">
      </div>
      <div class="form-group">
        <label class="form-label">Location</label>
        <input class="form-input" id="biz-location" type="text" placeholder="Medway, MA" value="${state.profile.location_text || ''}">
      </div>
      <div class="form-group">
        <label class="form-label">Company Description</label>
        <textarea class="form-input" id="biz-desc" rows="3" placeholder="What does your company do? What kind of work?">${state.profile.company_description || ''}</textarea>
      </div>
      <div class="form-group">
        <label class="form-label">Phone Number (optional)</label>
        <input class="form-input" id="biz-phone" type="tel" placeholder="(508) 555-1234" value="${state.profile.phone || ''}">
      </div>
    `;
  }
  
  app.innerHTML = `
    <div class="profile-builder">
      <div class="profile-builder-header">
        <h1>${stepTitle}</h1>
        <p>${stepDesc}</p>
        ${isWorker ? `
        <div class="profile-steps">
          ${Array.from({length: totalSteps}, (_, i) => `
            <div class="profile-step-dot ${i + 1 < step ? 'done' : ''} ${i + 1 === step ? 'active' : ''}"></div>
          `).join('')}
        </div>
        ` : ''}
      </div>
      <div class="profile-builder-body">
        ${stepContent}
      </div>
      <div class="profile-builder-footer">
        ${(isWorker && step > 1) ? '<button class="btn btn-outline" style="flex:1" onclick="prevProfileStep()">Back</button>' : ''}
        <button class="btn btn-primary" style="flex:2" onclick="nextProfileStep()">
          ${step >= totalSteps ? 'Finish Setup' : 'Next'}
        </button>
      </div>
    </div>
  `;
}

function renderSkillPicker() {
  if (!state.skills.length) return '<div class="spinner"></div>';
  
  const trades = {};
  state.skills.forEach(s => {
    if (!trades[s.trade]) trades[s.trade] = [];
    trades[s.trade].push(s);
  });
  
  return Object.entries(trades).map(([trade, skills]) => `
    <div class="skill-section">
      <div class="skill-section-title">${trade}</div>
      <div class="skill-grid">
        ${skills.map(s => `
          <button class="skill-chip ${state.selectedSkills.has(s.id) ? 'selected' : ''}" onclick="toggleSkill(${s.id})">
            ${s.name}
          </button>
        `).join('')}
      </div>
    </div>
  `).join('');
}

// ============================================
// MAIN APP (after auth + profile)
// ============================================
function renderMain(app) {
  const isBiz = state.profile?.user_type === 'business';
  
  let content = '';
  
  if (isBiz) {
    switch (state.activeTab) {
      case 'search': content = renderWorkerSearch(); break;
      case 'jobs': content = renderMyJobs(); break;
      case 'messages': content = renderMessages(); break;
      case 'storm': content = renderStorm(); break;
      case 'profile': content = renderMyProfile(); break;
    }
  } else {
    switch (state.activeTab) {
      case 'feed': content = renderJobFeed(); break;
      case 'matches': content = renderMatches(); break;
      case 'messages': content = renderMessages(); break;
      case 'profile': content = renderMyProfile(); break;
    }
  }
  
  app.innerHTML = `
    <div class="app-header">
      <div class="app-header-logo">
        <svg width="24" height="24" viewBox="0 0 40 40" fill="none">${icons.logo}</svg>
        <span>CrewFinder</span>
      </div>
      <div class="header-actions">
        <button class="header-btn" onclick="handleLogout()">Log Out</button>
      </div>
    </div>
    <div class="screen">${content}</div>
    ${renderBottomNav(isBiz)}
  `;
}

function renderBottomNav(isBiz) {
  const tabs = isBiz
    ? [
        { id: 'search', label: 'Search', icon: 'search' },
        { id: 'jobs', label: 'My Jobs', icon: 'jobs' },
        { id: 'messages', label: 'Messages', icon: 'messages', badge: state.conversations.some(c => c.unread) },
        { id: 'storm', label: 'Storm', icon: 'storm' },
        { id: 'profile', label: 'Profile', icon: 'profile' },
      ]
    : [
        { id: 'feed', label: 'Jobs', icon: 'feed' },
        { id: 'matches', label: 'Matches', icon: 'heart' },
        { id: 'messages', label: 'Messages', icon: 'messages', badge: state.conversations.some(c => c.unread) },
        { id: 'profile', label: 'Profile', icon: 'profile' },
      ];
  
  return `
    <div class="bottom-nav">
      ${tabs.map(t => `
        <button class="nav-item ${state.activeTab === t.id ? 'active' : ''}" onclick="switchTab('${t.id}')">
          ${icon(t.icon)}
          <span>${t.label}</span>
          ${t.badge ? '<div class="nav-badge"></div>' : ''}
        </button>
      `).join('')}
    </div>
  `;
}

// ============================================
// WORKER SEARCH (Business view)
// ============================================
function renderWorkerSearch() {
  if (state.viewingWorker) return renderWorkerProfile(state.viewingWorker);
  
  const trades = ['All', 'Tree Service', 'Landscaping', 'Hardscaping', 'Irrigation'];
  const filtered = state.workers.filter(w => {
    if (state.tradeFilter && state.tradeFilter !== 'All') {
      const workerSkillIds = (w.worker_skills || []).map(ws => ws.skill_id);
      const tradeSkills = state.skills.filter(s => s.trade === state.tradeFilter).map(s => s.id);
      if (!workerSkillIds.some(id => tradeSkills.includes(id))) return false;
    }
    return true;
  });
  
  return `
    <div class="search-bar">
      <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
      <input placeholder="Search skills, certs, or names..." id="worker-search-input">
    </div>
    <div class="filter-row">
      ${trades.map(t => `
        <button class="filter-chip ${(state.tradeFilter === t || (!state.tradeFilter && t === 'All')) ? 'active' : ''}" onclick="setTradeFilter('${t}')">${t}</button>
      `).join('')}
    </div>
    <div style="padding: 4px 16px 8px; font-size: 13px; color: var(--gray-500);">${filtered.length} workers found</div>
    <div style="padding: 0 16px 16px;">
      ${filtered.length ? filtered.map(w => renderWorkerCard(w)).join('') : `
        <div class="empty-state">
          <div class="empty-state-icon">&#128269;</div>
          <h3>No workers yet</h3>
          <p>Workers will show up here as they create profiles. Share the app to get more workers signed up!</p>
        </div>
      `}
    </div>
  `;
}

function renderWorkerCard(w) {
  const workerSkills = (w.worker_skills || []).map(ws => {
    const skill = state.skills.find(s => s.id === ws.skill_id);
    return skill ? skill.name : '';
  }).filter(Boolean);
  
  const avatarContent = w.avatar_url 
    ? `<img src="${w.avatar_url}" style="width:100%;height:100%;object-fit:cover">`
    : getInitials(w.name);
  const avatarStyle = w.avatar_url 
    ? 'overflow:hidden' 
    : '';
  
  return `
    <div class="worker-card" onclick="viewWorker('${w.id}')">
      <div class="worker-card-row">
        <div class="avatar ${w.availability === 'storm_response' ? 'blue' : ''}" style="${avatarStyle}">${avatarContent}</div>
        <div style="flex:1;min-width:0">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <span class="worker-name">${w.name}</span>
            <span class="worker-dist">${w.location_text || ''}</span>
          </div>
          <div class="rating-row">
            <span class="star">★</span>
            <span class="rating-num">${w.rating_avg || 'New'}</span>
            ${w.rating_count ? `<span class="rating-count">(${w.rating_count} reviews)</span>` : '<span class="rating-count">No reviews yet</span>'}
          </div>
          <div class="worker-pay">${formatPay(w.pay_min, w.pay_max)}</div>
          <div class="badge-wrap">
            <span class="badge badge-avail">${availLabel(w.availability)}</span>
            ${workerSkills.slice(0, 3).map(s => `<span class="badge badge-skill">${s}</span>`).join('')}
            ${workerSkills.length > 3 ? `<span class="badge badge-skill">+${workerSkills.length - 3}</span>` : ''}
          </div>
        </div>
      </div>
    </div>
  `;
}

function renderWorkerProfile(w) {
  const workerSkills = (w.worker_skills || []).map(ws => {
    const skill = state.skills.find(s => s.id === ws.skill_id);
    return skill ? skill.name : '';
  }).filter(Boolean);
  
  const avatarContent = w.avatar_url 
    ? `<img src="${w.avatar_url}" style="width:100%;height:100%;object-fit:cover">`
    : `<span style="color:#fff;font-size:20px;font-weight:700">${getInitials(w.name)}</span>`;
  
  return `
    <div class="profile-view-header">
      <button class="auth-back" onclick="state.viewingWorker=null;render()">&larr; Back</button>
      <div style="display:flex;gap:14px;align-items:center">
        <div style="width:60px;height:60px;border-radius:30px;background:rgba(255,255,255,0.2);display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0">${avatarContent}</div>
        <div>
          <div style="font-size:20px;font-weight:700">${w.name}</div>
          <div style="font-size:13px;opacity:0.8;margin-top:2px">${w.location_text || 'Location not set'}</div>
          <div class="rating-row" style="margin-top:4px">
            <span class="star">★</span>
            <span style="font-weight:600">${w.rating_avg || 'New'}</span>
            ${w.rating_count ? `<span style="opacity:0.8;font-size:13px">(${w.rating_count} reviews)</span>` : ''}
          </div>
        </div>
      </div>
    </div>
    <div style="padding-top:12px">
      <div class="profile-section">
        <div style="display:flex;justify-content:space-between;padding:4px 0"><span class="profile-section-title" style="margin:0">Pay Range</span><span style="font-weight:700;color:var(--green);font-size:16px">${formatPay(w.pay_min, w.pay_max)}</span></div>
        <div style="display:flex;justify-content:space-between;padding:4px 0;margin-top:4px"><span style="font-weight:600;color:var(--forest-mid)">Availability</span><span>${availLabel(w.availability)}</span></div>
      </div>
      ${w.bio ? `
      <div class="profile-section">
        <div class="profile-section-title">About</div>
        <p style="font-size:14px;color:var(--gray-700);line-height:1.5">${w.bio}</p>
      </div>
      ` : ''}
      <div class="profile-section">
        <div class="profile-section-title">Skills</div>
        <div class="badge-wrap">${workerSkills.map(s => `<span class="badge badge-skill">${s}</span>`).join('') || '<span style="color:var(--gray-500);font-size:13px">No skills added yet</span>'}</div>
      </div>
      <div class="profile-section" id="worker-photos-section">
        <div class="profile-section-title">Work Photos</div>
        <div id="worker-photos-grid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px">
          <div style="text-align:center;padding:20px;color:var(--gray-400);font-size:13px;grid-column:1/-1">Loading photos...</div>
        </div>
      </div>
      <div style="padding:0 16px 16px">
        <button class="btn btn-primary" style="margin-bottom:8px" onclick="startChat('${w.id}')">Send Message</button>
        <button class="btn btn-secondary" onclick="saveWorker('${w.id}')">Save to Crew List</button>
      </div>
    </div>
  `;
  // Note: work photos will be loaded async after render
}

// ============================================
// JOB FEED (Worker view)
// ============================================
function renderJobFeed() {
  return `
    <div class="page-padding">
      <div class="page-title">Available Jobs Near You</div>
      <div class="page-sub">Pick up work that fits your schedule</div>
      ${state.jobs.length ? state.jobs.filter(j => j.is_active).map(j => renderJobCard(j)).join('') : `
        <div class="empty-state">
          <div class="empty-state-icon">&#128188;</div>
          <h3>No jobs posted yet</h3>
          <p>Jobs from companies in your area will show up here. Check back soon!</p>
        </div>
      `}
    </div>
  `;
}

function renderJobCard(j) {
  const biz = j.profiles || {};
  const jobSkills = (j.job_skills || []).map(js => {
    const skill = state.skills.find(s => s.id === js.skill_id);
    return skill ? skill.name : '';
  }).filter(Boolean);
  
  return `
    <div class="job-card ${j.is_urgent ? 'urgent' : ''}">
      <div style="display:flex;justify-content:space-between;align-items:flex-start">
        <div>
          <div style="display:flex;align-items:center;gap:6px">
            <span class="job-title">${j.title}</span>
            ${j.is_urgent ? '<span class="badge badge-urgent">Urgent</span>' : ''}
          </div>
          <div class="job-meta">${biz.company_name || biz.name || 'Company'} · ${j.location_text || ''}</div>
        </div>
        <span class="job-pay">${formatPay(j.pay_min, j.pay_max)}</span>
      </div>
      <div class="badge-wrap" style="margin-top:8px">
        <span class="badge badge-trade">${j.job_type === 'on_demand' ? 'On-Demand' : j.job_type === 'short_term' ? 'Short-Term' : j.job_type === 'seasonal' ? 'Seasonal' : 'Storm Response'}</span>
        ${jobSkills.map(s => `<span class="badge badge-skill">${s}</span>`).join('')}
      </div>
      ${j.description ? `<p style="font-size:13px;color:var(--gray-600);margin-top:8px;line-height:1.4">${j.description}</p>` : ''}
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
        <span class="job-posted">Posted ${timeAgo(j.created_at)}</span>
        <button class="btn btn-primary" style="width:auto;padding:8px 20px;font-size:13px" onclick="respondToJob(${j.id})">I'm Interested</button>
      </div>
    </div>
  `;
}

// ============================================
// MY JOBS (Business view)
// ============================================
function renderMyJobs() {
  const myJobs = state.jobs.filter(j => j.business_id === state.user.id);
  
  return `
    <div class="page-padding">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <span class="page-title" style="margin:0">My Job Posts</span>
        <button class="btn btn-primary" style="width:auto;padding:8px 16px;font-size:13px" onclick="showPostJob()">+ Post Job</button>
      </div>
      ${myJobs.length ? myJobs.map(j => renderJobCard(j)).join('') : `
        <div class="empty-state">
          <div class="empty-state-icon">&#128203;</div>
          <h3>No jobs posted yet</h3>
          <p>Post your first job to start finding skilled workers.</p>
        </div>
      `}
    </div>
  `;
}

// ============================================
// MESSAGES
// ============================================
function renderMessages() {
  // If we're in a chat, show the chat view
  if (state.chattingWith) return renderChat();
  
  // Otherwise show conversations list
  return `
    <div class="page-padding">
      <div class="page-title">Messages</div>
    </div>
    <div id="conversations-list">
      ${state.conversations.length ? state.conversations.map(c => `
        <div class="msg-item ${c.unread ? 'unread' : ''}" onclick="openChat('${c.userId}', '${c.name.replace(/'/g, "\\'")}')">
          <div style="display:flex;gap:10px;align-items:center">
            <div class="avatar" style="width:40px;height:40px;border-radius:20px;font-size:13px">${getInitials(c.name)}</div>
            <div style="flex:1;min-width:0">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <span class="msg-name">${c.name}</span>
                <span class="msg-time">${c.time}</span>
              </div>
              <div class="msg-preview">${c.preview}</div>
            </div>
            ${c.unread ? '<div style="width:10px;height:10px;border-radius:5px;background:var(--green);flex-shrink:0"></div>' : ''}
          </div>
        </div>
      `).join('') : `
        <div class="empty-state">
          <div class="empty-state-icon">&#128172;</div>
          <h3>No messages yet</h3>
          <p>${state.profile?.user_type === 'business' ? 'Find a worker and tap "Send Message" to start a conversation.' : 'When a company reaches out, it\'ll show up here.'}</p>
        </div>
      `}
    </div>
  `;
}

function renderChat() {
  const c = state.chattingWith;
  return `
    <div style="display:flex;flex-direction:column;height:100%;">
      <div style="padding:12px 16px;border-bottom:1px solid var(--gray-200);background:var(--white);display:flex;align-items:center;gap:10px;flex-shrink:0">
        <button style="background:none;border:none;font-size:18px;cursor:pointer;padding:4px" onclick="closeChat()">←</button>
        <div class="avatar" style="width:36px;height:36px;border-radius:18px;font-size:12px">${getInitials(c.name)}</div>
        <div>
          <div style="font-weight:700;font-size:14px">${c.name}</div>
          <div style="font-size:11px;color:var(--gray-500)">${c.location || 'CrewFinder'}</div>
        </div>
      </div>
      <div class="chat-messages" id="chat-messages">
        ${state.chatMessages.length ? state.chatMessages.map(m => `
          <div class="chat-bubble ${m.sender_id === state.user.id ? 'sent' : 'received'}">
            ${m.content}
          </div>
          <div style="font-size:10px;color:var(--gray-400);${m.sender_id === state.user.id ? 'text-align:right' : ''};margin-top:-4px;margin-bottom:4px">${timeAgo(m.created_at)}</div>
        `).join('') : `
          <div style="text-align:center;padding:40px 20px;color:var(--gray-400);font-size:13px">
            Start the conversation — say hello!
          </div>
        `}
      </div>
      <div class="chat-input-bar">
        <input id="chat-input" placeholder="Type a message..." onkeydown="if(event.key==='Enter')sendMessage()">
        <button class="chat-send-btn" onclick="sendMessage()">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
        </button>
      </div>
    </div>
  `;
}

// ============================================
// MATCHES (Worker view)
// ============================================
function renderMatches() {
  return `
    <div class="page-padding">
      <div class="page-title">Companies Interested in You</div>
      <div class="empty-state">
        <div class="empty-state-icon">&#10084;&#65039;</div>
        <h3>No matches yet</h3>
        <p>When companies are interested in your profile, they'll show up here. Make sure your skills and availability are up to date!</p>
      </div>
    </div>
  `;
}

// ============================================
// STORM BLAST
// ============================================
function renderStorm() {
  return `
    <div class="storm-header">
      <div class="storm-title">
        ${icon('storm', 24)}
        Storm Response Blast
      </div>
      <p style="font-size:14px;opacity:0.9;line-height:1.5">Instantly notify all available workers in your area. They'll get a push notification and can respond within hours.</p>
    </div>
    <div style="padding:0 16px 16px">
      <div class="form-group">
        <label class="form-label">What do you need?</label>
        <select class="form-select">
          <option>Climber(s) for storm cleanup</option>
          <option>Ground crew for debris removal</option>
          <option>CDL driver with chipper</option>
          <option>Full crew (climber + ground + driver)</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Radius</label>
        <select class="form-select">
          <option>25 miles</option><option>50 miles</option><option>100 miles</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Pay Rate</label>
        <input class="form-input" value="Storm rate: $40-50/hr">
      </div>
      <button class="btn btn-primary" style="background:linear-gradient(135deg,#0D47A1,#1976D2)" onclick="sendStormBlast()">
        Send Storm Blast
      </button>
    </div>
  `;
}

// ============================================
// MY PROFILE
// ============================================
function renderMyProfile() {
  const p = state.profile;
  if (!p) return '<div class="loading-screen"><div class="spinner"></div></div>';
  const isWorker = p.user_type === 'worker';
  
  // Get skills from state.workers if available, otherwise use selectedSkills
  let workerSkills = [];
  if (isWorker) {
    const meInWorkers = state.workers.find(w => w.id === p.id);
    if (meInWorkers && meInWorkers.worker_skills) {
      workerSkills = meInWorkers.worker_skills.map(ws => {
        const skill = state.skills.find(s => s.id === ws.skill_id);
        return skill ? skill.name : '';
      }).filter(Boolean);
    } else {
      // Fallback: use selectedSkills from signup
      workerSkills = Array.from(state.selectedSkills).map(id => {
        const skill = state.skills.find(s => s.id === id);
        return skill ? skill.name : '';
      }).filter(Boolean);
    }
  }
  
  const avatarContent = p.avatar_url 
    ? `<img src="${p.avatar_url}" style="width:100%;height:100%;object-fit:cover">`
    : `<span style="color:#fff;font-size:20px;font-weight:700">${getInitials(p.name)}</span>`;
  
  return `
    <div class="profile-view-header">
      <div style="display:flex;gap:14px;align-items:center">
        <div style="width:60px;height:60px;border-radius:30px;background:rgba(255,255,255,0.2);display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0">${avatarContent}</div>
        <div>
          <div style="font-size:20px;font-weight:700">${isWorker ? p.name : (p.company_name || p.name)}</div>
          <div style="font-size:13px;opacity:0.8;margin-top:2px">${p.location_text || 'Location not set'} · ${isWorker ? 'Worker' : 'Business'}</div>
          <div class="rating-row" style="margin-top:4px">
            <span class="star">★</span>
            <span style="font-weight:600">${isWorker ? (p.rating_avg || 'New') : (p.biz_rating_avg || 'New')}</span>
          </div>
        </div>
      </div>
    </div>
    <div style="padding-top:12px">
      ${isWorker ? `
      <div class="profile-section">
        <div style="display:flex;justify-content:space-between;padding:4px 0"><span style="font-weight:600;color:var(--forest-mid)">Pay Range</span><span style="font-weight:700;color:var(--green)">${formatPay(p.pay_min, p.pay_max)}</span></div>
        <div style="display:flex;justify-content:space-between;padding:4px 0;margin-top:4px"><span style="font-weight:600;color:var(--forest-mid)">Availability</span><span>${availLabel(p.availability)}</span></div>
      </div>
      <div class="profile-section">
        <div class="profile-section-title">Skills</div>
        <div class="badge-wrap">${workerSkills.length ? workerSkills.map(s => `<span class="badge badge-skill">${s}</span>`).join('') : '<span style="color:var(--gray-500);font-size:13px">No skills added yet</span>'}</div>
      </div>
      <div class="profile-section" id="my-photos-section">
        <div class="profile-section-title">Work Photos</div>
        <div id="my-photos-grid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px">
          <div style="text-align:center;padding:12px;color:var(--gray-400);font-size:13px;grid-column:1/-1">Loading...</div>
        </div>
      </div>
      ` : `
      <div class="profile-section">
        <div class="profile-section-title">Subscription</div>
        <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:var(--light-green);border-radius:var(--radius-sm)">
          <div>
            <div style="font-weight:700;color:var(--green)">Free Plan</div>
            <div style="font-size:12px;color:var(--gray-600)">2 active jobs, 5 messages/month</div>
          </div>
          <button class="btn btn-primary" style="width:auto;padding:8px 16px;font-size:12px">Upgrade</button>
        </div>
      </div>
      `}
      <div style="padding:0 16px 16px">
        <button class="btn btn-primary" style="margin-bottom:8px" onclick="editProfile()">Edit Profile</button>
        <button class="btn btn-outline" onclick="handleLogout()">Log Out</button>
      </div>
    </div>
  `;
}

// ============================================
// EVENT HANDLERS
// ============================================
function goTo(screen) {
  state.currentScreen = screen;
  render();
}

function startSignup(type) {
  state.signupType = type;
  state.currentScreen = 'signup';
  render();
}

function switchTab(tab) {
  state.activeTab = tab;
  state.viewingWorker = null;
  state.viewingJob = null;
  state.chattingWith = null;
  render();
  
  // Load work photos for my profile
  if (tab === 'profile' && state.profile?.user_type === 'worker') {
    loadMyPhotos();
  }
}

async function loadMyPhotos() {
  const { data: photos } = await db.from('work_photos').select('*').eq('worker_id', state.user.id).order('created_at');
  const grid = document.getElementById('my-photos-grid');
  if (grid) {
    if (photos && photos.length > 0) {
      grid.innerHTML = photos.map(p => `
        <div style="aspect-ratio:1;border-radius:8px;overflow:hidden">
          <img src="${p.photo_url}" style="width:100%;height:100%;object-fit:cover">
        </div>
      `).join('');
    } else {
      grid.innerHTML = '<div style="text-align:center;padding:12px;color:var(--gray-400);font-size:13px;grid-column:1/-1">No work photos yet — add them in Edit Profile</div>';
    }
  }
}

function setTradeFilter(trade) {
  state.tradeFilter = trade === 'All' ? '' : trade;
  render();
}

function toggleSkill(skillId) {
  if (state.selectedSkills.has(skillId)) {
    state.selectedSkills.delete(skillId);
  } else {
    state.selectedSkills.add(skillId);
  }
  // Re-render just the skill chips without full re-render
  $$('.skill-chip').forEach(chip => {
    const id = parseInt(chip.getAttribute('onclick').match(/\d+/)[0]);
    chip.classList.toggle('selected', state.selectedSkills.has(id));
  });
}

function selectAvailability(val) {
  state.profile.availability = val;
  render();
}

function updatePayDisplay() {
  const min = $('#pay-min')?.value || 0;
  const max = $('#pay-max')?.value || 0;
  const display = $('#pay-display');
  if (display) {
    display.textContent = `$${min} - $${max}/hr`;
  }
}

async function viewWorker(id) {
  state.viewingWorker = state.workers.find(w => w.id === id);
  render();
  
  // Load work photos async
  const { data: photos } = await db.from('work_photos').select('*').eq('worker_id', id).order('created_at');
  const grid = document.getElementById('worker-photos-grid');
  if (grid) {
    if (photos && photos.length > 0) {
      grid.innerHTML = photos.map(p => `
        <div style="aspect-ratio:1;border-radius:8px;overflow:hidden">
          <img src="${p.photo_url}" style="width:100%;height:100%;object-fit:cover;cursor:pointer" onclick="window.open('${p.photo_url}','_blank')">
        </div>
      `).join('');
    } else {
      grid.innerHTML = '<div style="text-align:center;padding:12px;color:var(--gray-400);font-size:13px;grid-column:1/-1">No work photos yet</div>';
    }
  }
}

function showPostJob() {
  // Simple job posting - we'll enhance this later
  const title = prompt('Job title (e.g. "Climber Needed Tomorrow"):');
  if (!title) return;
  const pay = prompt('Pay range (e.g. "$30-35"):');
  const desc = prompt('Quick description:');
  postJob(title, pay, desc);
}

async function startChat(userId) {
  // Look up the user's name
  const target = state.workers.find(w => w.id === userId);
  const name = target?.name || target?.company_name || 'User';
  const location = target?.location_text || '';
  openChat(userId, name, location);
}

async function openChat(userId, name, location) {
  // Build conversation ID (sorted pair so it's always the same)
  const ids = [state.user.id, userId].sort();
  const conversationId = ids.join('_');
  
  state.chattingWith = { userId, name, location: location || '', conversationId };
  state.chatMessages = [];
  
  render();
  
  // Load existing messages
  const { data: messages } = await db
    .from('messages')
    .select('*')
    .eq('conversation_id', conversationId)
    .order('created_at', { ascending: true });
  
  state.chatMessages = messages || [];
  render();
  scrollChatToBottom();
  
  // Mark messages as read
  await db
    .from('messages')
    .update({ is_read: true })
    .eq('conversation_id', conversationId)
    .eq('receiver_id', state.user.id)
    .eq('is_read', false);
  
  // Subscribe to new messages in real-time
  if (state.chatSubscription) {
    state.chatSubscription.unsubscribe();
  }
  
  state.chatSubscription = db
    .channel('chat_' + conversationId)
    .on('postgres_changes', {
      event: 'INSERT',
      schema: 'public',
      table: 'messages',
      filter: 'conversation_id=eq.' + conversationId,
    }, (payload) => {
      // Only add if we don't already have it
      if (!state.chatMessages.find(m => m.id === payload.new.id)) {
        state.chatMessages.push(payload.new);
        render();
        scrollChatToBottom();
        // Mark as read if we're the receiver
        if (payload.new.receiver_id === state.user.id) {
          db.from('messages').update({ is_read: true }).eq('id', payload.new.id);
        }
      }
    })
    .subscribe();
}

function closeChat() {
  if (state.chatSubscription) {
    state.chatSubscription.unsubscribe();
    state.chatSubscription = null;
  }
  state.chattingWith = null;
  state.chatMessages = [];
  // Reload conversations
  loadConversations();
  render();
}

async function sendMessage() {
  const input = document.getElementById('chat-input');
  const content = input?.value?.trim();
  if (!content || !state.chattingWith) return;
  
  input.value = '';
  
  const msg = {
    conversation_id: state.chattingWith.conversationId,
    sender_id: state.user.id,
    receiver_id: state.chattingWith.userId,
    content: content,
  };
  
  // Optimistic add
  const optimistic = { ...msg, id: Date.now(), created_at: new Date().toISOString(), is_read: false };
  state.chatMessages.push(optimistic);
  render();
  scrollChatToBottom();
  
  // Focus input again
  setTimeout(() => document.getElementById('chat-input')?.focus(), 50);
  
  // Actually send
  const { error } = await db.from('messages').insert(msg);
  if (error) {
    showToast('Failed to send message');
    state.chatMessages.pop();
    render();
  }
}

function scrollChatToBottom() {
  setTimeout(() => {
    const el = document.getElementById('chat-messages');
    if (el) el.scrollTop = el.scrollHeight;
  }, 50);
}

async function loadConversations() {
  // Get all messages where user is sender or receiver
  const { data: messages } = await db
    .from('messages')
    .select('*')
    .or(`sender_id.eq.${state.user.id},receiver_id.eq.${state.user.id}`)
    .order('created_at', { ascending: false });
  
  if (!messages || !messages.length) {
    state.conversations = [];
    return;
  }
  
  // Group by conversation
  const convos = {};
  messages.forEach(m => {
    if (!convos[m.conversation_id]) {
      convos[m.conversation_id] = {
        conversationId: m.conversation_id,
        lastMessage: m,
        unreadCount: 0,
        otherUserId: m.sender_id === state.user.id ? m.receiver_id : m.sender_id,
      };
    }
    if (!m.is_read && m.receiver_id === state.user.id) {
      convos[m.conversation_id].unreadCount++;
    }
  });
  
  // Look up names for each conversation
  const otherIds = [...new Set(Object.values(convos).map(c => c.otherUserId))];
  const { data: profiles } = await db
    .from('profiles')
    .select('id, name, company_name, user_type, location_text')
    .in('id', otherIds);
  
  const profileMap = {};
  (profiles || []).forEach(p => { profileMap[p.id] = p; });
  
  state.conversations = Object.values(convos).map(c => {
    const other = profileMap[c.otherUserId] || {};
    const displayName = other.user_type === 'business' ? (other.company_name || other.name) : other.name;
    return {
      userId: c.otherUserId,
      name: displayName || 'Unknown',
      location: other.location_text || '',
      preview: c.lastMessage.content,
      time: timeAgo(c.lastMessage.created_at),
      unread: c.unreadCount > 0,
    };
  });
}

async function saveWorker(userId) {
  try {
    await db.from('saved_workers').insert({
      business_id: state.user.id,
      worker_id: userId,
    });
    showToast('Worker saved to your crew list!');
  } catch (e) {
    showToast('Already saved!');
  }
}

async function respondToJob(jobId) {
  try {
    await db.from('job_responses').insert({
      job_id: jobId,
      worker_id: state.user.id,
    });
    showToast("Interest sent! The company can see your profile now.");
  } catch (e) {
    showToast("You've already responded to this job.");
  }
}

function sendStormBlast() {
  showToast('Storm blast sent! Workers will be notified.');
}

// ============================================
// AUTH HANDLERS
// ============================================
async function handleSignup() {
  const name = $('#signup-name')?.value?.trim();
  const email = $('#signup-email')?.value?.trim();
  const password = $('#signup-password')?.value;
  const location = $('#signup-location')?.value?.trim();
  const company = $('#signup-company')?.value?.trim();
  const errorEl = $('#signup-error');
  
  if (!name || !email || !password) {
    errorEl.textContent = 'Please fill in all required fields.';
    errorEl.classList.add('show');
    return;
  }
  
  if (password.length < 6) {
    errorEl.textContent = 'Password must be at least 6 characters.';
    errorEl.classList.add('show');
    return;
  }
  
  const btn = $('#signup-btn');
  btn.disabled = true;
  btn.textContent = 'Creating account...';
  
  try {
    const { data, error } = await db.auth.signUp({
      email,
      password,
      options: {
        data: {
          name: name,
          user_type: state.signupType,
        }
      }
    });
    
    if (error) throw error;
    
    // Create profile
    const { error: profileError } = await db.from('profiles').insert({
      id: data.user.id,
      user_type: state.signupType,
      name: name,
      email: email,
      location_text: location,
      company_name: state.signupType === 'business' ? (company || name) : null,
    });
    
    if (profileError) throw profileError;
    
    state.user = data.user;
    state.profile = {
      id: data.user.id,
      user_type: state.signupType,
      name,
      email,
      location_text: location,
      company_name: company,
      availability: 'available_now',
    };
    
    // Load skills for worker
    if (state.signupType === 'worker') {
      await loadSkills();
    }
    
    state.profileStep = 1;
    state.currentScreen = 'profile-builder';
    render();
    
  } catch (e) {
    errorEl.textContent = e.message || 'Something went wrong. Please try again.';
    errorEl.classList.add('show');
    btn.disabled = false;
    btn.textContent = state.signupType === 'worker' ? 'Create Account' : 'Create Business Account';
  }
}

async function handleLogin() {
  const email = $('#login-email')?.value?.trim();
  const password = $('#login-password')?.value;
  const errorEl = $('#login-error');
  
  if (!email || !password) {
    errorEl.textContent = 'Please enter your email and password.';
    errorEl.classList.add('show');
    return;
  }
  
  const btn = $('#login-btn');
  btn.disabled = true;
  btn.textContent = 'Logging in...';
  
  try {
    const { data, error } = await db.auth.signInWithPassword({ email, password });
    if (error) throw error;
    
    state.user = data.user;
    await loadProfile();
    await loadSkills();
    await loadData();
    
    state.activeTab = state.profile?.user_type === 'business' ? 'search' : 'feed';
    state.currentScreen = 'main';
    render();
    
  } catch (e) {
    errorEl.textContent = e.message || 'Invalid email or password.';
    errorEl.classList.add('show');
    btn.disabled = false;
    btn.textContent = 'Log In';
  }
}

async function handleLogout() {
  await db.auth.signOut();
  state.user = null;
  state.profile = null;
  state.currentScreen = 'splash';
  render();
}

// ============================================
// PROFILE BUILDER STEPS
// ============================================
async function nextProfileStep() {
  const isWorker = state.profile?.user_type === 'worker';
  const totalSteps = isWorker ? 5 : 1;
  
  if (isWorker && state.profileStep === 1) {
    // Save basic info
    const name = $('#edit-name')?.value?.trim() || state.profile.name;
    const location = $('#edit-location')?.value?.trim();
    const bio = $('#edit-bio')?.value?.trim();
    await db.from('profiles').update({ 
      name: name,
      location_text: location, 
      bio: bio 
    }).eq('id', state.user.id);
    state.profile.name = name;
    state.profile.location_text = location;
    state.profile.bio = bio;
    
  } else if (isWorker && state.profileStep === 2) {
    // Save skills
    if (state.selectedSkills.size === 0) {
      showToast('Select at least one skill!');
      return;
    }
    
    const skills = Array.from(state.selectedSkills).map(skillId => ({
      worker_id: state.user.id,
      skill_id: skillId,
    }));
    
    await db.from('worker_skills').delete().eq('worker_id', state.user.id);
    await db.from('worker_skills').insert(skills);
    
  } else if (isWorker && state.profileStep === 3) {
    // Save pay
    const min = parseInt($('#pay-min')?.value || 20) * 100;
    const max = parseInt($('#pay-max')?.value || 35) * 100;
    await db.from('profiles').update({ pay_min: min, pay_max: max }).eq('id', state.user.id);
    state.profile.pay_min = min;
    state.profile.pay_max = max;
    
  } else if (isWorker && state.profileStep === 4) {
    // Save availability
    await db.from('profiles').update({ availability: state.profile.availability }).eq('id', state.user.id);
    
    // Pre-load work photos for step 5
    const { data: photos } = await db.from('work_photos').select('*').eq('worker_id', state.user.id).order('created_at');
    state.workPhotos = photos || [];
    
  } else if (isWorker && state.profileStep === 5) {
    // Work photos step — nothing to save, photos are uploaded individually
  }
  
  if (!isWorker) {
    // Save business details
    const companyName = $('#biz-name')?.value?.trim();
    const location = $('#biz-location')?.value?.trim();
    const desc = $('#biz-desc')?.value?.trim();
    const phone = $('#biz-phone')?.value?.trim();
    await db.from('profiles').update({
      company_name: companyName,
      location_text: location,
      company_description: desc,
      phone: phone,
    }).eq('id', state.user.id);
    state.profile.company_name = companyName;
    state.profile.location_text = location;
    state.profile.company_description = desc;
    state.profile.phone = phone;
  }
  
  if (state.profileStep >= totalSteps) {
    // Done! Go to main app
    await loadData();
    state.activeTab = isWorker ? 'feed' : 'search';
    state.currentScreen = 'main';
    showToast('Profile set up! You\'re ready to go.');
  } else {
    state.profileStep++;
  }
  
  render();
}

function prevProfileStep() {
  if (state.profileStep > 1) {
    state.profileStep--;
    render();
  }
}

// ============================================
// JOB POSTING
// ============================================
async function postJob(title, pay, desc) {
  const payParts = pay?.match(/(\d+)/g) || [25, 35];
  const { error } = await db.from('jobs').insert({
    business_id: state.user.id,
    title,
    description: desc,
    pay_min: parseInt(payParts[0] || 25) * 100,
    pay_max: parseInt(payParts[1] || payParts[0] || 35) * 100,
    job_type: 'on_demand',
    location_text: state.profile?.location_text,
    is_urgent: true,
    is_active: true,
  });
  
  if (error) {
    showToast('Error posting job: ' + error.message);
  } else {
    showToast('Job posted! Workers will be able to see it.');
    await loadData();
    render();
  }
}

// ============================================
// PHOTO UPLOADS
// ============================================
async function uploadAvatar(input) {
  const file = input.files[0];
  if (!file) return;
  
  const status = document.getElementById('avatar-status');
  if (status) status.textContent = 'Uploading...';
  
  try {
    const ext = file.name.split('.').pop();
    const path = `${state.user.id}/avatar.${ext}`;
    
    const { error: uploadError } = await db.storage
      .from('avatars')
      .upload(path, file, { upsert: true });
    
    if (uploadError) throw uploadError;
    
    const { data: { publicUrl } } = db.storage.from('avatars').getPublicUrl(path);
    
    // Add cache buster
    const url = publicUrl + '?t=' + Date.now();
    
    await db.from('profiles').update({ avatar_url: url }).eq('id', state.user.id);
    state.profile.avatar_url = url;
    
    if (status) status.textContent = 'Photo updated!';
    
    // Update preview
    const preview = document.getElementById('avatar-preview');
    if (preview) preview.innerHTML = `<img src="${url}" style="width:100%;height:100%;object-fit:cover">`;
    
  } catch (e) {
    console.error('Avatar upload error:', e);
    if (status) status.textContent = 'Upload failed — try again';
    showToast('Photo upload failed: ' + (e.message || 'Unknown error'));
  }
}

async function uploadWorkPhoto(input) {
  const file = input.files[0];
  if (!file) return;
  
  const status = document.getElementById('photo-status');
  if (status) status.textContent = 'Uploading...';
  
  try {
    const ext = file.name.split('.').pop();
    const path = `${state.user.id}/${Date.now()}.${ext}`;
    
    const { error: uploadError } = await db.storage
      .from('work-photos')
      .upload(path, file);
    
    if (uploadError) throw uploadError;
    
    const { data: { publicUrl } } = db.storage.from('work-photos').getPublicUrl(path);
    
    // Save to work_photos table
    const { data: photo, error: dbError } = await db.from('work_photos').insert({
      worker_id: state.user.id,
      photo_url: publicUrl,
    }).select().single();
    
    if (dbError) throw dbError;
    
    if (!state.workPhotos) state.workPhotos = [];
    state.workPhotos.push(photo);
    
    if (status) status.textContent = 'Photo added!';
    render();
    
  } catch (e) {
    console.error('Work photo upload error:', e);
    if (status) status.textContent = 'Upload failed — try again';
    showToast('Photo upload failed: ' + (e.message || 'Unknown error'));
  }
}

async function deleteWorkPhoto(photoId) {
  const photo = (state.workPhotos || []).find(p => p.id === photoId);
  if (!photo) return;
  
  await db.from('work_photos').delete().eq('id', photoId);
  state.workPhotos = (state.workPhotos || []).filter(p => p.id !== photoId);
  
  showToast('Photo removed');
  render();
}

async function editProfile() {
  // Load current skills into selectedSkills
  const { data: mySkills } = await db.from('worker_skills').select('skill_id').eq('worker_id', state.user.id);
  state.selectedSkills = new Set((mySkills || []).map(s => s.skill_id));
  // Load work photos
  const { data: photos } = await db.from('work_photos').select('*').eq('worker_id', state.user.id).order('created_at');
  state.workPhotos = photos || [];
  // Reload profile to get latest data
  await loadProfile();
  state.profileStep = 1;
  state.currentScreen = 'profile-builder';
  render();
}

// ============================================
// DATA LOADING
// ============================================
async function loadSkills() {
  const { data } = await db.from('skills').select('*').order('sort_order');
  state.skills = data || [];
}

async function loadProfile() {
  const { data } = await db.from('profiles').select('*').eq('id', state.user.id).single();
  state.profile = data;
}

async function loadData() {
  // Load workers (with their skills)
  const { data: workers } = await db
    .from('profiles')
    .select('*, worker_skills(*)')
    .eq('user_type', 'worker')
    .order('rating_avg', { ascending: false });
  state.workers = workers || [];
  
  // Load jobs (with business info and skills)
  const { data: jobs } = await db
    .from('jobs')
    .select('*, profiles!business_id(name, company_name), job_skills(*)')
    .eq('is_active', true)
    .order('created_at', { ascending: false });
  state.jobs = jobs || [];
  
  // Load conversations
  await loadConversations();
}

// ============================================
// INIT
// ============================================
async function init() {
  try {
    const { data: { session } } = await db.auth.getSession();
    
    if (session?.user) {
      state.user = session.user;
      await loadSkills();
      
      const { data: profile } = await db.from('profiles').select('*').eq('id', state.user.id).single();
      
      if (profile) {
        state.profile = profile;
        await loadData();
        state.activeTab = profile.user_type === 'business' ? 'search' : 'feed';
        state.currentScreen = 'main';
        
        // Subscribe to incoming messages globally
        db.channel('global_messages_' + state.user.id)
          .on('postgres_changes', {
            event: 'INSERT',
            schema: 'public',
            table: 'messages',
            filter: 'receiver_id=eq.' + state.user.id,
          }, (payload) => {
            // Refresh conversations if we're not in the chat with this person
            if (!state.chattingWith || state.chattingWith.conversationId !== payload.new.conversation_id) {
              loadConversations().then(() => render());
              showToast('New message received!');
            }
          })
          .subscribe();
      } else {
        await db.auth.signOut();
        state.currentScreen = 'splash';
      }
    } else {
      state.currentScreen = 'splash';
    }
  } catch (e) {
    console.error('Init error:', e);
    try { await db.auth.signOut(); } catch (_) {}
    state.currentScreen = 'splash';
  }
  
  render();
}

// Listen for auth changes
db.auth.onAuthStateChange((event, session) => {
  if (event === 'SIGNED_OUT') {
    state.user = null;
    state.profile = null;
    state.currentScreen = 'splash';
    render();
  }
});

// Start the app
init();
</script>
</body>
</html>
