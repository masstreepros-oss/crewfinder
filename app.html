<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#1A3C2A">
<link rel="apple-touch-icon" href="/icon-192.png">
<title>CrewFinder</title>
<link rel="manifest" href="manifest.json">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
/* ============================================
   CSS RESET & VARIABLES
   ============================================ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --forest: #0B1F14;
  --forest-mid: #1A3C2A;
  --green: #2D7A3A;
  --lime: #5CB85C;
  --light-green: #D4EDDA;
  --pale-green: #F0FAF0;
  --blue: #1565C0;
  --light-blue: #E3F2FD;
  --amber: #D4900E;
  --red: #C62828;
  --light-red: #FFEBEE;
  --orange: #E65100;
  --light-orange: #FFF3E0;
  --purple: #6A1B9A;
  --light-purple: #F3E5F5;
  --white: #FFFFFF;
  --gray-50: #FAFAFA;
  --gray-100: #F5F5F5;
  --gray-200: #E8E8E8;
  --gray-300: #DDD;
  --gray-400: #BBB;
  --gray-500: #888;
  --gray-600: #666;
  --gray-700: #444;
  --gray-800: #333;
  --dark: #1A1A1A;
  --radius: 12px;
  --radius-sm: 8px;
  --radius-lg: 16px;
  --shadow: 0 1px 3px rgba(0,0,0,0.06);
  --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
}

body {
  font-family: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--gray-100);
  color: var(--dark);
  line-height: 1.5;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
}

#app {
  max-width: 430px;
  margin: 0 auto;
  min-height: 100vh;
  min-height: 100dvh;
  background: var(--gray-100);
  position: relative;
  display: flex;
  flex-direction: column;
}

@media (min-width: 431px) {
  body { background: #E0E0E0; display: flex; justify-content: center; padding: 20px 0; }
  #app { border-radius: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.15); overflow: hidden; height: 90vh; }
  #app > * { overflow-y: auto; }
}

/* ============================================
   UTILITY CLASSES
   ============================================ */
.hidden { display: none !important; }

.screen {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

/* ============================================
   SPLASH / WELCOME SCREEN
   ============================================ */
.splash {
  flex: 1;
  background: linear-gradient(170deg, #050D09 0%, var(--forest) 30%, var(--forest-mid) 70%, var(--green) 100%);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 32px 24px;
  position: relative;
  overflow: hidden;
}

.splash::before {
  content: '';
  position: absolute;
  top: -40%; right: -40%;
  width: 80%; height: 120%;
  background: radial-gradient(ellipse, rgba(92,184,92,0.1) 0%, transparent 70%);
}

.splash-logo { display: flex; align-items: center; gap: 10px; position: relative; margin-bottom: 8px; }
.splash-logo span { color: #fff; font-size: 30px; font-weight: 800; letter-spacing: -1px; }
.splash-sub { color: rgba(255,255,255,0.6); font-size: 15px; position: relative; margin-bottom: 48px; }

.splash-btn {
  width: 100%; max-width: 300px;
  padding: 18px 20px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,0.18);
  background: rgba(255,255,255,0.08);
  cursor: pointer;
  text-align: left;
  margin-bottom: 12px;
  transition: all 0.2s;
  position: relative;
  backdrop-filter: blur(8px);
  font-family: inherit;
}

.splash-btn:active { transform: scale(0.98); background: rgba(255,255,255,0.15); }
.splash-btn-title { color: #fff; font-weight: 700; font-size: 16px; }
.splash-btn-desc { color: rgba(255,255,255,0.55); font-size: 13px; margin-top: 3px; }

.splash-link {
  color: rgba(255,255,255,0.5);
  font-size: 13px;
  margin-top: 24px;
  position: relative;
  cursor: pointer;
  background: none;
  border: none;
  font-family: inherit;
  text-decoration: underline;
}

/* ============================================
   AUTH SCREENS (Sign Up / Log In)
   ============================================ */
.auth-screen {
  flex: 1;
  background: var(--white);
  display: flex;
  flex-direction: column;
}

.auth-header {
  background: linear-gradient(135deg, var(--forest), var(--green));
  padding: 20px 20px 28px;
  color: #fff;
}

.auth-back {
  background: rgba(255,255,255,0.15);
  border: none;
  color: #fff;
  padding: 6px 14px;
  border-radius: var(--radius-sm);
  cursor: pointer;
  font-size: 13px;
  font-family: inherit;
  margin-bottom: 16px;
}

.auth-header h1 { font-size: 24px; font-weight: 800; }
.auth-header p { font-size: 14px; opacity: 0.8; margin-top: 4px; }

.auth-form { padding: 24px 20px; flex: 1; }

.form-group { margin-bottom: 16px; }

.form-label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  color: var(--gray-800);
  margin-bottom: 6px;
}

.form-input {
  width: 100%;
  padding: 12px 14px;
  border-radius: var(--radius-sm);
  border: 1.5px solid var(--gray-300);
  font-size: 15px;
  font-family: inherit;
  outline: none;
  transition: border-color 0.2s;
  background: var(--white);
}

.form-input:focus { border-color: var(--green); }

.form-input::placeholder { color: var(--gray-400); }

.form-select {
  width: 100%;
  padding: 12px 14px;
  border-radius: var(--radius-sm);
  border: 1.5px solid var(--gray-300);
  font-size: 15px;
  font-family: inherit;
  outline: none;
  background: var(--white);
  cursor: pointer;
  -webkit-appearance: none;
}

.form-hint { font-size: 12px; color: var(--gray-500); margin-top: 4px; }

.btn {
  width: 100%;
  padding: 14px;
  border-radius: var(--radius);
  font-weight: 700;
  font-size: 15px;
  cursor: pointer;
  font-family: inherit;
  border: none;
  transition: all 0.2s;
}

.btn-primary {
  background: linear-gradient(135deg, var(--forest-mid), var(--green));
  color: var(--white);
}

.btn-primary:active { transform: scale(0.98); }
.btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

.btn-secondary {
  background: var(--white);
  color: var(--green);
  border: 2px solid var(--green);
}

.btn-outline {
  background: transparent;
  color: var(--green);
  border: 1.5px solid var(--gray-300);
}

.auth-footer {
  text-align: center;
  padding: 16px 20px 24px;
  font-size: 14px;
  color: var(--gray-500);
}

.auth-footer a, .auth-footer button {
  color: var(--green);
  font-weight: 600;
  text-decoration: none;
  cursor: pointer;
  background: none;
  border: none;
  font-family: inherit;
  font-size: 14px;
}

.form-error {
  background: var(--light-red);
  color: var(--red);
  padding: 10px 14px;
  border-radius: var(--radius-sm);
  font-size: 13px;
  font-weight: 500;
  margin-bottom: 16px;
  display: none;
}

.form-error.show { display: block; }

.form-success {
  background: var(--light-green);
  color: var(--green);
  padding: 10px 14px;
  border-radius: var(--radius-sm);
  font-size: 13px;
  font-weight: 500;
  margin-bottom: 16px;
  display: none;
}

.form-success.show { display: block; }

/* ============================================
   HEADER
   ============================================ */
.app-header {
  background: var(--white);
  padding: 12px 16px;
  border-bottom: 1px solid var(--gray-200);
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 100;
}

.app-header-logo { display: flex; align-items: center; gap: 8px; }
.app-header-logo span { font-weight: 800; font-size: 18px; color: var(--forest-mid); letter-spacing: -0.3px; }

.header-actions { display: flex; align-items: center; gap: 8px; }

.header-btn {
  background: none;
  border: 1px solid var(--gray-300);
  border-radius: var(--radius-sm);
  padding: 5px 10px;
  font-size: 11px;
  color: var(--gray-500);
  cursor: pointer;
  font-family: inherit;
}

/* ============================================
   BOTTOM NAV
   ============================================ */
.bottom-nav {
  background: var(--white);
  border-top: 1px solid var(--gray-200);
  display: flex;
  justify-content: space-around;
  padding: 6px 0 max(10px, env(safe-area-inset-bottom));
  position: sticky;
  bottom: 0;
  z-index: 100;
}

.nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
  background: none;
  border: none;
  cursor: pointer;
  padding: 4px 10px;
  color: var(--gray-400);
  transition: color 0.2s;
  position: relative;
  font-family: inherit;
}

.nav-item.active { color: var(--green); }
.nav-item svg { width: 22px; height: 22px; }
.nav-item span { font-size: 10px; font-weight: 500; }
.nav-item.active span { font-weight: 700; }

.nav-badge {
  position: absolute;
  top: 0; right: 4px;
  width: 8px; height: 8px;
  background: var(--red);
  border-radius: 50%;
}

/* ============================================
   PROFILE BUILDER
   ============================================ */
.profile-builder {
  flex: 1;
  display: flex;
  flex-direction: column;
  height: 100%;
  overflow: hidden;
}

.profile-builder-header {
  background: linear-gradient(135deg, var(--forest), var(--green));
  padding: 20px 20px 24px;
  color: #fff;
  flex-shrink: 0;
}

.profile-builder-header h1 { font-size: 22px; font-weight: 800; }
.profile-builder-header p { font-size: 14px; opacity: 0.8; margin-top: 4px; }

.profile-steps {
  display: flex;
  gap: 4px;
  margin-top: 16px;
}

.profile-step-dot {
  height: 4px;
  flex: 1;
  border-radius: 2px;
  background: rgba(255,255,255,0.2);
  transition: background 0.3s;
}

.profile-step-dot.active { background: var(--lime); }
.profile-step-dot.done { background: rgba(255,255,255,0.6); }

.profile-builder-body {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

.profile-builder-footer {
  padding: 12px 20px 24px;
  display: flex;
  gap: 10px;
  flex-shrink: 0;
  background: var(--white);
  border-top: 1px solid var(--gray-200);
}

/* ============================================
   SKILL PICKER
   ============================================ */
.skill-section { margin-bottom: 20px; }

.skill-section-title {
  font-size: 14px;
  font-weight: 700;
  color: var(--forest-mid);
  margin-bottom: 10px;
  padding-bottom: 6px;
  border-bottom: 2px solid var(--light-green);
}

.skill-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}

.skill-chip {
  padding: 8px 14px;
  border-radius: 24px;
  font-size: 13px;
  font-weight: 500;
  border: 1.5px solid var(--gray-300);
  background: var(--white);
  color: var(--gray-700);
  cursor: pointer;
  transition: all 0.15s;
  font-family: inherit;
  user-select: none;
  -webkit-user-select: none;
}

.skill-chip:active { transform: scale(0.96); }

.skill-chip.selected {
  border-color: var(--green);
  background: var(--light-green);
  color: var(--green);
  font-weight: 600;
}

.skill-chip.selected::before {
  content: '‚úì ';
  font-size: 11px;
}

/* ============================================
   AVAILABILITY PICKER
   ============================================ */
.avail-option {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px 16px;
  border-radius: var(--radius);
  border: 1.5px solid var(--gray-300);
  background: var(--white);
  margin-bottom: 8px;
  cursor: pointer;
  transition: all 0.15s;
  font-family: inherit;
}

.avail-option:active { transform: scale(0.99); }

.avail-option.selected {
  border-color: var(--green);
  background: var(--pale-green);
}

.avail-radio {
  width: 20px; height: 20px;
  border-radius: 50%;
  border: 2px solid var(--gray-400);
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.15s;
}

.avail-option.selected .avail-radio {
  border-color: var(--green);
  background: var(--green);
}

.avail-option.selected .avail-radio::after {
  content: '';
  width: 8px; height: 8px;
  border-radius: 50%;
  background: var(--white);
}

.avail-label { font-weight: 600; font-size: 14px; }
.avail-desc { font-size: 12px; color: var(--gray-500); margin-top: 1px; }

/* ============================================
   PAY RANGE SLIDER
   ============================================ */
.pay-display {
  text-align: center;
  font-size: 28px;
  font-weight: 800;
  color: var(--green);
  margin: 16px 0;
}

.pay-range-row {
  display: flex;
  gap: 12px;
  align-items: center;
}

.pay-range-row input {
  flex: 1;
  padding: 12px 14px;
  border-radius: var(--radius-sm);
  border: 1.5px solid var(--gray-300);
  font-size: 16px;
  font-family: inherit;
  text-align: center;
  outline: none;
  font-weight: 600;
}

.pay-range-row input:focus { border-color: var(--green); }
.pay-range-row span { color: var(--gray-500); font-weight: 600; }

/* ============================================
   CARDS
   ============================================ */
.card {
  background: var(--white);
  border-radius: var(--radius);
  padding: 16px;
  margin-bottom: 10px;
  border: 1px solid var(--gray-200);
  box-shadow: var(--shadow);
}

/* ============================================
   BADGE
   ============================================ */
.badge {
  display: inline-block;
  padding: 3px 10px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 600;
  white-space: nowrap;
}

.badge-skill { background: var(--light-green); color: var(--green); border: 1px solid #C8E6C9; }
.badge-cert { background: var(--light-orange); color: var(--orange); border: 1px solid #FFE0B2; }
.badge-urgent { background: var(--light-red); color: var(--red); border: 1px solid #FFCDD2; }
.badge-storm { background: var(--light-blue); color: var(--blue); border: 1px solid #BBDEFB; }
.badge-trade { background: var(--light-purple); color: var(--purple); border: 1px solid #E1BEE7; }
.badge-avail { background: #E8F5E9; color: #2E7D32; border: 1px solid #C8E6C9; }

/* ============================================
   WORKER CARD (in search results)
   ============================================ */
.worker-card {
  background: var(--white);
  border-radius: var(--radius);
  padding: 14px;
  margin-bottom: 10px;
  border: 1px solid var(--gray-200);
  box-shadow: var(--shadow);
  cursor: pointer;
  transition: all 0.15s;
}

.worker-card:active { transform: scale(0.99); background: var(--gray-50); }

.worker-card-row { display: flex; gap: 12px; align-items: flex-start; }

.avatar {
  width: 46px; height: 46px;
  border-radius: 23px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #fff;
  font-weight: 700;
  font-size: 15px;
  flex-shrink: 0;
  background: linear-gradient(135deg, var(--forest-mid), var(--green));
}

.avatar.blue { background: linear-gradient(135deg, #1565C0, #42A5F5); }

.worker-name { font-weight: 700; font-size: 15px; color: var(--dark); }
.worker-dist { font-size: 12px; color: var(--gray-500); }

.rating-row { display: flex; align-items: center; gap: 3px; margin: 2px 0; }
.star { color: var(--amber); font-size: 13px; }
.rating-num { font-size: 13px; font-weight: 600; color: var(--gray-800); }
.rating-count { font-size: 12px; color: var(--gray-500); }

.worker-pay { font-size: 13px; font-weight: 600; color: var(--green); margin: 2px 0; }

.badge-wrap { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px; }

/* ============================================
   JOB CARD
   ============================================ */
.job-card {
  background: var(--white);
  border-radius: var(--radius);
  padding: 14px;
  margin-bottom: 10px;
  border: 1px solid var(--gray-200);
  box-shadow: var(--shadow);
  cursor: pointer;
  transition: all 0.15s;
}

.job-card.urgent { border-color: #FFCDD2; }
.job-card:active { transform: scale(0.99); }

.job-title { font-weight: 700; font-size: 15px; color: var(--dark); }
.job-meta { font-size: 13px; color: var(--gray-600); margin-top: 2px; }
.job-pay { font-weight: 700; color: var(--green); font-size: 14px; white-space: nowrap; }
.job-posted { font-size: 12px; color: var(--gray-500); margin-top: 8px; }

/* ============================================
   SEARCH / FILTER BAR
   ============================================ */
.search-bar {
  padding: 12px 16px 8px;
  position: relative;
}

.search-bar input {
  width: 100%;
  padding: 10px 12px 10px 38px;
  border-radius: var(--radius);
  border: 1.5px solid var(--gray-300);
  font-size: 14px;
  font-family: inherit;
  outline: none;
  background: var(--white);
}

.search-bar input:focus { border-color: var(--green); }

.search-bar svg {
  position: absolute;
  left: 28px; top: 22px;
  color: var(--gray-400);
}

.filter-row {
  display: flex;
  gap: 8px;
  padding: 4px 16px 8px;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

.filter-row::-webkit-scrollbar { display: none; }

.filter-chip {
  padding: 6px 14px;
  border-radius: 20px;
  border: 1.5px solid var(--gray-300);
  background: var(--white);
  color: var(--gray-600);
  font-weight: 600;
  font-size: 12px;
  cursor: pointer;
  white-space: nowrap;
  font-family: inherit;
  transition: all 0.15s;
}

.filter-chip.active {
  border-color: var(--green);
  background: var(--light-green);
  color: var(--green);
}

/* ============================================
   MESSAGE THREAD
   ============================================ */
.msg-item {
  padding: 14px 16px;
  border-bottom: 1px solid var(--gray-200);
  cursor: pointer;
  transition: background 0.15s;
}

.msg-item:active { background: var(--gray-50); }
.msg-item.unread { background: var(--pale-green); }

.msg-name { font-weight: 700; font-size: 14px; }
.msg-time { font-size: 11px; color: var(--gray-500); }
.msg-preview { font-size: 13px; color: var(--gray-600); margin-top: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

/* ============================================
   CHAT
   ============================================ */
.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.chat-bubble {
  max-width: 80%;
  padding: 10px 14px;
  border-radius: 16px;
  font-size: 14px;
  line-height: 1.4;
}

.chat-bubble.sent {
  background: var(--green);
  color: var(--white);
  align-self: flex-end;
  border-bottom-right-radius: 4px;
}

.chat-bubble.received {
  background: var(--white);
  color: var(--dark);
  align-self: flex-start;
  border-bottom-left-radius: 4px;
  border: 1px solid var(--gray-200);
}

.chat-input-bar {
  display: flex;
  gap: 8px;
  padding: 10px 16px;
  border-top: 1px solid var(--gray-200);
  background: var(--white);
}

.chat-input-bar input {
  flex: 1;
  padding: 10px 14px;
  border-radius: 24px;
  border: 1.5px solid var(--gray-300);
  font-size: 14px;
  font-family: inherit;
  outline: none;
}

.chat-input-bar input:focus { border-color: var(--green); }

.chat-send-btn {
  width: 40px; height: 40px;
  border-radius: 20px;
  background: var(--green);
  border: none;
  color: var(--white);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

/* ============================================
   LOADING / SPINNER
   ============================================ */
.spinner {
  width: 24px; height: 24px;
  border: 3px solid var(--gray-300);
  border-top-color: var(--green);
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
  margin: 0 auto;
}

@keyframes spin { to { transform: rotate(360deg); } }

.loading-screen {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 16px;
  color: var(--gray-500);
  font-size: 14px;
}

/* ============================================
   PROFILE VIEW
   ============================================ */
.profile-view-header {
  background: linear-gradient(135deg, var(--forest), var(--green));
  padding: 16px 16px 24px;
  color: #fff;
}

.profile-section {
  background: var(--white);
  border-radius: var(--radius);
  padding: 16px;
  margin: 0 16px 10px;
  border: 1px solid var(--gray-200);
}

.profile-section-title {
  font-weight: 700;
  color: var(--forest-mid);
  margin-bottom: 8px;
  font-size: 14px;
}

/* ============================================
   STORM BLAST
   ============================================ */
.storm-header {
  background: linear-gradient(135deg, #0D47A1, #1976D2);
  border-radius: var(--radius-lg);
  padding: 20px;
  color: #fff;
  margin: 16px;
}

.storm-title {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 10px;
}

/* ============================================
   PHOTO GRID
   ============================================ */
.photo-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
}

.photo-item {
  aspect-ratio: 1;
  border-radius: 10px;
  overflow: hidden;
  position: relative;
}

.photo-add {
  border: 2px dashed var(--gray-300);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.15s;
  background: var(--white);
}

.photo-add:active { background: var(--gray-100); }

.photo-delete {
  position: absolute;
  top: 4px;
  right: 4px;
  width: 24px;
  height: 24px;
  border-radius: 12px;
  background: rgba(0,0,0,0.6);
  color: #fff;
  border: none;
  font-size: 16px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  line-height: 1;
}

/* ============================================
   TOAST NOTIFICATION
   ============================================ */
.toast {
  position: fixed;
  bottom: 80px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--dark);
  color: var(--white);
  padding: 12px 24px;
  border-radius: var(--radius);
  font-size: 14px;
  font-weight: 500;
  z-index: 9999;
  max-width: 90%;
  text-align: center;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}

.toast.show {
  opacity: 1;
  pointer-events: auto;
}

/* ============================================
   INSTALL BANNER
   ============================================ */
.install-banner {
  position: fixed;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 100%;
  max-width: 430px;
  background: var(--white);
  border-top: 1px solid var(--gray-200);
  padding: 16px 20px max(16px, env(safe-area-inset-bottom));
  z-index: 200;
  box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
  display: none;
}

.install-banner.show { display: block; }

.install-banner-content {
  display: flex;
  align-items: center;
  gap: 12px;
}

.install-banner-icon {
  width: 44px;
  height: 44px;
  border-radius: 10px;
  background: linear-gradient(135deg, var(--forest-mid), var(--green));
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.install-banner-text { flex: 1; }
.install-banner-text strong { font-size: 14px; display: block; }
.install-banner-text span { font-size: 12px; color: var(--gray-500); }

.install-banner-actions { display: flex; gap: 8px; margin-top: 12px; }

.install-banner .btn { font-size: 13px; padding: 10px; }

/* ============================================
   PAGE-LEVEL STYLES
   ============================================ */
.page-padding { padding: 16px; }
.page-title { font-weight: 700; font-size: 17px; color: var(--forest-mid); margin-bottom: 4px; }
.page-sub { font-size: 13px; color: var(--gray-500); margin-bottom: 12px; }
.section-gap { height: 16px; }

.empty-state {
  text-align: center;
  padding: 40px 20px;
  color: var(--gray-500);
}

.empty-state-icon { font-size: 48px; margin-bottom: 12px; }
.empty-state h3 { font-size: 17px; font-weight: 700; color: var(--gray-700); margin-bottom: 6px; }
.empty-state p { font-size: 14px; line-height: 1.5; }
</style>
</head>
<body>

<div id="app">
  <!-- All screens render here via JS -->
  <div class="loading-screen" id="loading-screen">
    <div class="spinner"></div>
    <span>Loading CrewFinder...</span>
  </div>
</div>

<div class="toast" id="toast" style="opacity:0;pointer-events:none"></div>

<script>
// ============================================
// SUPABASE INIT
// ============================================
const SUPABASE_URL = 'https://mhatwlmbwikvrlcgfojt.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1oYXR3bG1id2lrdnJsY2dmb2p0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzNDUzMTQsImV4cCI6MjA4NjkyMTMxNH0.8LefO4aYzYGfmsUb4blBEBLjIoF4CtYJ7xfimdc7lBE';
const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ============================================
// APP STATE
// ============================================
let state = {
  user: null,
  profile: null,
  skills: [],
  selectedSkills: new Set(),
  activeTab: 'search',
  currentScreen: 'loading', // loading, splash, signup, login, profile-builder, main
  profileStep: 1,
  signupType: null, // 'worker' or 'business'
  tradeFilter: '',
  workers: [],
  jobs: [],
  conversations: [],
  viewingWorker: null,
  viewingJob: null,
  chattingWith: null,
  chatMessages: [],
  chatSubscription: null,
  workPhotos: [],
  showResetPassword: false,
  businesses: [],
  viewingCompany: null,
  viewingCompanyReviews: [],
  viewingJobDetail: null,
  jobResponses: {},
  myJobStatuses: [],
  selectedRating: 0,
  crewRoster: [],
};

// ============================================
// UTILITY FUNCTIONS
// ============================================
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => document.querySelectorAll(sel);

let toastTimer = null;
function showToast(msg) {
  const t = document.getElementById('toast');
  if (!t) return;
  if (toastTimer) {
    clearTimeout(toastTimer);
    toastTimer = null;
  }
  t.textContent = msg;
  t.style.opacity = '1';
  t.style.pointerEvents = 'auto';
  toastTimer = setTimeout(() => {
    t.style.opacity = '0';
    t.style.pointerEvents = 'none';
    toastTimer = null;
  }, 2500);
}

function getInitials(name) {
  if (!name) return '??';
  return name.split(' ').map(w => w[0]).join('').toUpperCase().slice(0, 2);
}

function formatPay(min, max, payType) {
  const fmin = min ? '$' + (min / 100) : '';
  const fmax = max ? '$' + (max / 100) : '';
  const suffix = payType === 'day_rate' ? '/day' : '/hr';
  if (fmin && fmax) return `${fmin}-${fmax}${suffix}`;
  if (fmin) return `${fmin}+${suffix}`;
  if (fmax) return `Up to ${fmax}${suffix}`;
  return 'Negotiable';
}

function timeAgo(date) {
  const seconds = Math.floor((new Date() - new Date(date)) / 1000);
  if (seconds < 60) return 'just now';
  const mins = Math.floor(seconds / 60);
  if (mins < 60) return `${mins}m ago`;
  const hours = Math.floor(mins / 60);
  if (hours < 24) return `${hours}h ago`;
  const days = Math.floor(hours / 24);
  return `${days}d ago`;
}

function availLabel(avail) {
  const map = {
    'available_now': 'Available Now',
    'available_this_week': 'Available This Week',
    'available_next_week': 'Available Next Week',
    'storm_response': 'Storm Response',
    'not_available': 'Not Available',
  };
  return map[avail] || avail || 'Not Set';
}

// ============================================
// SVG ICONS
// ============================================
const icons = {
  search: '<path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>',
  jobs: '<path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>',
  messages: '<path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>',
  storm: '<path d="M13 10V3L4 14h7v7l9-11h-7z"/>',
  profile: '<path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>',
  feed: '<path d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>',
  heart: '<path d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>',
  send: '<path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>',
  logo: '<rect width="40" height="40" rx="10" fill="#1A3C2A"/><path d="M20 8L12 16h5v8h6v-8h5L20 8z" fill="#5CB85C"/><path d="M14 28h12M16 32h8" stroke="#5CB85C" stroke-width="2" stroke-linecap="round"/>',
};

function icon(name, size = 22) {
  return `<svg width="${size}" height="${size}" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">${icons[name]}</svg>`;
}

// ============================================
// RENDER ENGINE
// ============================================
function render() {
  const app = $('#app');
  
  switch (state.currentScreen) {
    case 'loading':
      app.innerHTML = `<div class="loading-screen"><div class="spinner"></div><span>Loading CrewFinder...</span></div>`;
      break;
    case 'splash':
      renderSplash(app);
      break;
    case 'signup':
      renderSignup(app);
      break;
    case 'login':
      renderLogin(app);
      break;
    case 'profile-builder':
      renderProfileBuilder(app);
      break;
    case 'main':
      renderMain(app);
      break;
  }
}

// ============================================
// SPLASH SCREEN
// ============================================
function renderSplash(app) {
  app.innerHTML = `
    <div class="splash">
      <div class="splash-logo">
        <svg width="34" height="34" viewBox="0 0 40 40" fill="none">
          <rect width="40" height="40" rx="10" fill="rgba(255,255,255,0.12)"/>
          <path d="M20 8L12 16h5v8h6v-8h5L20 8z" fill="#5CB85C"/>
          <path d="M14 28h12M16 32h8" stroke="#5CB85C" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <span>CrewFinder</span>
      </div>
      <p class="splash-sub">On-demand skilled labor for outdoor trades</p>
      <button class="splash-btn" onclick="startSignup('business')">
        <div class="splash-btn-title">I Need a Worker</div>
        <div class="splash-btn-desc">Find skilled help for tomorrow's job</div>
      </button>
      <button class="splash-btn" onclick="startSignup('worker')">
        <div class="splash-btn-title">I Need Work</div>
        <div class="splash-btn-desc">Pick up jobs and fill your schedule</div>
      </button>
      <button class="splash-link" onclick="goTo('login')">Already have an account? Log in</button>
    </div>
  `;
}

// ============================================
// SIGN UP
// ============================================
function renderSignup(app) {
  const isWorker = state.signupType === 'worker';
  app.innerHTML = `
    <div class="auth-screen">
      <div class="auth-header">
        <button class="auth-back" onclick="goTo('splash')">&larr; Back</button>
        <h1>${isWorker ? 'Create Your Profile' : 'Set Up Your Business'}</h1>
        <p>${isWorker ? 'Get found by companies that need your skills' : 'Start finding skilled workers today'}</p>
      </div>
      <div class="auth-form">
        <div class="form-error" id="signup-error"></div>
        <div class="form-group">
          <label class="form-label">${isWorker ? 'Your Full Name' : 'Your Name'}</label>
          <input class="form-input" id="signup-name" type="text" placeholder="${isWorker ? 'Marcus Rivera' : 'John Smith'}">
        </div>
        ${!isWorker ? `
        <div class="form-group">
          <label class="form-label">Company Name</label>
          <input class="form-input" id="signup-company" type="text" placeholder="Mass Tree Pros">
        </div>
        ` : ''}
        <div class="form-group">
          <label class="form-label">Email</label>
          <input class="form-input" id="signup-email" type="email" placeholder="you@email.com">
        </div>
        <div class="form-group">
          <label class="form-label">Password</label>
          <input class="form-input" id="signup-password" type="password" placeholder="At least 6 characters">
        </div>
        <div class="form-group">
          <label class="form-label">Location</label>
          <input class="form-input" id="signup-location" type="text" placeholder="Medway, MA">
        </div>
        <button class="btn btn-primary" id="signup-btn" onclick="handleSignup()">
          ${isWorker ? 'Create Account' : 'Create Business Account'}
        </button>
      </div>
      <div class="auth-footer">
        Already have an account? <button onclick="goTo('login')">Log in</button>
      </div>
    </div>
  `;
}

// ============================================
// LOG IN
// ============================================
function renderLogin(app) {
  if (state.showResetPassword) {
    app.innerHTML = `
      <div class="auth-screen">
        <div class="auth-header">
          <button class="auth-back" onclick="state.showResetPassword=false;render()">&larr; Back</button>
          <h1>Reset Password</h1>
          <p>We'll send you a link to reset your password</p>
        </div>
        <div class="auth-form">
          <div class="form-error" id="reset-error"></div>
          <div class="form-success" id="reset-success"></div>
          <div class="form-group">
            <label class="form-label">Email</label>
            <input class="form-input" id="reset-email" type="email" placeholder="you@email.com">
          </div>
          <button class="btn btn-primary" id="reset-btn" onclick="handleResetPassword()">Send Reset Link</button>
        </div>
        <div class="auth-footer">
          Remember your password? <button onclick="state.showResetPassword=false;render()">Log in</button>
        </div>
      </div>
    `;
    return;
  }
  
  app.innerHTML = `
    <div class="auth-screen">
      <div class="auth-header">
        <button class="auth-back" onclick="goTo('splash')">&larr; Back</button>
        <h1>Welcome Back</h1>
        <p>Log in to your CrewFinder account</p>
      </div>
      <div class="auth-form">
        <div class="form-error" id="login-error"></div>
        <div class="form-group">
          <label class="form-label">Email</label>
          <input class="form-input" id="login-email" type="email" placeholder="you@email.com">
        </div>
        <div class="form-group">
          <label class="form-label">Password</label>
          <input class="form-input" id="login-password" type="password" placeholder="Your password">
        </div>
        <div style="text-align:right;margin-bottom:16px">
          <button style="background:none;border:none;color:var(--green);font-size:13px;font-weight:600;cursor:pointer;font-family:inherit" onclick="state.showResetPassword=true;render()">Forgot password?</button>
        </div>
        <button class="btn btn-primary" id="login-btn" onclick="handleLogin()">Log In</button>
      </div>
      <div class="auth-footer">
        Don't have an account? <button onclick="goTo('splash')">Sign up</button>
      </div>
    </div>
  `;
}

// ============================================
// PROFILE BUILDER (worker skills / biz details)
// ============================================
function renderProfileBuilder(app) {
  const isWorker = state.profile?.user_type === 'worker';
  const step = state.profileStep;
  const totalSteps = isWorker ? 6 : 1;
  
  let stepContent = '';
  let stepTitle = '';
  let stepDesc = '';
  
  if (isWorker) {
    if (step === 1) {
      stepTitle = 'Basic Info';
      stepDesc = 'Your name, photo, and location';
      const avatarUrl = state.profile.avatar_url || '';
      stepContent = `
        <div class="card" style="display:flex;flex-direction:column;align-items:center;padding:20px;margin-bottom:16px">
          <div id="avatar-preview" style="width:90px;height:90px;border-radius:45px;background:linear-gradient(135deg,var(--forest-mid),var(--green));display:flex;align-items:center;justify-content:center;overflow:hidden;margin-bottom:10px;cursor:pointer;border:3px solid var(--gray-200)" onclick="document.getElementById('avatar-input').click()">
            ${avatarUrl ? `<img src="${avatarUrl}" style="width:100%;height:100%;object-fit:cover">` : `<span style="color:#fff;font-size:30px;font-weight:700">${getInitials(state.profile.name)}</span>`}
          </div>
          <input type="file" id="avatar-input" accept="image/*" style="display:none" onchange="uploadAvatar(this)">
          <button class="btn btn-outline" style="width:auto;padding:8px 20px;font-size:13px" onclick="document.getElementById('avatar-input').click()">
            ${avatarUrl ? 'üì∑ Change Photo' : 'üì∑ Add Profile Photo'}
          </button>
          <div id="avatar-status" style="font-size:12px;color:var(--gray-500);margin-top:6px"></div>
        </div>
        <div class="form-group">
          <label class="form-label">Your Name</label>
          <input class="form-input" id="edit-name" type="text" value="${state.profile.name || ''}">
        </div>
        <div class="form-group">
          <label class="form-label">Location</label>
          <input class="form-input" id="edit-location" type="text" placeholder="Medway, MA" value="${state.profile.location_text || ''}">
          <div class="form-hint">City and state ‚Äî this is how companies find workers near them</div>
        </div>
        <div class="form-group">
          <label class="form-label">About Me</label>
          <textarea class="form-input" id="edit-bio" rows="4" placeholder="Tell companies about yourself ‚Äî your experience, what you're good at, what kind of work you're looking for...">${state.profile.bio || ''}</textarea>
          <div class="form-hint">Keep it real. Companies want to know who they're hiring.</div>
        </div>
      `;
    } else if (step === 2) {
      stepTitle = 'What can you do?';
      stepDesc = 'Tap all the skills that apply ‚Äî this is how companies find you';
      stepContent = renderSkillPicker();
    } else if (step === 3) {
      stepTitle = 'Set your rate';
      stepDesc = 'What do you charge?';
      const payType = state.profile.pay_type || 'hourly';
      const suffix = payType === 'day_rate' ? '/day' : '/hr';
      const minDefault = payType === 'day_rate' ? 250 : 20;
      const maxDefault = payType === 'day_rate' ? 400 : 35;
      stepContent = `
        <div style="display:flex;gap:6px;margin-bottom:16px">
          <button class="filter-chip ${payType === 'hourly' ? 'active' : ''}" onclick="state.profile.pay_type='hourly';render()">Hourly Rate</button>
          <button class="filter-chip ${payType === 'day_rate' ? 'active' : ''}" onclick="state.profile.pay_type='day_rate';render()">Flat Day Rate</button>
        </div>
        <div class="pay-display" id="pay-display">$${state.profile.pay_min ? state.profile.pay_min/100 : minDefault} - $${state.profile.pay_max ? state.profile.pay_max/100 : maxDefault}${suffix}</div>
        <div class="pay-range-row">
          <input type="number" id="pay-min" placeholder="${minDefault}" value="${state.profile.pay_min ? state.profile.pay_min/100 : minDefault}" oninput="updatePayDisplay()">
          <span>to</span>
          <input type="number" id="pay-max" placeholder="${maxDefault}" value="${state.profile.pay_max ? state.profile.pay_max/100 : maxDefault}" oninput="updatePayDisplay()">
          <span>${suffix}</span>
        </div>
        ${payType === 'day_rate' ? '<div class="form-hint" style="text-align:center;margin-top:10px">Hours negotiable with the company for each job</div>' : ''}
      `;
    } else if (step === 4) {
      stepTitle = 'When are you available?';
      stepDesc = 'Let companies know when you can work';
      const avail = state.profile.availability || 'available_now';
      stepContent = `
        <div>
          ${[
            { val: 'available_now', label: 'Available Now', desc: 'I can start today or tomorrow' },
            { val: 'available_this_week', label: 'Available This Week', desc: 'I have open days this week' },
            { val: 'available_next_week', label: 'Available Next Week', desc: 'I can start next week' },
            { val: 'storm_response', label: 'Storm Response Only', desc: 'Call me when a storm hits' },
            { val: 'not_available', label: 'Not Available Right Now', desc: 'Just setting up my profile' },
          ].map(o => `
            <button class="avail-option ${avail === o.val ? 'selected' : ''}" onclick="selectAvailability('${o.val}')">
              <div class="avail-radio"></div>
              <div>
                <div class="avail-label">${o.label}</div>
                <div class="avail-desc">${o.desc}</div>
              </div>
            </button>
          `).join('')}
        </div>
      `;
    } else if (step === 5) {
      stepTitle = 'Show your work';
      stepDesc = 'Upload up to 6 photos of jobs you\'ve done';
      const photos = state.workPhotos || [];
      stepContent = `
        <div class="photo-grid" id="photo-grid">
          ${photos.map(p => `
            <div class="photo-item">
              <img src="${p.photo_url}" style="width:100%;height:100%;object-fit:cover;border-radius:10px">
              <button class="photo-delete" onclick="deleteWorkPhoto(${p.id})">&times;</button>
            </div>
          `).join('')}
          ${photos.length < 6 ? `
            <div class="photo-item photo-add" onclick="document.getElementById('work-photo-input').click()">
              <div style="font-size:32px;color:var(--gray-400)">+</div>
              <div style="font-size:12px;color:var(--gray-500);margin-top:4px">Add Photo</div>
            </div>
          ` : ''}
        </div>
        <input type="file" id="work-photo-input" accept="image/*" style="display:none" onchange="uploadWorkPhoto(this)">
        <div id="photo-status" style="font-size:13px;color:var(--gray-500);text-align:center;margin-top:12px"></div>
        <div class="form-hint" style="text-align:center;margin-top:8px">Show off removals, hardscape jobs, or anything you're proud of. This is optional ‚Äî you can always add photos later.</div>
      `;
    } else if (step === 6) {
      stepTitle = 'Liability Insurance';
      stepDesc = 'Optional ‚Äî upload proof of insurance to stand out';
      const hasDoc = state.profile.insurance_doc_url;
      stepContent = `
        <div class="card" style="text-align:center;padding:24px">
          <div style="font-size:40px;margin-bottom:12px">${hasDoc ? '‚úÖ' : 'üõ°Ô∏è'}</div>
          <div style="font-weight:700;font-size:16px;margin-bottom:4px">${hasDoc ? 'Insurance Document Uploaded' : 'Do you carry liability insurance?'}</div>
          <div style="font-size:13px;color:var(--gray-500);margin-bottom:16px;line-height:1.5">${hasDoc ? 'Companies can see you\'re insured ‚Äî this gives you a big advantage.' : 'Workers with their own insurance are in high demand. Upload your COI (Certificate of Insurance) and companies will see a verified badge on your profile.'}</div>
          ${hasDoc ? `
            <div style="display:flex;gap:8px;justify-content:center;margin-bottom:12px">
              <a href="${state.profile.insurance_doc_url}" target="_blank" style="color:var(--green);font-weight:600;font-size:13px">View Document</a>
              <span style="color:var(--gray-300)">¬∑</span>
              <button style="background:none;border:none;color:var(--red);font-weight:600;font-size:13px;cursor:pointer;font-family:inherit" onclick="removeInsurance()">Remove</button>
            </div>
          ` : ''}
          <button class="btn ${hasDoc ? 'btn-outline' : 'btn-primary'}" onclick="document.getElementById('insurance-input').click()">
            ${hasDoc ? 'Replace Document' : 'Upload Insurance Document'}
          </button>
          <input type="file" id="insurance-input" accept="image/*,.pdf" style="display:none" onchange="uploadInsurance(this)">
          <div id="insurance-status" style="font-size:12px;color:var(--gray-500);margin-top:8px"></div>
        </div>
        ${state.profile.insurance_doc_url ? `
        <div class="form-group" style="margin-top:16px">
          <label class="form-label">Expiration Date (optional)</label>
          <input class="form-input" id="insurance-expiry" type="text" placeholder="e.g. 12/2025 or Dec 2025" value="${state.profile.insurance_expiry || ''}">
          <div class="form-hint">Helps companies know your coverage is current</div>
        </div>
        ` : ''}
        <div class="form-hint" style="text-align:center;margin-top:12px">This is completely optional. You can skip this and add it later.</div>
      `;
    }
  } else {
    stepTitle = 'Tell workers about your company';
    stepDesc = 'This helps workers know who they\'re working for';
    const bizAvatarUrl = state.profile.avatar_url;
    const bizPhotos = state.workPhotos || [];
    stepContent = `
      <div style="display:flex;flex-direction:column;align-items:center;margin-bottom:20px">
        <div id="avatar-preview" style="width:80px;height:80px;border-radius:40px;background:linear-gradient(135deg,var(--forest-mid),var(--green));display:flex;align-items:center;justify-content:center;overflow:hidden;margin-bottom:10px;cursor:pointer" onclick="document.getElementById('avatar-input').click()">
          ${bizAvatarUrl ? `<img src="${bizAvatarUrl}" style="width:100%;height:100%;object-fit:cover">` : `<span style="color:#fff;font-size:28px;font-weight:700">${getInitials(state.profile.company_name || state.profile.name)}</span>`}
        </div>
        <input type="file" id="avatar-input" accept="image/*" style="display:none" onchange="uploadAvatar(this)">
        <button style="background:none;border:none;color:var(--green);font-weight:600;font-size:13px;cursor:pointer;font-family:inherit" onclick="document.getElementById('avatar-input').click()">
          ${bizAvatarUrl ? 'Change Logo' : 'Add Company Logo'}
        </button>
        <div id="avatar-status" style="font-size:12px;color:var(--gray-500);margin-top:4px"></div>
      </div>
      <div class="form-group">
        <label class="form-label">Company Name</label>
        <input class="form-input" id="biz-name" type="text" value="${state.profile.company_name || state.profile.name || ''}">
      </div>
      <div class="form-group">
        <label class="form-label">Location</label>
        <input class="form-input" id="biz-location" type="text" placeholder="Medway, MA" value="${state.profile.location_text || ''}">
      </div>
      <div class="form-group">
        <label class="form-label">Company Description</label>
        <textarea class="form-input" id="biz-desc" rows="3" placeholder="What does your company do? What kind of work?">${state.profile.company_description || ''}</textarea>
      </div>
      <div class="form-group">
        <label class="form-label">Phone Number (optional)</label>
        <input class="form-input" id="biz-phone" type="tel" placeholder="(508) 555-1234" value="${state.profile.phone || ''}">
      </div>
      <div class="form-group">
        <label class="form-label">Company Photos (optional)</label>
        <div class="form-hint" style="margin-bottom:8px">Show off your crew, trucks, or completed jobs ‚Äî up to 6 photos</div>
        <div class="photo-grid" id="photo-grid">
          ${bizPhotos.map(p => `
            <div class="photo-item">
              <img src="${p.photo_url}" style="width:100%;height:100%;object-fit:cover;border-radius:10px">
              <button class="photo-delete" onclick="deleteWorkPhoto(${p.id})">&times;</button>
            </div>
          `).join('')}
          ${bizPhotos.length < 6 ? `
            <div class="photo-item photo-add" onclick="document.getElementById('work-photo-input').click()">
              <div style="font-size:32px;color:var(--gray-400)">+</div>
              <div style="font-size:12px;color:var(--gray-500);margin-top:4px">Add Photo</div>
            </div>
          ` : ''}
        </div>
        <input type="file" id="work-photo-input" accept="image/*" style="display:none" onchange="uploadWorkPhoto(this)">
        <div id="photo-status" style="font-size:13px;color:var(--gray-500);text-align:center;margin-top:8px"></div>
      </div>
    `;
  }
  
  app.innerHTML = `
    <div class="profile-builder">
      <div class="profile-builder-header">
        <h1>${stepTitle}</h1>
        <p>${stepDesc}</p>
        ${isWorker ? `
        <div class="profile-steps">
          ${Array.from({length: totalSteps}, (_, i) => `
            <div class="profile-step-dot ${i + 1 < step ? 'done' : ''} ${i + 1 === step ? 'active' : ''}"></div>
          `).join('')}
        </div>
        ` : ''}
      </div>
      <div class="profile-builder-body">
        ${stepContent}
      </div>
      <div class="profile-builder-footer">
        ${(isWorker && step > 1) ? '<button class="btn btn-outline" style="flex:1" onclick="prevProfileStep()">Back</button>' : ''}
        <button class="btn btn-primary" id="next-step-btn" style="flex:2" onclick="handleNextStep(this)">
          ${step >= totalSteps ? 'Finish Setup' : 'Next'}
        </button>
      </div>
    </div>
  `;
}

// Prevent double-tap and handle step advancement
async function handleNextStep(btn) {
  if (btn.disabled) return;
  btn.disabled = true;
  btn.textContent = 'Saving...';
  try {
    await nextProfileStep();
  } catch (e) {
    console.error('Step error:', e);
    // Force advance anyway
    state.profileStep++;
    render();
  }
  // Re-enable in case render didn't happen
  setTimeout(() => {
    const b = document.getElementById('next-step-btn');
    if (b) { b.disabled = false; b.textContent = 'Next'; }
  }, 500);
}

function renderSkillPicker() {
  if (!state.skills.length) return '<div class="spinner"></div>';
  
  const trades = {};
  state.skills.forEach(s => {
    if (!trades[s.trade]) trades[s.trade] = [];
    trades[s.trade].push(s);
  });
  
  return Object.entries(trades).map(([trade, skills]) => `
    <div class="skill-section">
      <div class="skill-section-title">${trade}</div>
      <div class="skill-grid">
        ${skills.map(s => `
          <button class="skill-chip ${state.selectedSkills.has(s.id) ? 'selected' : ''}" onclick="toggleSkill(${s.id})">
            ${s.name}
          </button>
        `).join('')}
      </div>
    </div>
  `).join('');
}

// ============================================
// MAIN APP (after auth + profile)
// ============================================
function renderMain(app) {
  const isBiz = state.profile?.user_type === 'business';
  
  let content = '';
  
  if (isBiz) {
    switch (state.activeTab) {
      case 'search': content = renderWorkerSearch(); break;
      case 'jobs': content = renderMyJobs(); break;
      case 'post-job': content = renderPostJob(); break;
      case 'messages': content = renderMessages(); break;
      case 'crew': content = renderCrewRoster(); break;
      case 'profile': content = renderMyProfile(); break;
    }
  } else {
    switch (state.activeTab) {
      case 'feed': content = renderJobFeed(); break;
      case 'companies': content = renderCompanies(); break;
      case 'messages': content = renderMessages(); break;
      case 'profile': content = renderMyProfile(); break;
    }
  }
  
  app.innerHTML = `
    <div class="app-header">
      <div class="app-header-logo">
        <svg width="24" height="24" viewBox="0 0 40 40" fill="none">${icons.logo}</svg>
        <span>CrewFinder</span>
      </div>
      <div class="header-actions">
        <button class="header-btn" onclick="handleLogout()">Log Out</button>
      </div>
    </div>
    <div class="screen">${content}</div>
    ${renderBottomNav(isBiz)}
  `;
}

function renderBottomNav(isBiz) {
  const tabs = isBiz
    ? [
        { id: 'search', label: 'Search', icon: 'search' },
        { id: 'jobs', label: 'My Jobs', icon: 'jobs' },
        { id: 'messages', label: 'Messages', icon: 'messages', badge: state.conversations.some(c => c.unread) },
        { id: 'crew', label: 'My Crew', icon: 'heart' },
        { id: 'profile', label: 'Profile', icon: 'profile' },
      ]
    : [
        { id: 'feed', label: 'Jobs', icon: 'feed' },
        { id: 'companies', label: 'Companies', icon: 'search' },
        { id: 'messages', label: 'Messages', icon: 'messages', badge: state.conversations.some(c => c.unread) },
        { id: 'profile', label: 'Profile', icon: 'profile' },
      ];
  
  return `
    <div class="bottom-nav">
      ${tabs.map(t => `
        <button class="nav-item ${state.activeTab === t.id ? 'active' : ''}" onclick="switchTab('${t.id}')">
          ${icon(t.icon)}
          <span>${t.label}</span>
          ${t.badge ? '<div class="nav-badge"></div>' : ''}
        </button>
      `).join('')}
    </div>
  `;
}

// ============================================
// WORKER SEARCH (Business view)
// ============================================
function renderWorkerSearch() {
  if (state.viewingWorker) return renderWorkerProfile(state.viewingWorker);
  
  const trades = ['All', 'Tree Service', 'Landscaping', 'Hardscaping', 'Irrigation'];
  const filtered = state.workers.filter(w => {
    if (state.tradeFilter && state.tradeFilter !== 'All') {
      const workerSkillIds = (w.worker_skills || []).map(ws => ws.skill_id);
      const tradeSkills = state.skills.filter(s => s.trade === state.tradeFilter).map(s => s.id);
      if (!workerSkillIds.some(id => tradeSkills.includes(id))) return false;
    }
    return true;
  });
  
  return `
    <div class="search-bar">
      <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
      <input placeholder="Search skills, certs, or names..." id="worker-search-input">
    </div>
    <div class="filter-row">
      ${trades.map(t => `
        <button class="filter-chip ${(state.tradeFilter === t || (!state.tradeFilter && t === 'All')) ? 'active' : ''}" onclick="setTradeFilter('${t}')">${t}</button>
      `).join('')}
    </div>
    <div style="padding: 4px 16px 8px; font-size: 13px; color: var(--gray-500);">${filtered.length} workers found</div>
    <div style="padding: 0 16px 16px;">
      ${filtered.length ? filtered.map(w => renderWorkerCard(w)).join('') : `
        <div class="empty-state">
          <div class="empty-state-icon">&#128269;</div>
          <h3>No workers yet</h3>
          <p>Workers will show up here as they create profiles. Share the app to get more workers signed up!</p>
        </div>
      `}
    </div>
  `;
}

function renderWorkerCard(w) {
  const workerSkills = (w.worker_skills || []).map(ws => {
    const skill = state.skills.find(s => s.id === ws.skill_id);
    return skill ? skill.name : '';
  }).filter(Boolean);
  
  const avatarContent = w.avatar_url 
    ? `<img src="${w.avatar_url}" style="width:100%;height:100%;object-fit:cover">`
    : getInitials(w.name);
  const avatarStyle = w.avatar_url 
    ? 'overflow:hidden' 
    : '';
  
  return `
    <div class="worker-card" onclick="viewWorker('${w.id}')">
      <div class="worker-card-row">
        <div class="avatar ${w.availability === 'storm_response' ? 'blue' : ''}" style="${avatarStyle}">${avatarContent}</div>
        <div style="flex:1;min-width:0">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <span class="worker-name">${w.name}</span>
            <span class="worker-dist">${w.location_text || ''}</span>
          </div>
          <div class="rating-row">
            <span class="star">‚òÖ</span>
            <span class="rating-num">${w.rating_avg || 'New'}</span>
            ${w.rating_count ? `<span class="rating-count">(${w.rating_count} reviews)</span>` : '<span class="rating-count">No reviews yet</span>'}
          </div>
          <div class="worker-pay">${formatPay(w.pay_min, w.pay_max, w.pay_type)}${w.pay_type === 'day_rate' ? ' ¬∑ Hours negotiable' : ''}</div>
          <div class="badge-wrap">
            <span class="badge badge-avail">${availLabel(w.availability)}</span>
            ${w.has_insurance ? '<span class="badge badge-cert">üõ°Ô∏è Insured</span>' : ''}
            ${workerSkills.slice(0, 3).map(s => `<span class="badge badge-skill">${s}</span>`).join('')}
            ${workerSkills.length > 3 ? `<span class="badge badge-skill">+${workerSkills.length - 3}</span>` : ''}
          </div>
        </div>
      </div>
    </div>
  `;
}

function renderWorkerProfile(w) {
  const workerSkills = (w.worker_skills || []).map(ws => {
    const skill = state.skills.find(s => s.id === ws.skill_id);
    return skill ? skill.name : '';
  }).filter(Boolean);
  
  const avatarContent = w.avatar_url 
    ? `<img src="${w.avatar_url}" style="width:100%;height:100%;object-fit:cover">`
    : `<span style="color:#fff;font-size:20px;font-weight:700">${getInitials(w.name)}</span>`;
  
  return `
    <div class="profile-view-header">
      <button class="auth-back" onclick="state.viewingWorker=null;render()">&larr; Back</button>
      <div style="display:flex;gap:14px;align-items:center">
        <div style="width:60px;height:60px;border-radius:30px;background:rgba(255,255,255,0.2);display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0">${avatarContent}</div>
        <div>
          <div style="font-size:20px;font-weight:700">${w.name}</div>
          <div style="font-size:13px;opacity:0.8;margin-top:2px">${w.location_text || 'Location not set'}</div>
          <div class="rating-row" style="margin-top:4px">
            <span class="star">‚òÖ</span>
            <span style="font-weight:600">${w.rating_avg || 'New'}</span>
            ${w.rating_count ? `<span style="opacity:0.8;font-size:13px">(${w.rating_count} reviews)</span>` : ''}
          </div>
        </div>
      </div>
    </div>
    <div style="padding-top:12px">
      <div class="profile-section">
        <div style="display:flex;justify-content:space-between;padding:4px 0"><span class="profile-section-title" style="margin:0">Pay Range</span><span style="font-weight:700;color:var(--green);font-size:16px">${formatPay(w.pay_min, w.pay_max, w.pay_type)}</span></div>
        <div style="display:flex;justify-content:space-between;padding:4px 0;margin-top:4px"><span style="font-weight:600;color:var(--forest-mid)">Availability</span><span>${availLabel(w.availability)}</span></div>
      </div>
      ${w.bio ? `
      <div class="profile-section">
        <div class="profile-section-title">About</div>
        <p style="font-size:14px;color:var(--gray-700);line-height:1.5">${w.bio}</p>
      </div>
      ` : ''}
      <div class="profile-section">
        <div class="profile-section-title">Skills</div>
        <div class="badge-wrap">${workerSkills.map(s => `<span class="badge badge-skill">${s}</span>`).join('') || '<span style="color:var(--gray-500);font-size:13px">No skills added yet</span>'}</div>
      </div>
      ${w.has_insurance ? `
      <div class="profile-section">
        <div style="display:flex;align-items:center;gap:8px">
          <span style="font-size:24px">üõ°Ô∏è</span>
          <div>
            <div class="profile-section-title" style="margin:0">Liability Insurance</div>
            <div style="font-size:13px;color:var(--green);font-weight:600">Verified ‚Äî carries own insurance</div>
            ${w.insurance_expiry ? `<div style="font-size:12px;color:var(--gray-500);margin-top:2px">Expires: ${w.insurance_expiry}</div>` : ''}
          </div>
        </div>
        ${w.insurance_doc_url ? `<a href="${w.insurance_doc_url}" target="_blank" style="display:block;margin-top:10px;font-size:13px;color:var(--blue);font-weight:600;text-decoration:none">View Insurance Document ‚Üí</a>` : ''}
      </div>
      ` : ''}
      <div class="profile-section" id="worker-photos-section">
        <div class="profile-section-title">Work Photos</div>
        <div id="worker-photos-grid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px">
          <div style="text-align:center;padding:20px;color:var(--gray-400);font-size:13px;grid-column:1/-1">Loading photos...</div>
        </div>
      </div>
      <div class="profile-section">
        <div class="profile-section-title">Reviews</div>
        <div id="worker-reviews">
          <div style="text-align:center;padding:12px;color:var(--gray-400);font-size:13px">Loading reviews...</div>
        </div>
      </div>
      <div style="padding:0 16px 16px">
        <button class="btn btn-primary" style="margin-bottom:8px" onclick="startChat('${w.id}')">Send Message</button>
        <button class="btn btn-secondary" style="margin-bottom:8px" onclick="saveWorker('${w.id}')">Save to Crew List</button>
        <button class="btn btn-outline" onclick="showRateWorker('${w.id}')">Leave a Review</button>
      </div>
    </div>
  `;
  // Note: work photos will be loaded async after render
}

// ============================================
// JOB FEED (Worker view)
// ============================================
function renderJobFeed() {
  const myActiveJobs = (state.myJobStatuses || []).filter(r => r.status === 'accepted');
  const myCompletedJobs = (state.myJobStatuses || []).filter(r => r.status === 'completed');
  const myAppliedIds = new Set((state.myJobStatuses || []).map(r => r.job_id));
  
  return `
    <div class="page-padding">
      ${myActiveJobs.length ? `
        <div class="profile-section-title" style="color:var(--green)">üî® Your Active Jobs</div>
        ${myActiveJobs.map(r => {
          const j = state.jobs.find(j => j.id === r.job_id);
          if (!j) return '';
          const biz = j.profiles || {};
          return `
            <div class="card" style="padding:14px;margin-bottom:8px;border-left:3px solid var(--green)">
              <div style="display:flex;justify-content:space-between;align-items:flex-start">
                <div>
                  <div style="font-weight:700">${j.title}</div>
                  <div style="font-size:13px;color:var(--gray-600)">${biz.company_name || biz.name || 'Company'} ¬∑ ${j.location_text || ''}</div>
                </div>
                <span style="font-weight:700;color:var(--green);font-size:14px">${formatPay(j.pay_min, j.pay_max, j.pay_type)}</span>
              </div>
              <div style="display:flex;gap:6px;margin-top:8px">
                <button class="btn btn-primary" style="flex:1;font-size:12px;padding:8px" onclick="startChatWithBiz('${j.business_id}')">Message Company</button>
                <button class="btn btn-outline" style="flex:1;font-size:12px;padding:8px" onclick="showRateCompany('${j.business_id}')">Leave Review</button>
              </div>
            </div>
          `;
        }).join('')}
        <div style="height:16px"></div>
      ` : ''}
      
      <div class="page-title">Available Jobs Near You</div>
      <div class="page-sub">Pick up work that fits your schedule</div>
      ${state.jobs.filter(j => j.is_active).length ? state.jobs.filter(j => j.is_active).map(j => {
        const applied = myAppliedIds.has(j.id);
        const myStatus = (state.myJobStatuses || []).find(r => r.job_id === j.id);
        return renderJobCard(j, applied, myStatus);
      }).join('') : `
        <div class="empty-state">
          <div class="empty-state-icon">&#128188;</div>
          <h3>No jobs posted yet</h3>
          <p>Jobs from companies in your area will show up here. Check back soon!</p>
        </div>
      `}
    </div>
  `;
}

function renderJobCard(j, applied, myStatus) {
  const biz = j.profiles || {};
  const jobSkills = (j.job_skills || []).map(js => {
    const skill = state.skills.find(s => s.id === js.skill_id);
    return skill ? skill.name : '';
  }).filter(Boolean);
  
  let actionBtn = '';
  if (myStatus?.status === 'accepted') {
    actionBtn = '<span class="badge" style="background:var(--green);color:#fff;font-size:12px;padding:6px 12px">‚úÖ Hired</span>';
  } else if (myStatus?.status === 'completed') {
    actionBtn = '<span class="badge" style="background:var(--gray-500);color:#fff;font-size:12px;padding:6px 12px">üèÅ Done</span>';
  } else if (myStatus?.status === 'declined') {
    actionBtn = '<span class="badge" style="background:var(--gray-400);color:#fff;font-size:12px;padding:6px 12px">Not selected</span>';
  } else if (applied) {
    actionBtn = '<span class="badge" style="background:var(--amber);color:#fff;font-size:12px;padding:6px 12px">Applied ‚úì</span>';
  } else {
    actionBtn = `<button class="btn btn-primary" style="width:auto;padding:8px 20px;font-size:13px" onclick="event.stopPropagation();respondToJob(${j.id})">I'm Interested</button>`;
  }
  
  return `
    <div class="job-card ${j.is_urgent ? 'urgent' : ''}">
      <div style="display:flex;justify-content:space-between;align-items:flex-start">
        <div>
          <div style="display:flex;align-items:center;gap:6px">
            <span class="job-title">${j.title}</span>
            ${j.is_urgent ? '<span class="badge badge-urgent">Urgent</span>' : ''}
          </div>
          <div class="job-meta"><span style="color:var(--green);font-weight:600;cursor:pointer" onclick="event.stopPropagation();viewCompany('${j.business_id}')">${biz.company_name || biz.name || 'Company'}</span> ¬∑ ${j.location_text || ''}</div>
        </div>
        <span class="job-pay">${formatPay(j.pay_min, j.pay_max, j.pay_type)}</span>
      </div>
      <div class="badge-wrap" style="margin-top:8px">
        <span class="badge badge-trade">${j.job_type === 'on_demand' ? 'On-Demand' : j.job_type === 'short_term' ? 'Short-Term' : j.job_type === 'seasonal' ? 'Seasonal' : 'Storm Response'}</span>
        ${j.pay_type === 'day_rate' ? '<span class="badge badge-cert">Day Rate ¬∑ Hours Negotiable</span>' : ''}
        ${jobSkills.map(s => `<span class="badge badge-skill">${s}</span>`).join('')}
      </div>
      ${j.description ? `<p style="font-size:13px;color:var(--gray-600);margin-top:8px;line-height:1.4">${j.description}</p>` : ''}
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
        <span class="job-posted">Posted ${timeAgo(j.created_at)}</span>
        <div style="display:flex;gap:6px;align-items:center">
          <button class="btn btn-outline" style="width:auto;padding:6px 12px;font-size:12px" onclick="event.stopPropagation();startChatWithBiz('${j.business_id}')">Message</button>
          ${actionBtn}
        </div>
      </div>
    </div>
  `;
}

// ============================================
// MY JOBS (Business view)
// ============================================
function renderMyJobs() {
  if (state.viewingJobDetail) {
    return renderJobDetail(state.viewingJobDetail);
  }
  
  const myJobs = state.jobs.filter(j => j.business_id === state.user.id);
  
  return `
    <div class="page-padding">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <span class="page-title" style="margin:0">My Job Posts</span>
        <button class="btn btn-primary" style="width:auto;padding:8px 16px;font-size:13px" onclick="showPostJob()">+ Post Job</button>
      </div>
      ${myJobs.length ? myJobs.map(j => {
        const responses = (state.jobResponses || {})[j.id] || [];
        const accepted = responses.filter(r => r.status === 'accepted');
        const interested = responses.filter(r => r.status === 'interested');
        const completed = responses.filter(r => r.status === 'completed');
        const statusLabel = !j.is_active ? 'Completed' : accepted.length ? 'In Progress' : 'Open';
        const statusColor = !j.is_active ? 'var(--gray-500)' : accepted.length ? 'var(--green)' : 'var(--amber)';
        
        return `
          <div class="job-card" onclick="viewJobDetail(${j.id})" style="cursor:pointer">
            <div style="display:flex;justify-content:space-between;align-items:flex-start">
              <div>
                <div style="display:flex;align-items:center;gap:6px">
                  <span class="job-title">${j.title}</span>
                  <span class="badge" style="background:${statusColor};color:#fff;font-size:10px">${statusLabel}</span>
                </div>
                <div class="job-meta">${formatPay(j.pay_min, j.pay_max, j.pay_type)} ¬∑ ${j.location_text || ''}</div>
              </div>
            </div>
            <div style="display:flex;gap:12px;margin-top:8px;font-size:13px;color:var(--gray-600)">
              ${interested.length ? `<span>üì• ${interested.length} interested</span>` : ''}
              ${accepted.length ? `<span>‚úÖ ${accepted.length} hired</span>` : ''}
              ${completed.length ? `<span>üèÅ ${completed.length} completed</span>` : ''}
            </div>
            <div style="font-size:12px;color:var(--gray-400);margin-top:6px">Posted ${timeAgo(j.created_at)} ¬∑ Tap to manage</div>
          </div>
        `;
      }).join('') : `
        <div class="empty-state">
          <div class="empty-state-icon">&#128203;</div>
          <h3>No jobs posted yet</h3>
          <p>Post your first job to start finding skilled workers.</p>
        </div>
      `}
    </div>
  `;
}

function renderJobDetail(job) {
  const responses = (state.jobResponses || {})[job.id] || [];
  const interested = responses.filter(r => r.status === 'interested');
  const accepted = responses.filter(r => r.status === 'accepted');
  const completed = responses.filter(r => r.status === 'completed');
  const declined = responses.filter(r => r.status === 'declined');
  
  return `
    <div class="page-padding">
      <button class="auth-back" onclick="state.viewingJobDetail=null;render()" style="margin-bottom:12px">&larr; Back to My Jobs</button>
      
      <div style="margin-bottom:16px">
        <div style="font-size:20px;font-weight:700">${job.title}</div>
        <div style="font-size:14px;color:var(--gray-600);margin-top:4px">${formatPay(job.pay_min, job.pay_max, job.pay_type)} ¬∑ ${job.location_text || ''}</div>
        ${job.description ? `<p style="font-size:13px;color:var(--gray-600);margin-top:8px;line-height:1.4">${job.description}</p>` : ''}
      </div>
      
      ${accepted.length ? `
      <div style="margin-bottom:20px">
        <div class="profile-section-title">Hired Workers (${accepted.length})</div>
        ${accepted.map(r => {
          const w = state.workers.find(w => w.id === r.worker_id) || r.worker_profile || {};
          return `
            <div class="card" style="padding:12px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center">
              <div style="display:flex;align-items:center;gap:10px">
                <div class="avatar" style="width:36px;height:36px;border-radius:18px;font-size:12px">${getInitials(w.name)}</div>
                <div>
                  <div style="font-weight:600">${w.name || 'Worker'}</div>
                  <div style="font-size:12px;color:var(--gray-500)">${w.location_text || ''}</div>
                </div>
              </div>
              <div style="display:flex;gap:6px">
                <button class="btn btn-primary" style="width:auto;padding:6px 12px;font-size:12px" onclick="completeWorker(${job.id}, '${r.worker_id}')">Complete</button>
                <button class="btn btn-outline" style="width:auto;padding:6px 12px;font-size:12px" onclick="startChat('${r.worker_id}')">Message</button>
              </div>
            </div>
          `;
        }).join('')}
      </div>
      ` : ''}
      
      ${interested.length ? `
      <div style="margin-bottom:20px">
        <div class="profile-section-title">Interested Workers (${interested.length})</div>
        ${interested.map(r => {
          const w = state.workers.find(w => w.id === r.worker_id) || r.worker_profile || {};
          const workerSkills = (w.worker_skills || []).map(ws => {
            const skill = state.skills.find(s => s.id === ws.skill_id);
            return skill ? skill.name : '';
          }).filter(Boolean);
          return `
            <div class="card" style="padding:12px;margin-bottom:8px">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div style="display:flex;align-items:center;gap:10px;cursor:pointer" onclick="viewWorker('${w.id}')">
                  <div class="avatar" style="width:36px;height:36px;border-radius:18px;font-size:12px">${getInitials(w.name)}</div>
                  <div>
                    <div style="font-weight:600">${w.name || 'Worker'}</div>
                    <div style="font-size:12px;color:var(--gray-500)">${w.location_text || ''} ¬∑ ${formatPay(w.pay_min, w.pay_max, w.pay_type)}</div>
                    ${w.has_insurance ? '<div style="font-size:11px;color:var(--green);font-weight:600">üõ°Ô∏è Insured</div>' : ''}
                  </div>
                </div>
              </div>
              ${workerSkills.length ? `<div class="badge-wrap" style="margin-top:6px">${workerSkills.slice(0, 4).map(s => `<span class="badge badge-skill">${s}</span>`).join('')}</div>` : ''}
              <div style="display:flex;gap:6px;margin-top:8px">
                <button class="btn btn-primary" style="flex:1;font-size:12px;padding:8px" onclick="acceptWorker(${job.id}, '${r.worker_id}')">Hire</button>
                <button class="btn btn-outline" style="flex:1;font-size:12px;padding:8px" onclick="declineWorker(${job.id}, '${r.worker_id}')">Decline</button>
                <button class="btn btn-outline" style="flex:1;font-size:12px;padding:8px" onclick="startChat('${r.worker_id}')">Message</button>
              </div>
            </div>
          `;
        }).join('')}
      </div>
      ` : ''}
      
      ${completed.length ? `
      <div style="margin-bottom:20px">
        <div class="profile-section-title">Completed (${completed.length})</div>
        ${completed.map(r => {
          const w = state.workers.find(w => w.id === r.worker_id) || r.worker_profile || {};
          return `
            <div class="card" style="padding:12px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;opacity:0.7">
              <div style="display:flex;align-items:center;gap:10px">
                <div class="avatar" style="width:36px;height:36px;border-radius:18px;font-size:12px">${getInitials(w.name)}</div>
                <div>
                  <div style="font-weight:600">${w.name || 'Worker'}</div>
                  <div style="font-size:12px;color:var(--green)">‚úÖ Completed</div>
                </div>
              </div>
              <button class="btn btn-outline" style="width:auto;padding:6px 12px;font-size:12px" onclick="showRateWorker('${r.worker_id}')">Review</button>
            </div>
          `;
        }).join('')}
      </div>
      ` : ''}
      
      ${!interested.length && !accepted.length && !completed.length ? `
        <div class="empty-state" style="padding:20px 0">
          <div class="empty-state-icon">‚è≥</div>
          <h3>No applicants yet</h3>
          <p>Workers will show up here when they express interest in this job.</p>
        </div>
      ` : ''}
      
      <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--gray-200)">
        ${job.is_active ? `
          <button class="btn btn-outline" style="color:var(--red);border-color:var(--red)" onclick="closeJob(${job.id})">Close Job Posting</button>
        ` : `
          <div style="text-align:center;color:var(--gray-500);font-size:13px">This job posting is closed</div>
        `}
      </div>
    </div>
  `;
}

async function viewJobDetail(jobId) {
  const job = state.jobs.find(j => j.id === jobId);
  if (!job) return;
  state.viewingJobDetail = job;
  
  // Load responses for this job with worker profiles
  try {
    const { data: responses } = await db.from('job_responses')
      .select('*, worker_profile:profiles!worker_id(*)')
      .eq('job_id', jobId);
    
    if (!state.jobResponses) state.jobResponses = {};
    state.jobResponses[jobId] = (responses || []).map(r => ({
      ...r,
      worker_profile: r.worker_profile,
    }));
  } catch(e) { console.error('Error loading responses:', e); }
  
  render();
}

async function acceptWorker(jobId, workerId) {
  try {
    await db.from('job_responses').update({ status: 'accepted' })
      .eq('job_id', jobId).eq('worker_id', workerId);
    
    // Auto-save to crew roster
    try {
      await db.from('saved_workers').insert({
        business_id: state.user.id,
        worker_id: workerId,
      });
    } catch(e) { /* already saved, ignore */ }
    
    showToast('Worker hired and added to your crew!');
    viewJobDetail(jobId);
  } catch(e) { showToast('Error: ' + e.message); }
}

async function declineWorker(jobId, workerId) {
  try {
    await db.from('job_responses').update({ status: 'declined' })
      .eq('job_id', jobId).eq('worker_id', workerId);
    showToast('Worker declined');
    viewJobDetail(jobId);
  } catch(e) { showToast('Error: ' + e.message); }
}

async function completeWorker(jobId, workerId) {
  try {
    await db.from('job_responses').update({ status: 'completed' })
      .eq('job_id', jobId).eq('worker_id', workerId);
    showToast('Job marked complete! Leave a review.');
    
    // Show review modal for the worker
    showRateWorker(workerId);
    
    // Refresh
    viewJobDetail(jobId);
  } catch(e) { showToast('Error: ' + e.message); }
}

async function closeJob(jobId) {
  try {
    await db.from('jobs').update({ is_active: false }).eq('id', jobId);
    showToast('Job posting closed');
    await loadData();
    state.viewingJobDetail = null;
    render();
  } catch(e) { showToast('Error: ' + e.message); }
}

// ============================================
// MESSAGES
// ============================================
function renderMessages() {
  // If we're in a chat, show the chat view
  if (state.chattingWith) return renderChat();
  
  // Otherwise show conversations list
  return `
    <div class="page-padding">
      <div class="page-title">Messages</div>
    </div>
    <div id="conversations-list">
      ${state.conversations.length ? state.conversations.map(c => `
        <div class="msg-item ${c.unread ? 'unread' : ''}" onclick="openChat('${c.userId}', '${c.name.replace(/'/g, "\\'")}')">
          <div style="display:flex;gap:10px;align-items:center">
            <div class="avatar" style="width:40px;height:40px;border-radius:20px;font-size:13px">${getInitials(c.name)}</div>
            <div style="flex:1;min-width:0">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <span class="msg-name">${c.name}</span>
                <span class="msg-time">${c.time}</span>
              </div>
              <div class="msg-preview">${c.preview}</div>
            </div>
            ${c.unread ? '<div style="width:10px;height:10px;border-radius:5px;background:var(--green);flex-shrink:0"></div>' : ''}
          </div>
        </div>
      `).join('') : `
        <div class="empty-state">
          <div class="empty-state-icon">&#128172;</div>
          <h3>No messages yet</h3>
          <p>${state.profile?.user_type === 'business' ? 'Find a worker and tap "Send Message" to start a conversation.' : 'When a company reaches out, it\'ll show up here.'}</p>
        </div>
      `}
    </div>
  `;
}

function renderChat() {
  const c = state.chattingWith;
  return `
    <div style="display:flex;flex-direction:column;height:100%;">
      <div style="padding:12px 16px;border-bottom:1px solid var(--gray-200);background:var(--white);display:flex;align-items:center;gap:10px;flex-shrink:0">
        <button style="background:none;border:none;font-size:18px;cursor:pointer;padding:4px" onclick="closeChat()">‚Üê</button>
        <div class="avatar" style="width:36px;height:36px;border-radius:18px;font-size:12px">${getInitials(c.name)}</div>
        <div style="cursor:pointer" onclick="viewProfileFromChat('${c.userId}')">
          <div style="font-weight:700;font-size:14px">${c.name} <span style="font-size:11px;color:var(--green);font-weight:500">View Profile ‚Üí</span></div>
          <div style="font-size:11px;color:var(--gray-500)">${c.location || 'CrewFinder'}</div>
        </div>
      </div>
      <div class="chat-messages" id="chat-messages">
        ${state.chatMessages.length ? state.chatMessages.map(m => `
          <div class="chat-bubble ${m.sender_id === state.user.id ? 'sent' : 'received'}">
            ${m.content}
          </div>
          <div style="font-size:10px;color:var(--gray-400);${m.sender_id === state.user.id ? 'text-align:right' : ''};margin-top:-4px;margin-bottom:4px">${timeAgo(m.created_at)}</div>
        `).join('') : `
          <div style="text-align:center;padding:40px 20px;color:var(--gray-400);font-size:13px">
            Start the conversation ‚Äî say hello!
          </div>
        `}
      </div>
      <div class="chat-input-bar">
        <input id="chat-input" placeholder="Type a message..." onkeydown="if(event.key==='Enter')sendMessage()">
        <button class="chat-send-btn" onclick="sendMessage()">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
        </button>
      </div>
    </div>
  `;
}

// ============================================
// MATCHES (Worker view)
// ============================================
function renderCompanies() {
  if (state.viewingCompany) {
    return renderCompanyProfile(state.viewingCompany);
  }
  
  const businesses = state.businesses || [];
  
  return `
    <div class="page-padding">
      <div class="page-title">Companies Near You</div>
      <div class="page-sub">Browse tree service companies hiring in your area</div>
      ${businesses.length ? businesses.map(b => {
        const avatarContent = b.avatar_url 
          ? `<img src="${b.avatar_url}" style="width:100%;height:100%;object-fit:cover">`
          : getInitials(b.company_name || b.name);
        const avatarStyle = b.avatar_url ? 'overflow:hidden' : '';
        const jobCount = (state.jobs || []).filter(j => j.business_id === b.id && j.is_active).length;
        
        return `
          <div class="worker-card" onclick="viewCompany('${b.id}')">
            <div class="worker-card-row">
              <div class="avatar" style="${avatarStyle}">${avatarContent}</div>
              <div class="worker-info">
                <div class="worker-name">${b.company_name || b.name}</div>
                <div class="worker-location">${b.location_text || 'Location not set'}</div>
                <div class="rating-row">
                  <span class="star">‚òÖ</span>
                  <span>${b.biz_rating_avg || 'New'}</span>
                  ${b.biz_rating_count ? `<span class="rating-count">(${b.biz_rating_count})</span>` : ''}
                </div>
              </div>
            </div>
            <div class="badge-wrap">
              ${jobCount > 0 ? `<span class="badge badge-avail">${jobCount} active job${jobCount > 1 ? 's' : ''}</span>` : ''}
              ${b.company_description ? `<span style="font-size:13px;color:var(--gray-600);line-height:1.4;display:block;margin-top:4px">${b.company_description.slice(0, 100)}${b.company_description.length > 100 ? '...' : ''}</span>` : ''}
            </div>
          </div>
        `;
      }).join('') : `
        <div class="empty-state">
          <div class="empty-state-icon">üè¢</div>
          <h3>No companies yet</h3>
          <p>Companies will show up here as they join CrewFinder.</p>
        </div>
      `}
    </div>
  `;
}

function renderCompanyProfile(b) {
  const avatarContent = b.avatar_url 
    ? `<img src="${b.avatar_url}" style="width:100%;height:100%;object-fit:cover">`
    : `<span style="color:#fff;font-size:20px;font-weight:700">${getInitials(b.company_name || b.name)}</span>`;
  
  const companyJobs = (state.jobs || []).filter(j => j.business_id === b.id && j.is_active);
  const reviews = state.viewingCompanyReviews || [];
  
  return `
    <div class="profile-view-header">
      <button class="auth-back" onclick="state.viewingCompany=null;render()">&larr; Back</button>
      <div style="display:flex;gap:14px;align-items:center">
        <div style="width:60px;height:60px;border-radius:30px;background:rgba(255,255,255,0.2);display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0">${avatarContent}</div>
        <div>
          <div style="font-size:20px;font-weight:700">${b.company_name || b.name}</div>
          <div style="font-size:13px;opacity:0.8;margin-top:2px">${b.location_text || 'Location not set'}</div>
          <div class="rating-row" style="margin-top:4px">
            <span class="star">‚òÖ</span>
            <span style="font-weight:600">${b.biz_rating_avg || 'New'}</span>
            ${b.biz_rating_count ? `<span style="opacity:0.8;font-size:13px">(${b.biz_rating_count} reviews)</span>` : ''}
          </div>
        </div>
      </div>
    </div>
    <div style="padding-top:12px">
      ${b.company_description ? `
      <div class="profile-section">
        <div class="profile-section-title">About</div>
        <p style="font-size:14px;color:var(--gray-700);line-height:1.5">${b.company_description}</p>
      </div>
      ` : ''}
      ${b.phone ? `
      <div class="profile-section">
        <div style="display:flex;justify-content:space-between;padding:4px 0"><span style="font-weight:600;color:var(--forest-mid)">Phone</span><a href="tel:${b.phone}" style="color:var(--green);font-weight:600;text-decoration:none">${b.phone}</a></div>
      </div>
      ` : ''}
      ${companyJobs.length ? `
      <div class="profile-section">
        <div class="profile-section-title">Active Jobs</div>
        ${companyJobs.map(j => `
          <div class="card" style="padding:12px;margin-bottom:8px">
            <div style="font-weight:700">${j.title}</div>
            <div style="font-size:13px;color:var(--green);font-weight:600;margin-top:2px">${formatPay(j.pay_min, j.pay_max, j.pay_type)}</div>
            ${j.description ? `<div style="font-size:13px;color:var(--gray-600);margin-top:4px">${j.description.slice(0, 120)}${j.description.length > 120 ? '...' : ''}</div>` : ''}
          </div>
        `).join('')}
      </div>
      ` : ''}
      <div class="profile-section" id="company-photos-section">
        <div class="profile-section-title">Photos</div>
        <div id="company-photos-grid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px">
          <div style="text-align:center;padding:12px;color:var(--gray-400);font-size:13px;grid-column:1/-1">Loading...</div>
        </div>
      </div>
      <div class="profile-section">
        <div class="profile-section-title">Reviews from Workers</div>
        <div id="company-reviews">
          <div style="text-align:center;padding:12px;color:var(--gray-400);font-size:13px">Loading reviews...</div>
        </div>
      </div>
      <div style="padding:0 16px 16px">
        <button class="btn btn-primary" style="margin-bottom:8px" onclick="startChatWithBiz('${b.id}')">Send Message</button>
        <button class="btn btn-outline" onclick="showRateCompany('${b.id}')">Leave a Review</button>
      </div>
    </div>
  `;
}

async function viewCompany(id) {
  state.viewingCompany = (state.businesses || []).find(b => b.id === id);
  state.viewingCompanyReviews = [];
  render();
  
  // Load photos async
  try {
    const { data: photos } = await db.from('work_photos').select('*').eq('worker_id', id).order('created_at');
    const grid = document.getElementById('company-photos-grid');
    if (grid) {
      if (photos && photos.length > 0) {
        grid.innerHTML = photos.map(p => `
          <div style="aspect-ratio:1;border-radius:8px;overflow:hidden">
            <img src="${p.photo_url}" style="width:100%;height:100%;object-fit:cover;cursor:pointer" onclick="window.open('${p.photo_url}','_blank')">
          </div>
        `).join('');
      } else {
        grid.innerHTML = '<div style="text-align:center;padding:12px;color:var(--gray-400);font-size:13px;grid-column:1/-1">No photos yet</div>';
      }
    }
  } catch(e) {}
  
  // Load reviews async
  try {
    const { data: reviews } = await db.from('reviews').select('*, profiles!reviewer_id(name, avatar_url)').eq('reviewed_id', id).order('created_at', { ascending: false });
    const el = document.getElementById('company-reviews');
    if (el) {
      if (reviews && reviews.length > 0) {
        el.innerHTML = reviews.map(r => `
          <div style="padding:12px 0;border-bottom:1px solid var(--gray-200)">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <span style="font-weight:600;font-size:14px">${r.profiles?.name || 'Worker'}</span>
              <span style="color:var(--amber);font-size:14px">${'‚òÖ'.repeat(r.rating)}${'‚òÜ'.repeat(5 - r.rating)}</span>
            </div>
            ${r.comment ? `<p style="font-size:13px;color:var(--gray-600);margin-top:4px;line-height:1.4">${r.comment}</p>` : ''}
          </div>
        `).join('');
      } else {
        el.innerHTML = '<div style="text-align:center;padding:12px;color:var(--gray-400);font-size:13px">No reviews yet ‚Äî be the first!</div>';
      }
    }
  } catch(e) {
    const el = document.getElementById('company-reviews');
    if (el) el.innerHTML = '<div style="text-align:center;padding:12px;color:var(--gray-400);font-size:13px">No reviews yet</div>';
  }
}

async function startChatWithBiz(bizId) {
  const biz = (state.businesses || []).find(b => b.id === bizId);
  const name = biz?.company_name || biz?.name || 'Company';
  const location = biz?.location_text || '';
  openChat(bizId, name, location);
}

function showRateCompany(bizId) {
  showRateModal(bizId, 'company');
}

function showRateWorker(workerId) {
  showRateModal(workerId, 'worker');
}

function showRateModal(userId, type) {
  const label = type === 'company' ? 'this company' : 'this worker';
  const modal = document.createElement('div');
  modal.id = 'rate-modal';
  modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:500;display:flex;align-items:center;justify-content:center;padding:20px';
  modal.innerHTML = `
    <div style="background:var(--white);border-radius:16px;padding:24px;max-width:340px;width:100%;text-align:center">
      <h3 style="margin:0 0 4px">Rate ${label}</h3>
      <p style="font-size:13px;color:var(--gray-500);margin:0 0 16px">Your review helps the community</p>
      <div id="rate-stars" style="font-size:32px;cursor:pointer;margin-bottom:16px;letter-spacing:4px">
        ${'‚òÜ'.repeat(5).split('').map((_, i) => `<span onclick="selectRating(${i+1})" data-star="${i+1}">‚òÜ</span>`).join('')}
      </div>
      <textarea id="rate-comment" class="form-input" rows="3" placeholder="Optional ‚Äî tell others about your experience" style="margin-bottom:12px"></textarea>
      <button class="btn btn-primary" id="rate-submit-btn" onclick="submitRating('${userId}')" style="margin-bottom:8px">Submit Review</button>
      <button class="btn btn-outline" onclick="document.getElementById('rate-modal').remove()">Cancel</button>
    </div>
  `;
  document.body.appendChild(modal);
  state.selectedRating = 0;
}

function selectRating(n) {
  state.selectedRating = n;
  const stars = document.querySelectorAll('#rate-stars span');
  stars.forEach(s => {
    const val = parseInt(s.getAttribute('data-star'));
    s.textContent = val <= n ? '‚òÖ' : '‚òÜ';
    s.style.color = val <= n ? '#F59E0B' : '#D1D5DB';
  });
}

async function submitRating(userId) {
  if (!state.selectedRating) {
    showToast('Tap a star to rate');
    return;
  }
  
  const btn = document.getElementById('rate-submit-btn');
  btn.disabled = true;
  btn.textContent = 'Submitting...';
  
  try {
    const comment = document.getElementById('rate-comment')?.value?.trim();
    
    const { error } = await db.from('reviews').insert({
      reviewer_id: state.user.id,
      reviewed_id: userId,
      rating: state.selectedRating,
      comment: comment || null,
    });
    
    if (error) throw error;
    
    document.getElementById('rate-modal')?.remove();
    showToast('Review submitted!');
    
    // Update rating averages
    try {
      const { data: allReviews } = await db.from('reviews').select('rating').eq('reviewed_id', userId);
      if (allReviews && allReviews.length > 0) {
        const avg = (allReviews.reduce((sum, r) => sum + r.rating, 0) / allReviews.length).toFixed(1);
        const count = allReviews.length;
        
        // Determine if reviewed user is worker or business
        const isReviewedWorker = state.workers.find(w => w.id === userId);
        if (isReviewedWorker) {
          await db.from('profiles').update({ rating_avg: avg, rating_count: count }).eq('id', userId);
        } else {
          await db.from('profiles').update({ biz_rating_avg: avg, biz_rating_count: count }).eq('id', userId);
        }
      }
    } catch(e) { console.error('Error updating rating avg:', e); }
    
    // Refresh the view
    if (state.viewingCompany) {
      viewCompany(state.viewingCompany.id);
    } else if (state.viewingWorker) {
      viewWorker(state.viewingWorker.id);
    }
    
  } catch (e) {
    console.error('Review error:', e);
    if (e.message?.includes('unique') || e.code === '23505') {
      showToast("You've already reviewed this person");
    } else {
      showToast('Error submitting review: ' + (e.message || 'Try again'));
    }
    btn.disabled = false;
    btn.textContent = 'Submit Review';
  }
}

// ============================================
// STORM BLAST
// ============================================
function renderCrewRoster() {
  const crew = state.crewRoster || [];
  
  return `
    <div class="page-padding">
      <div class="page-title">My Crew</div>
      <div class="page-sub">Your saved workers and past hires ‚Äî book again in one tap</div>
      
      ${crew.length ? crew.map(c => {
        const w = c.worker || {};
        const avatarContent = w.avatar_url 
          ? `<img src="${w.avatar_url}" style="width:100%;height:100%;object-fit:cover">`
          : getInitials(w.name);
        const avatarStyle = w.avatar_url ? 'overflow:hidden' : '';
        const workerSkills = (w.worker_skills || []).map(ws => {
          const skill = state.skills.find(s => s.id === ws.skill_id);
          return skill ? skill.name : '';
        }).filter(Boolean);
        
        return `
          <div class="card" style="padding:14px;margin-bottom:10px">
            <div style="display:flex;gap:12px;align-items:flex-start">
              <div class="avatar" style="width:44px;height:44px;border-radius:22px;font-size:14px;flex-shrink:0;${avatarStyle};cursor:pointer" onclick="viewWorker('${w.id}')">${avatarContent}</div>
              <div style="flex:1;min-width:0">
                <div style="display:flex;justify-content:space-between;align-items:flex-start">
                  <div style="cursor:pointer" onclick="viewWorker('${w.id}')">
                    <div style="font-weight:700;font-size:15px">${w.name || 'Worker'}</div>
                    <div style="font-size:12px;color:var(--gray-500)">${w.location_text || ''}</div>
                  </div>
                  <div style="text-align:right">
                    <div class="rating-row" style="margin:0"><span class="star">‚òÖ</span><span style="font-weight:600;font-size:13px">${w.rating_avg || 'New'}</span></div>
                    <div style="font-size:12px;color:var(--green);font-weight:600">${formatPay(w.pay_min, w.pay_max, w.pay_type)}</div>
                  </div>
                </div>
                <div style="display:flex;align-items:center;gap:6px;margin-top:4px;flex-wrap:wrap">
                  <span class="badge badge-avail" style="font-size:10px">${availLabel(w.availability)}</span>
                  ${w.has_insurance ? '<span class="badge badge-cert" style="font-size:10px">üõ°Ô∏è Insured</span>' : ''}
                  ${workerSkills.slice(0, 2).map(s => `<span class="badge badge-skill" style="font-size:10px">${s}</span>`).join('')}
                </div>
                ${c.note ? `<div style="font-size:12px;color:var(--gray-600);margin-top:6px;font-style:italic">"${c.note}"</div>` : ''}
                ${c.last_job_title ? `<div style="font-size:11px;color:var(--gray-400);margin-top:4px">Last job: ${c.last_job_title} ¬∑ ${timeAgo(c.last_job_date)}</div>` : ''}
              </div>
            </div>
            <div style="display:flex;gap:6px;margin-top:10px">
              <button class="btn btn-primary" style="flex:2;font-size:12px;padding:8px" onclick="bookAgain('${w.id}', '${(w.name || '').replace(/'/g, '')}')">Book Again</button>
              <button class="btn btn-outline" style="flex:1;font-size:12px;padding:8px" onclick="startChat('${w.id}')">Message</button>
              <button class="btn btn-outline" style="flex:1;font-size:12px;padding:8px" onclick="editCrewNote('${c.id}')">Note</button>
              <button style="background:none;border:1px solid var(--gray-300);border-radius:var(--radius-sm);padding:8px;font-size:12px;cursor:pointer;color:var(--gray-500)" onclick="removeFromCrew(${c.id}, '${w.name}')">‚úï</button>
            </div>
          </div>
        `;
      }).join('') : `
        <div class="empty-state">
          <div class="empty-state-icon">üë•</div>
          <h3>No crew members yet</h3>
          <p>When you save workers from Search or hire them for a job, they'll appear here. Build your go-to crew!</p>
          <button class="btn btn-primary" style="width:auto;margin:16px auto 0" onclick="switchTab('search')">Find Workers</button>
        </div>
      `}
    </div>
  `;
}

async function loadCrewRoster() {
  try {
    const { data: saved } = await db.from('saved_workers')
      .select('*, worker:profiles!worker_id(*, worker_skills(*))')
      .eq('business_id', state.user.id)
      .order('created_at', { ascending: false });
    
    // Enrich with last job info
    const crewData = (saved || []).map(s => {
      // Find last completed job with this worker
      const allResponses = Object.values(state.jobResponses || {}).flat();
      const workerCompleted = allResponses
        .filter(r => r.worker_id === s.worker_id && r.status === 'completed')
        .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
      
      let lastJobTitle = '';
      let lastJobDate = '';
      if (workerCompleted.length) {
        const job = state.jobs.find(j => j.id === workerCompleted[0].job_id);
        if (job) {
          lastJobTitle = job.title;
          lastJobDate = workerCompleted[0].created_at;
        }
      }
      
      return { ...s, last_job_title: lastJobTitle, last_job_date: lastJobDate };
    });
    
    state.crewRoster = crewData;
  } catch(e) {
    console.error('Error loading crew:', e);
    state.crewRoster = [];
  }
}

async function bookAgain(workerId, workerName) {
  // Open chat with a pre-filled booking message
  await startChat(workerId);
  // After chat opens, pre-fill the input
  setTimeout(() => {
    const input = document.getElementById('chat-input');
    if (input) {
      input.value = `Hey ${workerName}! I've got another job coming up ‚Äî are you available?`;
      input.focus();
    }
  }, 300);
}

function editCrewNote(savedId) {
  const current = (state.crewRoster || []).find(c => c.id === parseInt(savedId) || c.id === savedId);
  const note = prompt('Add a note about this worker:', current?.note || '');
  if (note !== null) {
    db.from('saved_workers').update({ note: note }).eq('id', savedId).then(() => {
      showToast('Note saved');
      loadCrewRoster().then(() => render());
    });
  }
}

async function removeFromCrew(savedId, workerName) {
  if (!confirm(`Remove ${workerName} from your crew?`)) return;
  try {
    await db.from('saved_workers').delete().eq('id', savedId);
    showToast('Removed from crew');
    await loadCrewRoster();
    render();
  } catch(e) { showToast('Error: ' + e.message); }
}

// ============================================
// MY PROFILE
// ============================================
function renderMyProfile() {
  const p = state.profile;
  if (!p) {
    // Try to reload profile
    loadProfile().then(() => { if (state.profile) render(); });
    return `
      <div class="empty-state">
        <div class="empty-state-icon">&#128100;</div>
        <h3>Loading profile...</h3>
        <p>If this doesn't load, try logging out and back in.</p>
        <button class="btn btn-outline" style="width:auto;margin:16px auto 0" onclick="handleLogout()">Log Out</button>
      </div>
    `;
  }
  const isWorker = p.user_type === 'worker';
  
  // Get skills from state.workers if available, otherwise use selectedSkills
  let workerSkills = [];
  if (isWorker) {
    const meInWorkers = state.workers.find(w => w.id === p.id);
    if (meInWorkers && meInWorkers.worker_skills) {
      workerSkills = meInWorkers.worker_skills.map(ws => {
        const skill = state.skills.find(s => s.id === ws.skill_id);
        return skill ? skill.name : '';
      }).filter(Boolean);
    } else {
      // Fallback: use selectedSkills from signup
      workerSkills = Array.from(state.selectedSkills).map(id => {
        const skill = state.skills.find(s => s.id === id);
        return skill ? skill.name : '';
      }).filter(Boolean);
    }
  }
  
  const avatarContent = p.avatar_url 
    ? `<img src="${p.avatar_url}" style="width:100%;height:100%;object-fit:cover">`
    : `<span style="color:#fff;font-size:20px;font-weight:700">${getInitials(p.name)}</span>`;
  
  return `
    <div class="profile-view-header">
      <div style="display:flex;gap:14px;align-items:center">
        <div style="width:60px;height:60px;border-radius:30px;background:rgba(255,255,255,0.2);display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0">${avatarContent}</div>
        <div>
          <div style="font-size:20px;font-weight:700">${isWorker ? p.name : (p.company_name || p.name)}</div>
          <div style="font-size:13px;opacity:0.8;margin-top:2px">${p.location_text || 'Location not set'} ¬∑ ${isWorker ? 'Worker' : 'Business'}</div>
          <div class="rating-row" style="margin-top:4px">
            <span class="star">‚òÖ</span>
            <span style="font-weight:600">${isWorker ? (p.rating_avg || 'New') : (p.biz_rating_avg || 'New')}</span>
          </div>
        </div>
      </div>
    </div>
    <div style="padding-top:12px">
      ${isWorker ? `
      <div class="profile-section">
        <div style="display:flex;justify-content:space-between;padding:4px 0"><span style="font-weight:600;color:var(--forest-mid)">Pay Range</span><span style="font-weight:700;color:var(--green)">${formatPay(p.pay_min, p.pay_max, p.pay_type)}</span></div>
        <div style="display:flex;justify-content:space-between;padding:4px 0;margin-top:4px"><span style="font-weight:600;color:var(--forest-mid)">Availability</span><span>${availLabel(p.availability)}</span></div>
      </div>
      <div class="profile-section">
        <div class="profile-section-title">Skills</div>
        <div class="badge-wrap">${workerSkills.length ? workerSkills.map(s => `<span class="badge badge-skill">${s}</span>`).join('') : '<span style="color:var(--gray-500);font-size:13px">No skills added yet</span>'}</div>
      </div>
      <div class="profile-section">
        <div style="display:flex;align-items:center;gap:8px">
          <span style="font-size:24px">${p.has_insurance ? 'üõ°Ô∏è' : 'üîì'}</span>
          <div>
            <div class="profile-section-title" style="margin:0">Liability Insurance</div>
            <div style="font-size:13px;color:${p.has_insurance ? 'var(--green)' : 'var(--gray-500)'};font-weight:600">${p.has_insurance ? 'Uploaded ‚Äî visible to companies' : 'Not uploaded yet'}</div>
            ${p.insurance_expiry ? `<div style="font-size:12px;color:var(--gray-500);margin-top:2px">Expires: ${p.insurance_expiry}</div>` : ''}
          </div>
        </div>
      </div>
      <div class="profile-section" id="my-photos-section">
        <div class="profile-section-title">Work Photos</div>
        <div id="my-photos-grid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px">
          <div style="text-align:center;padding:12px;color:var(--gray-400);font-size:13px;grid-column:1/-1">Loading...</div>
        </div>
      </div>
      ` : `
      <div class="profile-section">
        <div class="profile-section-title">About</div>
        <p style="font-size:14px;color:var(--gray-700);line-height:1.5">${p.company_description || '<span style="color:var(--gray-500)">No description yet ‚Äî add one in Edit Profile</span>'}</p>
      </div>
      <div class="profile-section" id="my-photos-section">
        <div class="profile-section-title">Company Photos</div>
        <div id="my-photos-grid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px">
          <div style="text-align:center;padding:12px;color:var(--gray-400);font-size:13px;grid-column:1/-1">Loading...</div>
        </div>
      </div>
      <div class="profile-section">
        <div class="profile-section-title">Subscription</div>
        <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:var(--light-green);border-radius:var(--radius-sm)">
          <div>
            <div style="font-weight:700;color:var(--green)">Free Plan</div>
            <div style="font-size:12px;color:var(--gray-600)">2 active jobs, 5 messages/month</div>
          </div>
          <button class="btn btn-primary" style="width:auto;padding:8px 16px;font-size:12px">Upgrade</button>
        </div>
      </div>
      `}
      <div style="padding:0 16px 16px">
        <button class="btn btn-primary" style="margin-bottom:8px" onclick="editProfile()">Edit Profile</button>
        <button class="btn btn-outline" onclick="handleLogout()">Log Out</button>
      </div>
    </div>
  `;
}

// ============================================
// EVENT HANDLERS
// ============================================
function goTo(screen) {
  state.currentScreen = screen;
  render();
}

function startSignup(type) {
  state.signupType = type;
  state.currentScreen = 'signup';
  render();
}

function switchTab(tab) {
  state.activeTab = tab;
  state.viewingWorker = null;
  state.viewingJob = null;
  state.viewingCompany = null;
  state.viewingJobDetail = null;
  state.chattingWith = null;
  render();
  
  // Load work photos for my profile
  if (tab === 'profile' && state.profile) {
    loadMyPhotos();
  }
  
  // Load crew roster
  if (tab === 'crew') {
    loadCrewRoster().then(() => render());
  }
}

async function loadMyPhotos() {
  try {
    const { data: photos } = await db.from('work_photos').select('*').eq('worker_id', state.user.id).order('created_at');
    const grid = document.getElementById('my-photos-grid');
    if (grid) {
      if (photos && photos.length > 0) {
        grid.innerHTML = photos.map(p => `
          <div style="aspect-ratio:1;border-radius:8px;overflow:hidden">
            <img src="${p.photo_url}" style="width:100%;height:100%;object-fit:cover">
          </div>
        `).join('');
      } else {
        grid.innerHTML = '<div style="text-align:center;padding:12px;color:var(--gray-400);font-size:13px;grid-column:1/-1">No photos yet ‚Äî add them in Edit Profile</div>';
      }
    }
  } catch (e) {
    console.error('Error loading photos:', e);
    const grid = document.getElementById('my-photos-grid');
    if (grid) grid.innerHTML = '<div style="text-align:center;padding:12px;color:var(--gray-400);font-size:13px;grid-column:1/-1">No photos yet</div>';
  }
}

function setTradeFilter(trade) {
  state.tradeFilter = trade === 'All' ? '' : trade;
  render();
}

function toggleSkill(skillId) {
  if (state.selectedSkills.has(skillId)) {
    state.selectedSkills.delete(skillId);
  } else {
    state.selectedSkills.add(skillId);
  }
  // Re-render just the skill chips without full re-render
  $$('.skill-chip').forEach(chip => {
    const id = parseInt(chip.getAttribute('onclick').match(/\d+/)[0]);
    chip.classList.toggle('selected', state.selectedSkills.has(id));
  });
}

function selectAvailability(val) {
  state.profile.availability = val;
  render();
}

function updatePayDisplay() {
  const min = document.getElementById('pay-min')?.value || 0;
  const max = document.getElementById('pay-max')?.value || 0;
  const display = document.getElementById('pay-display');
  const payType = state.profile?.pay_type || state.postJobData?.pay_type || 'hourly';
  const suffix = payType === 'day_rate' ? '/day' : '/hr';
  if (display) {
    display.textContent = `$${min} - $${max}${suffix}`;
  }
}

async function viewWorker(id) {
  state.viewingWorker = state.workers.find(w => w.id === id);
  render();
  
  // Load work photos async
  try {
    const { data: photos } = await db.from('work_photos').select('*').eq('worker_id', id).order('created_at');
    const grid = document.getElementById('worker-photos-grid');
    if (grid) {
      if (photos && photos.length > 0) {
        grid.innerHTML = photos.map(p => `
          <div style="aspect-ratio:1;border-radius:8px;overflow:hidden">
            <img src="${p.photo_url}" style="width:100%;height:100%;object-fit:cover;cursor:pointer" onclick="window.open('${p.photo_url}','_blank')">
          </div>
        `).join('');
      } else {
        grid.innerHTML = '<div style="text-align:center;padding:12px;color:var(--gray-400);font-size:13px;grid-column:1/-1">No work photos yet</div>';
      }
    }
  } catch(e) {}
  
  // Load reviews async
  try {
    const { data: reviews } = await db.from('reviews').select('*, profiles!reviewer_id(name, avatar_url, company_name)').eq('reviewed_id', id).order('created_at', { ascending: false });
    const el = document.getElementById('worker-reviews');
    if (el) {
      if (reviews && reviews.length > 0) {
        el.innerHTML = reviews.map(r => `
          <div style="padding:12px 0;border-bottom:1px solid var(--gray-200)">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <span style="font-weight:600;font-size:14px">${r.profiles?.company_name || r.profiles?.name || 'Company'}</span>
              <span style="color:#F59E0B;font-size:14px">${'‚òÖ'.repeat(r.rating)}${'‚òÜ'.repeat(5 - r.rating)}</span>
            </div>
            ${r.comment ? `<p style="font-size:13px;color:var(--gray-600);margin-top:4px;line-height:1.4">${r.comment}</p>` : ''}
          </div>
        `).join('');
      } else {
        el.innerHTML = '<div style="text-align:center;padding:12px;color:var(--gray-400);font-size:13px">No reviews yet</div>';
      }
    }
  } catch(e) {}
}

function showPostJob() {
  state.activeTab = 'post-job';
  state.postJobData = {
    title: '',
    description: '',
    pay_type: 'hourly',
    pay_min: '',
    pay_max: '',
    job_type: 'on_demand',
    location_text: state.profile?.location_text || '',
    is_urgent: false,
    selectedSkills: new Set(),
  };
  render();
}

function renderPostJob() {
  const d = state.postJobData;
  const trades = {};
  state.skills.forEach(s => {
    if (!trades[s.trade]) trades[s.trade] = [];
    trades[s.trade].push(s);
  });
  
  return `
    <div style="padding:16px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
        <span class="page-title" style="margin:0">${d.bookingFor ? 'Book ' + d.bookingName : 'Post a Job'}</span>
        <button style="background:none;border:none;color:var(--gray-500);font-size:14px;cursor:pointer;font-family:inherit" onclick="switchTab('jobs')">Cancel</button>
      </div>
      
      ${d.bookingFor ? `
      <div class="card" style="padding:12px;margin-bottom:16px;background:var(--light-green);border:1px solid var(--green)">
        <div style="font-size:13px;color:var(--forest-mid)">üìã Creating a job for <strong>${d.bookingName}</strong>. They'll be auto-hired when you post.</div>
      </div>
      ` : ''}
      
      <div class="form-group">
        <label class="form-label">Job Title</label>
        <input class="form-input" id="job-title" type="text" placeholder="e.g. Climber Needed Tomorrow" value="${d.title}">
      </div>
      
      <div class="form-group">
        <label class="form-label">What type of work?</label>
        <div style="display:flex;flex-wrap:wrap;gap:6px">
          ${[
            { val: 'on_demand', label: 'On-Demand' },
            { val: 'short_term', label: 'Short-Term' },
            { val: 'seasonal', label: 'Seasonal' },
            { val: 'storm_response', label: 'Storm Response' },
          ].map(t => `
            <button class="filter-chip ${d.job_type === t.val ? 'active' : ''}" onclick="state.postJobData.job_type='${t.val}';render()">${t.label}</button>
          `).join('')}
        </div>
      </div>
      
      <div class="form-group">
        <label class="form-label">Pay Type</label>
        <div style="display:flex;gap:6px;margin-bottom:10px">
          <button class="filter-chip ${(d.pay_type || 'hourly') === 'hourly' ? 'active' : ''}" onclick="state.postJobData.pay_type='hourly';render()">Hourly Rate</button>
          <button class="filter-chip ${d.pay_type === 'day_rate' ? 'active' : ''}" onclick="state.postJobData.pay_type='day_rate';render()">Flat Day Rate</button>
        </div>
        <label class="form-label">Pay Range (${d.pay_type === 'day_rate' ? '$/day' : '$/hr'})</label>
        <div class="pay-range-row">
          <input type="number" id="job-pay-min" placeholder="${d.pay_type === 'day_rate' ? '250' : '25'}" value="${d.pay_min}">
          <span>to</span>
          <input type="number" id="job-pay-max" placeholder="${d.pay_type === 'day_rate' ? '400' : '40'}" value="${d.pay_max}">
          <span>${d.pay_type === 'day_rate' ? '/day' : '/hr'}</span>
        </div>
        ${d.pay_type === 'day_rate' ? '<div class="form-hint">Hours negotiable ‚Äî workers will discuss schedule details in messages</div>' : ''}
      </div>
      
      <div class="form-group">
        <label class="form-label">Location</label>
        <input class="form-input" id="job-location" type="text" placeholder="Medway, MA" value="${d.location_text}">
      </div>
      
      <div class="form-group">
        <label class="form-label">Description</label>
        <textarea class="form-input" id="job-desc" rows="3" placeholder="What's the job? What should workers expect?">${d.description}</textarea>
      </div>
      
      <div class="form-group">
        <label class="form-label">Skills Needed</label>
        <div class="form-hint" style="margin-bottom:8px">Tap the skills required for this job ‚Äî workers with matching skills will see it first</div>
        ${Object.entries(trades).map(([trade, skills]) => `
          <div style="margin-bottom:10px">
            <div style="font-size:12px;font-weight:600;color:var(--gray-600);margin-bottom:6px">${trade}</div>
            <div class="skill-grid">
              ${skills.map(s => `
                <button class="skill-chip ${d.selectedSkills.has(s.id) ? 'selected' : ''}" onclick="toggleJobSkill(${s.id})">${s.name}</button>
              `).join('')}
            </div>
          </div>
        `).join('')}
      </div>
      
      <div class="form-group">
        <button class="avail-option ${d.is_urgent ? 'selected' : ''}" onclick="state.postJobData.is_urgent=!state.postJobData.is_urgent;render()" style="margin-bottom:0">
          <div class="avail-radio"></div>
          <div>
            <div class="avail-label">Mark as Urgent</div>
            <div class="avail-desc">Highlights the job so workers know you need help fast</div>
          </div>
        </button>
      </div>
      
      <button class="btn btn-primary" id="post-job-btn" onclick="handlePostJob(this)" style="margin-top:8px">Post Job</button>
    </div>
  `;
}

function toggleJobSkill(skillId) {
  if (state.postJobData.selectedSkills.has(skillId)) {
    state.postJobData.selectedSkills.delete(skillId);
  } else {
    state.postJobData.selectedSkills.add(skillId);
  }
  // Toggle just the chip without full re-render
  const chips = document.querySelectorAll('.skill-chip');
  chips.forEach(chip => {
    const match = chip.getAttribute('onclick')?.match(/toggleJobSkill\((\d+)\)/);
    if (match) {
      const id = parseInt(match[1]);
      chip.classList.toggle('selected', state.postJobData.selectedSkills.has(id));
    }
  });
}

async function handlePostJob(btn) {
  const title = document.getElementById('job-title')?.value?.trim();
  if (!title) { showToast('Add a job title'); return; }
  
  const payMin = parseInt(document.getElementById('job-pay-min')?.value || 0) * 100;
  const payMax = parseInt(document.getElementById('job-pay-max')?.value || 0) * 100;
  const location = document.getElementById('job-location')?.value?.trim();
  const desc = document.getElementById('job-desc')?.value?.trim();
  const d = state.postJobData;
  
  btn.disabled = true;
  btn.textContent = 'Posting...';
  
  try {
    const { data: job, error } = await db.from('jobs').insert({
      business_id: state.user.id,
      title: title,
      description: desc,
      pay_min: payMin || 2500,
      pay_max: payMax || payMin || 3500,
      pay_type: d.pay_type || 'hourly',
      job_type: d.job_type,
      location_text: location || state.profile?.location_text,
      is_urgent: d.is_urgent,
      is_active: true,
    }).select().single();
    
    if (error) throw error;
    
    // Add job skills
    if (job && d.selectedSkills.size > 0) {
      const jobSkills = Array.from(d.selectedSkills).map(skillId => ({
        job_id: job.id,
        skill_id: skillId,
      }));
      await db.from('job_skills').insert(jobSkills);
    }
    
    // Auto-hire if booking a specific worker
    if (job && d.bookingFor) {
      await db.from('job_responses').insert({
        job_id: job.id,
        worker_id: d.bookingFor,
        status: 'accepted',
      });
      showToast(`Job posted and ${d.bookingName} has been hired!`);
    } else {
      showToast('Job posted! Workers can see it now.');
    }
    await loadData();
    state.activeTab = 'jobs';
    render();
    
  } catch (e) {
    console.error('Post job error:', e);
    showToast('Error posting: ' + (e.message || 'Try again'));
    btn.disabled = false;
    btn.textContent = 'Post Job';
  }
}

function viewProfileFromChat(userId) {
  // Check if it's a worker or business and navigate accordingly
  const worker = state.workers.find(w => w.id === userId);
  if (worker) {
    state.chattingWith = null;
    state.viewingWorker = worker;
    state.activeTab = 'search';
    render();
    return;
  }
  const biz = (state.businesses || []).find(b => b.id === userId);
  if (biz) {
    state.chattingWith = null;
    state.viewingCompany = biz;
    state.activeTab = 'companies';
    render();
    // Load company photos and reviews
    viewCompany(biz.id);
    return;
  }
  // Fallback ‚Äî fetch from DB
  db.from('profiles').select('*').eq('id', userId).single().then(({ data }) => {
    if (data) {
      state.chattingWith = null;
      if (data.user_type === 'worker') {
        state.workers.push(data);
        state.viewingWorker = data;
        state.activeTab = 'search';
      } else {
        state.businesses.push(data);
        state.viewingCompany = data;
        state.activeTab = 'companies';
      }
      render();
    }
  });
}

async function startChat(userId) {
  // Look up the user's name from workers, businesses, or crew
  let target = state.workers.find(w => w.id === userId);
  if (!target) target = (state.businesses || []).find(b => b.id === userId);
  if (!target) {
    const crew = (state.crewRoster || []).find(c => c.worker?.id === userId);
    if (crew) target = crew.worker;
  }
  // Last resort ‚Äî fetch from DB
  if (!target) {
    try {
      const { data } = await db.from('profiles').select('*').eq('id', userId).single();
      target = data;
    } catch(e) {}
  }
  const name = target?.company_name || target?.name || 'User';
  const location = target?.location_text || '';
  openChat(userId, name, location);
}

async function openChat(userId, name, location) {
  // Build conversation ID (sorted pair so it's always the same)
  const ids = [state.user.id, userId].sort();
  const conversationId = ids.join('_');
  
  state.chattingWith = { userId, name, location: location || '', conversationId };
  state.chatMessages = [];
  
  render();
  
  // Load existing messages
  const { data: messages } = await db
    .from('messages')
    .select('*')
    .eq('conversation_id', conversationId)
    .order('created_at', { ascending: true });
  
  state.chatMessages = messages || [];
  render();
  scrollChatToBottom();
  
  // Mark messages as read
  await db
    .from('messages')
    .update({ is_read: true })
    .eq('conversation_id', conversationId)
    .eq('receiver_id', state.user.id)
    .eq('is_read', false);
  
  // Subscribe to new messages in real-time
  if (state.chatSubscription) {
    state.chatSubscription.unsubscribe();
  }
  
  state.chatSubscription = db
    .channel('chat_' + conversationId)
    .on('postgres_changes', {
      event: 'INSERT',
      schema: 'public',
      table: 'messages',
      filter: 'conversation_id=eq.' + conversationId,
    }, (payload) => {
      // Only add if we don't already have it
      if (!state.chatMessages.find(m => m.id === payload.new.id)) {
        state.chatMessages.push(payload.new);
        render();
        scrollChatToBottom();
        // Mark as read if we're the receiver
        if (payload.new.receiver_id === state.user.id) {
          db.from('messages').update({ is_read: true }).eq('id', payload.new.id);
        }
      }
    })
    .subscribe();
}

function closeChat() {
  if (state.chatSubscription) {
    state.chatSubscription.unsubscribe();
    state.chatSubscription = null;
  }
  state.chattingWith = null;
  state.chatMessages = [];
  // Reload conversations
  loadConversations();
  render();
}

async function sendMessage() {
  const input = document.getElementById('chat-input');
  const content = input?.value?.trim();
  if (!content || !state.chattingWith) return;
  
  input.value = '';
  
  const msg = {
    conversation_id: state.chattingWith.conversationId,
    sender_id: state.user.id,
    receiver_id: state.chattingWith.userId,
    content: content,
  };
  
  // Optimistic add
  const optimistic = { ...msg, id: Date.now(), created_at: new Date().toISOString(), is_read: false };
  state.chatMessages.push(optimistic);
  render();
  scrollChatToBottom();
  
  // Focus input again
  setTimeout(() => document.getElementById('chat-input')?.focus(), 50);
  
  // Actually send
  const { error } = await db.from('messages').insert(msg);
  if (error) {
    showToast('Failed to send message');
    state.chatMessages.pop();
    render();
  }
}

function scrollChatToBottom() {
  setTimeout(() => {
    const el = document.getElementById('chat-messages');
    if (el) el.scrollTop = el.scrollHeight;
  }, 50);
}

async function loadConversations() {
  // Get all messages where user is sender or receiver
  const { data: messages } = await db
    .from('messages')
    .select('*')
    .or(`sender_id.eq.${state.user.id},receiver_id.eq.${state.user.id}`)
    .order('created_at', { ascending: false });
  
  if (!messages || !messages.length) {
    state.conversations = [];
    return;
  }
  
  // Group by conversation
  const convos = {};
  messages.forEach(m => {
    if (!convos[m.conversation_id]) {
      convos[m.conversation_id] = {
        conversationId: m.conversation_id,
        lastMessage: m,
        unreadCount: 0,
        otherUserId: m.sender_id === state.user.id ? m.receiver_id : m.sender_id,
      };
    }
    if (!m.is_read && m.receiver_id === state.user.id) {
      convos[m.conversation_id].unreadCount++;
    }
  });
  
  // Look up names for each conversation
  const otherIds = [...new Set(Object.values(convos).map(c => c.otherUserId))];
  const { data: profiles } = await db
    .from('profiles')
    .select('id, name, company_name, user_type, location_text')
    .in('id', otherIds);
  
  const profileMap = {};
  (profiles || []).forEach(p => { profileMap[p.id] = p; });
  
  state.conversations = Object.values(convos).map(c => {
    const other = profileMap[c.otherUserId] || {};
    const displayName = other.user_type === 'business' ? (other.company_name || other.name) : other.name;
    return {
      userId: c.otherUserId,
      name: displayName || 'Unknown',
      location: other.location_text || '',
      preview: c.lastMessage.content,
      time: timeAgo(c.lastMessage.created_at),
      unread: c.unreadCount > 0,
    };
  });
}

async function saveWorker(userId) {
  try {
    await db.from('saved_workers').insert({
      business_id: state.user.id,
      worker_id: userId,
    });
    showToast('Worker saved to your crew list!');
  } catch (e) {
    showToast('Already saved!');
  }
}

async function respondToJob(jobId) {
  try {
    await db.from('job_responses').insert({
      job_id: jobId,
      worker_id: state.user.id,
    });
    
    // Update local state immediately
    if (!state.myJobStatuses) state.myJobStatuses = [];
    state.myJobStatuses.push({ job_id: jobId, worker_id: state.user.id, status: 'interested' });
    
    showToast("Interest sent! The company can see your profile now.");
    render();
  } catch (e) {
    showToast("You've already responded to this job.");
  }
}

function sendStormBlast() {
  showToast('Storm blast sent! Workers will be notified.');
}

// ============================================
// AUTH HANDLERS
// ============================================
async function handleSignup() {
  const name = $('#signup-name')?.value?.trim();
  const email = $('#signup-email')?.value?.trim();
  const password = $('#signup-password')?.value;
  const location = $('#signup-location')?.value?.trim();
  const company = $('#signup-company')?.value?.trim();
  const errorEl = $('#signup-error');
  
  if (!name || !email || !password) {
    errorEl.textContent = 'Please fill in all required fields.';
    errorEl.classList.add('show');
    return;
  }
  
  if (password.length < 6) {
    errorEl.textContent = 'Password must be at least 6 characters.';
    errorEl.classList.add('show');
    return;
  }
  
  const btn = $('#signup-btn');
  btn.disabled = true;
  btn.textContent = 'Creating account...';
  
  try {
    const { data, error } = await db.auth.signUp({
      email,
      password,
      options: {
        data: {
          name: name,
          user_type: state.signupType,
        }
      }
    });
    
    if (error) throw error;
    
    // Create profile
    const { error: profileError } = await db.from('profiles').insert({
      id: data.user.id,
      user_type: state.signupType,
      name: name,
      email: email,
      location_text: location,
      company_name: state.signupType === 'business' ? (company || name) : null,
    });
    
    if (profileError) throw profileError;
    
    state.user = data.user;
    state.profile = {
      id: data.user.id,
      user_type: state.signupType,
      name,
      email,
      location_text: location,
      company_name: company,
      availability: 'available_now',
    };
    
    // Load skills for worker
    if (state.signupType === 'worker') {
      await loadSkills();
    }
    
    state.profileStep = 1;
    state.currentScreen = 'profile-builder';
    render();
    
  } catch (e) {
    errorEl.textContent = e.message || 'Something went wrong. Please try again.';
    errorEl.classList.add('show');
    btn.disabled = false;
    btn.textContent = state.signupType === 'worker' ? 'Create Account' : 'Create Business Account';
  }
}

async function handleLogin() {
  const email = $('#login-email')?.value?.trim();
  const password = $('#login-password')?.value;
  const errorEl = $('#login-error');
  
  if (!email || !password) {
    errorEl.textContent = 'Please enter your email and password.';
    errorEl.classList.add('show');
    return;
  }
  
  const btn = $('#login-btn');
  btn.disabled = true;
  btn.textContent = 'Logging in...';
  
  try {
    const { data, error } = await db.auth.signInWithPassword({ email, password });
    if (error) throw error;
    
    state.user = data.user;
    await loadProfile();
    await loadSkills();
    await loadData();
    
    state.activeTab = state.profile?.user_type === 'business' ? 'search' : 'feed';
    state.currentScreen = 'main';
    render();
    
  } catch (e) {
    errorEl.textContent = e.message || 'Invalid email or password.';
    errorEl.classList.add('show');
    btn.disabled = false;
    btn.textContent = 'Log In';
  }
}

async function handleResetPassword() {
  const email = document.getElementById('reset-email')?.value?.trim();
  const errorEl = document.getElementById('reset-error');
  const successEl = document.getElementById('reset-success');
  
  if (!email) {
    errorEl.textContent = 'Please enter your email address.';
    errorEl.classList.add('show');
    return;
  }
  
  const btn = document.getElementById('reset-btn');
  btn.disabled = true;
  btn.textContent = 'Sending...';
  
  try {
    const { error } = await db.auth.resetPasswordForEmail(email, {
      redirectTo: window.location.origin + '/app.html',
    });
    
    if (error) throw error;
    
    errorEl.classList.remove('show');
    successEl.textContent = 'Check your email for a password reset link!';
    successEl.classList.add('show');
    btn.textContent = 'Sent!';
    
  } catch (e) {
    errorEl.textContent = e.message || 'Something went wrong. Try again.';
    errorEl.classList.add('show');
    btn.disabled = false;
    btn.textContent = 'Send Reset Link';
  }
}

async function handleLogout() {
  await db.auth.signOut();
  state.user = null;
  state.profile = null;
  state.currentScreen = 'splash';
  render();
}

// ============================================
// PROFILE BUILDER STEPS
// ============================================
async function nextProfileStep() {
  const isWorker = state.profile?.user_type === 'worker';
  const totalSteps = isWorker ? 6 : 1;
  
  try {
    if (isWorker && state.profileStep === 1) {
      const nameEl = document.getElementById('edit-name');
      const locEl = document.getElementById('edit-location');
      const bioEl = document.getElementById('edit-bio');
      const name = (nameEl ? nameEl.value.trim() : '') || state.profile.name;
      const location = locEl ? locEl.value.trim() : (state.profile.location_text || '');
      const bio = bioEl ? bioEl.value.trim() : (state.profile.bio || '');
      const { error } = await db.from('profiles').update({ 
        name: name,
        location_text: location, 
        bio: bio 
      }).eq('id', state.user.id);
      if (error) console.error('Step 1 save error:', error);
      state.profile.name = name;
      state.profile.location_text = location;
      state.profile.bio = bio;
      
    } else if (isWorker && state.profileStep === 2) {
      if (state.selectedSkills.size === 0) {
        showToast('Select at least one skill!');
        return;
      }
      const skills = Array.from(state.selectedSkills).map(skillId => ({
        worker_id: state.user.id,
        skill_id: skillId,
      }));
      await db.from('worker_skills').delete().eq('worker_id', state.user.id);
      const { error } = await db.from('worker_skills').insert(skills);
      if (error) console.error('Step 2 save error:', error);
      
    } else if (isWorker && state.profileStep === 3) {
      const minEl = document.getElementById('pay-min');
      const maxEl = document.getElementById('pay-max');
      const min = parseInt(minEl ? minEl.value : 20) * 100;
      const max = parseInt(maxEl ? maxEl.value : 35) * 100;
      const payType = state.profile.pay_type || 'hourly';
      const { error } = await db.from('profiles').update({ pay_min: min, pay_max: max, pay_type: payType }).eq('id', state.user.id);
      if (error) console.error('Step 3 save error:', error);
      state.profile.pay_min = min;
      state.profile.pay_max = max;
      
    } else if (isWorker && state.profileStep === 4) {
      const { error } = await db.from('profiles').update({ availability: state.profile.availability }).eq('id', state.user.id);
      if (error) console.error('Step 4 save error:', error);
      try {
        const { data: photos } = await db.from('work_photos').select('*').eq('worker_id', state.user.id).order('created_at');
        state.workPhotos = photos || [];
      } catch (e) { state.workPhotos = []; }
      
    } else if (isWorker && state.profileStep === 5) {
      // Photos uploaded individually, nothing to save
    } else if (isWorker && state.profileStep === 6) {
      // Save insurance expiry if set
      const expiry = document.getElementById('insurance-expiry')?.value?.trim();
      if (expiry || state.profile.insurance_doc_url) {
        const { error } = await db.from('profiles').update({ 
          insurance_expiry: expiry || null 
        }).eq('id', state.user.id);
        if (error) console.error('Step 6 save error:', error);
        state.profile.insurance_expiry = expiry;
      }
    }
    
    if (!isWorker) {
      const companyName = (document.getElementById('biz-name')?.value?.trim()) || state.profile.company_name;
      const location = (document.getElementById('biz-location')?.value?.trim()) || state.profile.location_text;
      const desc = (document.getElementById('biz-desc')?.value?.trim()) || state.profile.company_description;
      const phone = (document.getElementById('biz-phone')?.value?.trim()) || state.profile.phone;
      const { error } = await db.from('profiles').update({
        company_name: companyName,
        location_text: location,
        company_description: desc,
        phone: phone,
      }).eq('id', state.user.id);
      if (error) console.error('Biz save error:', error);
      state.profile.company_name = companyName;
      state.profile.location_text = location;
      state.profile.company_description = desc;
      state.profile.phone = phone;
    }
  } catch (e) {
    console.error('Profile step error:', e);
    // Still advance even if save failed
  }
  
  if (state.profileStep >= totalSteps) {
    try { await loadData(); } catch (e) { console.error('loadData error:', e); }
    state.activeTab = isWorker ? 'feed' : 'search';
    state.currentScreen = 'main';
    showToast('Profile set up! You\'re ready to go.');
  } else {
    state.profileStep++;
  }
  
  render();
}

function prevProfileStep() {
  if (state.profileStep > 1) {
    state.profileStep--;
    render();
  }
}

// ============================================
// JOB POSTING
// ============================================
// ============================================
// PHOTO UPLOADS
// ============================================
async function uploadAvatar(input) {
  const file = input.files[0];
  if (!file) return;
  
  const status = document.getElementById('avatar-status');
  if (status) status.textContent = 'Uploading...';
  
  try {
    const ext = file.name.split('.').pop();
    const path = `${state.user.id}/avatar.${ext}`;
    
    const { error: uploadError } = await db.storage
      .from('avatars')
      .upload(path, file, { upsert: true });
    
    if (uploadError) throw uploadError;
    
    const { data: { publicUrl } } = db.storage.from('avatars').getPublicUrl(path);
    
    // Add cache buster
    const url = publicUrl + '?t=' + Date.now();
    
    await db.from('profiles').update({ avatar_url: url }).eq('id', state.user.id);
    state.profile.avatar_url = url;
    
    if (status) status.textContent = 'Photo updated!';
    
    // Update preview
    const preview = document.getElementById('avatar-preview');
    if (preview) preview.innerHTML = `<img src="${url}" style="width:100%;height:100%;object-fit:cover">`;
    
  } catch (e) {
    console.error('Avatar upload error:', e);
    if (status) status.textContent = 'Upload failed ‚Äî try again';
    showToast('Photo upload failed: ' + (e.message || 'Unknown error'));
  }
}

async function uploadWorkPhoto(input) {
  const file = input.files[0];
  if (!file) return;
  
  const status = document.getElementById('photo-status');
  if (status) status.textContent = 'Uploading...';
  
  try {
    const ext = file.name.split('.').pop();
    const path = `${state.user.id}/${Date.now()}.${ext}`;
    
    const { error: uploadError } = await db.storage
      .from('work-photos')
      .upload(path, file);
    
    if (uploadError) throw uploadError;
    
    const { data: { publicUrl } } = db.storage.from('work-photos').getPublicUrl(path);
    
    // Save to work_photos table
    const { data: photo, error: dbError } = await db.from('work_photos').insert({
      worker_id: state.user.id,
      photo_url: publicUrl,
    }).select().single();
    
    if (dbError) throw dbError;
    
    if (!state.workPhotos) state.workPhotos = [];
    state.workPhotos.push(photo);
    
    if (status) status.textContent = 'Photo added!';
    render();
    
  } catch (e) {
    console.error('Work photo upload error:', e);
    if (status) status.textContent = 'Upload failed ‚Äî try again';
    showToast('Photo upload failed: ' + (e.message || 'Unknown error'));
  }
}

async function deleteWorkPhoto(photoId) {
  const photo = (state.workPhotos || []).find(p => p.id === photoId);
  if (!photo) return;
  
  await db.from('work_photos').delete().eq('id', photoId);
  state.workPhotos = (state.workPhotos || []).filter(p => p.id !== photoId);
  
  showToast('Photo removed');
  render();
}

async function uploadInsurance(input) {
  const file = input.files[0];
  if (!file) return;
  
  const status = document.getElementById('insurance-status');
  if (status) status.textContent = 'Uploading...';
  
  try {
    const ext = file.name.split('.').pop();
    const path = `${state.user.id}/insurance.${ext}`;
    
    const { error: uploadError } = await db.storage
      .from('insurance-docs')
      .upload(path, file, { upsert: true });
    
    if (uploadError) throw uploadError;
    
    const { data: { publicUrl } } = db.storage.from('insurance-docs').getPublicUrl(path);
    const url = publicUrl + '?t=' + Date.now();
    
    await db.from('profiles').update({ 
      insurance_doc_url: url, 
      has_insurance: true 
    }).eq('id', state.user.id);
    
    state.profile.insurance_doc_url = url;
    state.profile.has_insurance = true;
    
    if (status) status.textContent = 'Uploaded!';
    showToast('Insurance document uploaded!');
    render();
    
  } catch (e) {
    console.error('Insurance upload error:', e);
    if (status) status.textContent = 'Upload failed ‚Äî try again';
    showToast('Upload failed: ' + (e.message || 'Unknown error'));
  }
}

async function removeInsurance() {
  await db.from('profiles').update({ 
    insurance_doc_url: null, 
    has_insurance: false,
    insurance_expiry: null 
  }).eq('id', state.user.id);
  
  state.profile.insurance_doc_url = null;
  state.profile.has_insurance = false;
  state.profile.insurance_expiry = null;
  
  showToast('Insurance document removed');
  render();
}

async function editProfile() {
  await loadProfile();
  
  if (state.profile?.user_type === 'worker') {
    // Load current skills into selectedSkills
    const { data: mySkills } = await db.from('worker_skills').select('skill_id').eq('worker_id', state.user.id);
    state.selectedSkills = new Set((mySkills || []).map(s => s.skill_id));
  }
  
  // Load work/company photos for both types
  try {
    const { data: photos } = await db.from('work_photos').select('*').eq('worker_id', state.user.id).order('created_at');
    state.workPhotos = photos || [];
  } catch (e) { state.workPhotos = []; }
  
  state.profileStep = 1;
  state.currentScreen = 'profile-builder';
  render();
}

// ============================================
// DATA LOADING
// ============================================
async function loadSkills() {
  const { data } = await db.from('skills').select('*').order('sort_order');
  state.skills = data || [];
}

async function loadProfile() {
  const { data } = await db.from('profiles').select('*').eq('id', state.user.id).single();
  state.profile = data;
}

async function loadData() {
  try {
    // Load workers (with their skills)
    const { data: workers } = await db
      .from('profiles')
      .select('*, worker_skills(*)')
      .eq('user_type', 'worker')
      .order('rating_avg', { ascending: false });
    state.workers = workers || [];
  } catch (e) { console.error('Error loading workers:', e); state.workers = []; }
  
  try {
    // Load jobs (with business info and skills)
    const { data: jobs } = await db
      .from('jobs')
      .select('*, profiles!business_id(name, company_name), job_skills(*)')
      .eq('is_active', true)
      .order('created_at', { ascending: false });
    state.jobs = jobs || [];
  } catch (e) { console.error('Error loading jobs:', e); state.jobs = []; }
  
  try {
    // Load businesses
    const { data: businesses } = await db
      .from('profiles')
      .select('*')
      .eq('user_type', 'business')
      .order('biz_rating_avg', { ascending: false });
    state.businesses = businesses || [];
  } catch (e) { console.error('Error loading businesses:', e); state.businesses = []; }
  
  // Load worker's own job responses (for showing applied/hired status)
  if (state.profile?.user_type === 'worker') {
    try {
      const { data: myStatuses } = await db.from('job_responses')
        .select('*')
        .eq('worker_id', state.user.id);
      state.myJobStatuses = myStatuses || [];
    } catch(e) { state.myJobStatuses = []; }
  }
  
  try {
    // Load conversations
    await loadConversations();
  } catch (e) { console.error('Error loading conversations:', e); state.conversations = []; }
}

// ============================================
// INIT
// ============================================
async function init() {
  try {
    const { data: { session } } = await db.auth.getSession();
    
    if (session?.user) {
      state.user = session.user;
      await loadSkills();
      
      const { data: profile } = await db.from('profiles').select('*').eq('id', state.user.id).single();
      
      if (profile) {
        state.profile = profile;
        await loadData();
        state.activeTab = profile.user_type === 'business' ? 'search' : 'feed';
        state.currentScreen = 'main';
        
        // Subscribe to incoming messages globally
        db.channel('global_messages_' + state.user.id)
          .on('postgres_changes', {
            event: 'INSERT',
            schema: 'public',
            table: 'messages',
            filter: 'receiver_id=eq.' + state.user.id,
          }, (payload) => {
            // Refresh conversations if we're not in the chat with this person
            if (!state.chattingWith || state.chattingWith.conversationId !== payload.new.conversation_id) {
              loadConversations().then(() => render());
              showToast('New message received!');
            }
          })
          .subscribe();
      } else {
        await db.auth.signOut();
        state.currentScreen = 'splash';
      }
    } else {
      state.currentScreen = 'splash';
    }
  } catch (e) {
    console.error('Init error:', e);
    try { await db.auth.signOut(); } catch (_) {}
    state.currentScreen = 'splash';
  }
  
  render();
}

// Listen for auth changes
db.auth.onAuthStateChange((event, session) => {
  if (event === 'SIGNED_OUT') {
    state.user = null;
    state.profile = null;
    state.currentScreen = 'splash';
    render();
  }
});

// Start the app
init();

// ============================================
// PWA: Service Worker + Install Prompt
// ============================================
let deferredPrompt = null;

// Register service worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').then((reg) => {
    console.log('SW registered:', reg.scope);
  }).catch((err) => {
    console.log('SW registration failed:', err);
  });
}

// Capture the install prompt
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  // Show the install banner if user is logged in
  if (state.user) {
    showInstallBanner();
  }
});

// Check if already installed
window.addEventListener('appinstalled', () => {
  deferredPrompt = null;
  hideInstallBanner();
  showToast('CrewFinder installed!');
});

function showInstallBanner() {
  const banner = document.getElementById('install-banner');
  if (banner && !isAppInstalled()) {
    banner.classList.add('show');
  }
}

function hideInstallBanner() {
  const banner = document.getElementById('install-banner');
  if (banner) banner.classList.remove('show');
  // Remember dismissal
  try { localStorage.setItem('cf_install_dismissed', Date.now()); } catch(e) {}
}

async function handleInstallClick() {
  if (deferredPrompt) {
    // Android / Chrome install
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    deferredPrompt = null;
    hideInstallBanner();
    if (outcome === 'accepted') {
      showToast('Installing CrewFinder...');
    }
  } else {
    // iOS - show instructions
    showIOSInstallGuide();
  }
}

function showIOSInstallGuide() {
  const banner = document.getElementById('install-banner');
  if (banner) {
    banner.innerHTML = `
      <div style="text-align:center;padding:8px 0">
        <div style="font-weight:700;font-size:15px;margin-bottom:8px">Add to Home Screen</div>
        <div style="font-size:13px;color:var(--gray-600);line-height:1.6">
          1. Tap the <strong>Share</strong> button <span style="font-size:16px">‚¨ÜÔ∏è</span> at the bottom of your screen<br>
          2. Scroll down and tap <strong>"Add to Home Screen"</strong><br>
          3. Tap <strong>"Add"</strong> in the top right
        </div>
        <button class="btn btn-outline" style="margin-top:12px;font-size:13px" onclick="hideInstallBanner()">Got it</button>
      </div>
    `;
  }
}

function isAppInstalled() {
  // Check if running as installed PWA
  if (window.matchMedia('(display-mode: standalone)').matches) return true;
  if (window.navigator.standalone === true) return true;
  // Check if user recently dismissed
  try {
    const dismissed = localStorage.getItem('cf_install_dismissed');
    if (dismissed && Date.now() - parseInt(dismissed) < 86400000) return true; // 24 hours
  } catch(e) {}
  return false;
}

// Show install banner after first successful login if not installed
const originalRender = render;
render = function() {
  originalRender();
  // Show install banner on main screen if not installed
  if (state.currentScreen === 'main' && !isAppInstalled()) {
    setTimeout(() => {
      const banner = document.getElementById('install-banner');
      if (banner && !banner.classList.contains('show')) {
        // Show on Android if we have the prompt, or on iOS
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        if (deferredPrompt || isIOS) {
          showInstallBanner();
        }
      }
    }, 2000);
  }
};
</script>

<!-- Install Banner (outside #app so it persists) -->
<div class="install-banner" id="install-banner">
  <div class="install-banner-content">
    <div class="install-banner-icon">
      <svg width="24" height="24" viewBox="0 0 40 40" fill="none">
        <path d="M20 8L12 16h5v8h6v-8h5L20 8z" fill="#5CB85C"/>
        <path d="M14 28h12M16 32h8" stroke="#5CB85C" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </div>
    <div class="install-banner-text">
      <strong>Install CrewFinder</strong>
      <span>Add to your home screen for the full experience</span>
    </div>
  </div>
  <div class="install-banner-actions">
    <button class="btn btn-outline" style="flex:1" onclick="hideInstallBanner()">Not Now</button>
    <button class="btn btn-primary" style="flex:2" onclick="handleInstallClick()">Install</button>
  </div>
</div>

</body>
</html>
